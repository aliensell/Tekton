---
# Source: edp-tekton/templates/interceptor/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/resources/serviceaccount-tekton.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
# -- Define secrets which will be mounted to service account. This allow signed image while push to Harbor
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-triggers-sa-default
  namespace: default
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
---
# Source: edp-tekton/templates/interceptor/interceptor-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: tekton-edp-interceptor-certs #The krci interceptor relies on this name of the secret for populating certificates.
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
# The data is populated at install time by krci interceptor.
---
# Source: edp-tekton/templates/resources/cm-autotest-workspace.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: autotests-workspace-template
data:
  volumeclaimtemplate.yaml: |
    metadata:
      name: shared-workspace
    spec:
      accessModes:
        - ReadWriteOnce
      volumeMode: Filesystem
      resources:
        requests:
          storage: 5Gi
---
# Source: edp-tekton/templates/resources/cm-codenarc-settings.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-codenarc-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  init.gradle: |
    // Copyright 2022 EPAM Systems.
    //
    // Licensed under the Apache License, Version 2.0 (the "License");
    // you may not use this file except in compliance with the License.
    // You may obtain a copy of the License at
    // http://www.apache.org/licenses/LICENSE-2.0
    //
    // Unless required by applicable law or agreed to in writing, software
    // distributed under the License is distributed on an "AS IS" BASIS,
    // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    //
    // See the License for the specific language governing permissions and
    // limitations under the License.

    allprojects {
        buildscript {
            repositories {
                maven {
                    name "maven-group"
                    credentials {
                        username nexusLogin
                        password nexusPassword
                    }
                    url "${nexusMavenRepositoryUrl}"
                    allowInsecureProtocol = true
                }
            }
            dependencies {
                classpath "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:3.3"
            }
        }

        apply plugin: 'java'
        apply plugin: 'jacoco'
        apply plugin: 'maven-publish'

        afterEvaluate { project ->
            project.apply plugin: 'org.sonarqube'
        }
    }
---
# Source: edp-tekton/templates/resources/cm-gradle-settings.yaml
# Default configuration map for provisioning Gradle init.gradle file.
# To change it, prepare another configuration map and update "tekton.configs.gradleConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-gradle-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  SNAPSHOTS_REPO_PATH: "/repository/krci-maven-snapshots"
  RELEASES_REPO_PATH: "/repository/krci-maven-releases"
  init.gradle: |
    // Copyright 2024 EPAM Systems.
    //
    // Licensed under the Apache License, Version 2.0 (the "License");
    // you may not use this file except in compliance with the License.
    // You may obtain a copy of the License at
    // http://www.apache.org/licenses/LICENSE-2.0
    //
    // Unless required by applicable law or agreed to in writing, software
    // distributed under the License is distributed on an "AS IS" BASIS,
    // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    //
    // See the License for the specific language governing permissions and
    // limitations under the License.

    allprojects {
        buildscript {
            repositories {
                maven {
                    name "nexus"
                    credentials {
                        username = System.getenv("CI_USERNAME")
                        password = System.getenv("CI_PASSWORD")
                    }
                    url = System.getenv("NEXUS_HOST_URL") + "/repository/krci-maven-group"
                    allowInsecureProtocol = true
                }
            }
            dependencies {
                classpath "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:3.3"
            }
        }

        repositories {
            maven {
                name "nexus"
                credentials {
                    username = System.getenv("CI_USERNAME")
                    password = System.getenv("CI_PASSWORD")
                }
                url = System.getenv("NEXUS_HOST_URL") + "/repository/krci-maven-group"
                allowInsecureProtocol = true
            }
            maven {
                name "gitlab-registry"
                url = "https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven"
                credentials(HttpHeaderCredentials) {
                    name = System.getenv("CI_GITLAB_TOKEN_TYPE")
                    value = System.getenv("CI_GITLAB_TOKEN")
                }
                authentication {
                    header(HttpHeaderAuthentication)
                }
            }
            maven {
                name "github-registry"
                url = "https://maven.pkg.github.com/OWNER/REPOSITORY"
                credentials {
                    username = System.getenv("CI_GITHUB_USERNAME")
                    password = System.getenv("CI_GITHUB_PASSWORD")
                }
            }
            maven {
                name "azure-devops-registry"
                url 'https://pkgs.dev.azure.com'
                credentials {
                    username = System.getenv("CI_AZURE_DEVOPS_USERNAME")
                    password = System.getenv("CI_AZURE_DEVOPS_PASSWORD")
                }
            }
        }

        apply plugin: 'java'
        apply plugin: 'jacoco'
        apply plugin: 'maven-publish'

        afterEvaluate { project ->
            project.apply plugin: 'org.sonarqube'
        }
    }
---
# Source: edp-tekton/templates/resources/cm-maven-settings.yaml
# Default configuration map for provisioning Maven settings.xml file.
# To change it, prepare another configuration map and update "tekton.configs.mavenConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-maven-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  settings.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <!--Copyright 2024 EPAM Systems.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License. -->
    <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
        <localRepository>/workspace/source/cache</localRepository>

        <pluginGroups>
            <pluginGroup>org.sonarsource.scanner.maven</pluginGroup>
        </pluginGroups>
        <servers>
            <!-- The "nexus" server is defined to provide credentials required by the mirror. -->
            <server>
                <id>nexus</id>
                <username>${env.CI_USERNAME}</username>
                <password>${env.CI_PASSWORD}</password>
            </server>
            <!-- The "gitlab-registry" server is defined to provide credentials required by the GitLab registry.
            A token is used for authentication which is passed in HTTP headers.
            More documentation: https://docs.gitlab.com/ee/user/packages/maven_repository/ -->
            <server>
                <id>gitlab-registry</id>
                <configuration>
                    <httpHeaders>
                        <property>
                            <name>${env.CI_GITLAB_TOKEN_TYPE}</name>
                            <value>${env.CI_GITLAB_TOKEN}</value>
                        </property>
                    </httpHeaders>
                </configuration>
            </server>
            <!-- The "github-registry" server is defined to provide credentials required by the GitHub registry.
            Username and password are used for authentication.
            More documentation: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-apache-maven-registry -->
            <server>
                <id>github-registry</id>
                <username>${env.CI_GITHUB_USERNAME}</username>
                <password>${env.CI_GITHUB_PASSWORD}</password>
            </server>
            <!-- The "azure-devops-registry" server is defined to provide credentials required by the Azure DevOps registry.
            Username and password are used for authentication.
            More documentation: https://learn.microsoft.com/en-us/azure/devops/artifacts/get-started-maven?view=azure-devops -->
            <server>
                <id>azure-devops-registry</id>
                <username>${env.CI_AZURE_DEVOPS_USERNAME}</username>
                <password>${env.CI_AZURE_DEVOPS_PASSWORD}</password>
            </server>
        </servers>

        <mirrors>
            <mirror>
                <!--This sends everything else to /public -->
                <id>nexus</id>
                <mirrorOf>*</mirrorOf>
                <url>http://nexus.nexus:8081/repository/krci-maven-group</url>
            </mirror>
        </mirrors>

        <profiles>
            <profile>
                <id>sonar</id>
                <activation>
                     <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                    <sonar.login>
                        ${env.SONAR_TOKEN}
                    </sonar.login>
                    <sonar.host.url>
                        ${env.SONAR_HOST_URL}
                    </sonar.host.url>
                </properties>
            </profile>
            <!-- Nexus profile for managing artifacts within Nexus repository. -->
            <profile>
                <id>nexus</id>
                <properties>
                    <altSnapshotDeploymentRepository>nexus::http://nexus.nexus:8081/repository/krci-maven-snapshots</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>nexus::http://nexus.nexus:8081/repository/krci-maven-releases</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- GitLab registry profile for managing artifacts within GitLab. -->
            <profile>
                <id>gitlab-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>gitlab-registry::https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>gitlab-registry::https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/maven</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- GitHub registry profile for managing artifacts within GitHub. -->
            <profile>
                <id>github-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>github-registry::https://maven.pkg.github.com/OWNER/REPOSITORY</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>github-registry::https://maven.pkg.github.com/OWNER/REPOSITORY</altReleaseDeploymentRepository>
                </properties>
            </profile>
            <!-- Azure DevOps registry profile for managing artifacts within Azure DevOps. -->
            <profile>
                <id>azure-devops-registry</id>
                <properties>
                    <altSnapshotDeploymentRepository>azure-devops-registry::https://pkgs.dev.azure.com</altSnapshotDeploymentRepository>
                    <altReleaseDeploymentRepository>azure-devops-registry::https://pkgs.dev.azure.com</altReleaseDeploymentRepository>
                </properties>
            </profile>
        </profiles>
        <!-- Specify the active profile here. If you want to push packages to nexus (default), gitlab registry, github registry,
        or Azure DevOps registry, change the activeProfile id to the required profile id. -->
        <activeProfiles>
            <activeProfile>nexus</activeProfile>
        </activeProfiles>
    </settings>
---
# Source: edp-tekton/templates/resources/cm-npm-settings.yaml
# Default configuration maps for provisioning NPM .npmrc files.
# To change it, prepare another configuration map and update "tekton.configs.npmConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-npm-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  .npmrc-ci: |
    registry=${NEXUS_HOST_URL}/repository/krci-npm-group
    ${NEXUS_HOST}/repository/:email=ci.user@krci.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  .npmrc-publish-snapshots: |
    registry=${NEXUS_HOST_URL}/repository/krci-npm-snapshots
    ${NEXUS_HOST}/repository/:email=ci.user@krci.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  .npmrc-publish-releases: |
    registry=${NEXUS_HOST_URL}/repository/krci-npm-releases
    ${NEXUS_HOST}/repository/:email=ci.user@krci.com
    ${NEXUS_HOST}/repository/:_auth=${upBase64}
    cache=${NPM_CACHE_DIR}

  # Example of how to push changes when using Node.js version 18.10.0 with the node:18.10-alpine3.16 image
  # .npmrc-ci: |
  #   registry=${NEXUS_HOST_URL}/repository/krci-npm-group
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # .npmrc-publish-snapshots: |
  #   registry=${NEXUS_HOST_URL}/repository/krci-npm-snapshots
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # .npmrc-publish-releases: |
  #   registry=${NEXUS_HOST_URL}/repository/krci-npm-releases
  #   _auth=${upBase64}
  #   cache=${NPM_CACHE_DIR}

  # Example for pushing a snapshot package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/npm_registry/
  #.npmrc-publish-snapshots: |
  #  registry=https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/npm
  #  _authToken=${CI_GITLAB_TOKEN}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a release package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/npm_registry/
  #.npmrc-publish-releases: |
  #  registry=https://gitlab.example.com/api/v4/projects/PROJECT_ID/packages/npm
  #  _authToken=${CI_GITLAB_TOKEN}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a snapshot package to GitHub
  # Ref: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry
  #.npmrc-publish-snapshots: |
  #  registry=https://npm.pkg.github.com
  #  _authToken=${CI_GITHUB_PASSWORD}
  #  cache=${NPM_CACHE_DIR}

  # Example for pushing a release package to GitHub
  # Ref: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-npm-registry
  #.npmrc-publish-releases: |
  #  registry=https://npm.pkg.github.com
  #  _authToken=${CI_GITHUB_PASSWORD}
  #  cache=${NPM_CACHE_DIR}
---
# Source: edp-tekton/templates/resources/cm-nuget-settings.yaml
# Default configuration maps for provisioning nuget.config file.
# To change it, prepare another configuration map and update "tekton.configs.nugetConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-nuget-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  nuget.config: |
    <?xml version="1.0" encoding="utf-8"?>
    <configuration>
        <packageSources>
            <add key="nugetStorageSnapshots" value="%NEXUS_HOST_URL%/repository/krci-dotnet-snapshots" />
            <add key="nugetStorageReleases" value="%NEXUS_HOST_URL%/repository/krci-dotnet-releases" />
        </packageSources>
        <packageSourceCredentials>
            <nugetStorageSnapshots>
                <add key="Username" value="%CI_USERNAME%" />
                <add key="ClearTextPassword" value="%CI_PASSWORD%" />
            </nugetStorageSnapshots>
            <nugetStorageReleases>
                <add key="Username" value="%CI_USERNAME%" />
                <add key="ClearTextPassword" value="%CI_PASSWORD%" />
            </nugetStorageReleases>
        </packageSourceCredentials>
    </configuration>
---
# Source: edp-tekton/templates/resources/cm-python-settings.yaml
# Default configuration maps for provisioning PIP_TRUSTED_HOST, PIP_INDEX, PIP_INDEX_URL,
# REPOSITORY_URL_SNAPSHOTS and REPOSITORY_URL_RELEASES environment variables for Python tasks.
# To change it, prepare another configuration map and update "tekton.configs.pythonConfigMap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-python-settings
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  # Private repo index path PIP searches through. It is used by 'pip search' command.
  # e.g. '/repository/krci-python-group/pypi'
  PIP_INDEX_PATH: "/repository/krci-python-group/pypi"

  # Repo index path from wich PIP downloads private packages and public packages via proxy.
  # PIP_INDEX_URL can have only one URL while PIP_EXTRA_INDEX_URL can hold
  # multiple URLs if passed with spaces. It is used by 'pip install' command.
  # To access index via web, add slash at the end of 'simple/'.
  # e.g. '/repository/krci-python-group/simple'
  PIP_INDEX_URL_PATH: "/repository/krci-python-group/simple"

  # Path for the snapshots repository in artifact storage.
  REPOSITORY_SNAPSHOTS_PATH: "/repository/krci-python-snapshots/"

  # Path for the releases repository in artifact storage
  REPOSITORY_RELEASES_PATH: "/repository/krci-python-releases/"

  # Example for pushing a snapshot and a release packages package to GitLab
  # Ref: https://docs.gitlab.com/ee/user/packages/pypi_repository/
  #PIP_INDEX_URL_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/simple"
  #REPOSITORY_SNAPSHOTS_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/"
  #REPOSITORY_RELEASES_PATH: "/api/v4/projects/PROJECT_ID/packages/pypi/"

  # Example for pushing a snapshot and a release packages to Azure Devops Artifacts
  # Ref: https://learn.microsoft.com/en-us/azure/devops/artifacts/quickstarts/python-packages?view=azure-devops
  #PIP_INDEX_URL_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/simple"
  #REPOSITORY_SNAPSHOTS_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/upload"
  #REPOSITORY_RELEASES_PATH: "/<ORGANIZATION_NAME>/<PROJECT_NAME>/_packaging/<FEED_NAME>/pypi/upload"
---
# Source: edp-tekton/templates/resources/cm-tekton-cache.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tekton-cache
data:
  url: http://tekton-cache:8080
---
# Source: edp-tekton/templates/resources/ct-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ct-config
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  ct.yaml: |
    validate-maintainers: false
  chart_schema.yaml:
    |
      name: str()
      home: str()
      version: str()
      type: str()
      apiVersion: str()
      appVersion: any(str(), num())
      description: str()
      keywords: list(str(), required=False)
      sources: list(str(), required=True)
      maintainers: list(include('maintainer'), required=True)
      dependencies: list(include('dependency'), required=False)
      icon: str(required=False)
      engine: str(required=False)
      condition: str(required=False)
      tags: str(required=False)
      deprecated: bool(required=False)
      kubeVersion: str(required=False)
      annotations: map(str(), str(), required=False)
      ---
      maintainer:
        name: str(required=True)
        email: str(required=False)
        url: str(required=False)
      ---
      dependency:
        name: str()
        version: str()
        repository: str()
        condition: str(required=False)
        tags: list(str(), required=False)
        enabled: bool(required=False)
        import-values: any(list(str()), list(include('import-value')), required=False)
        alias: str(required=False)
  lintconf.yaml:
    |
      ---
      rules:
        braces:
          min-spaces-inside: 0
          max-spaces-inside: 0
          min-spaces-inside-empty: -1
          max-spaces-inside-empty: -1
        brackets:
          min-spaces-inside: 0
          max-spaces-inside: 0
          min-spaces-inside-empty: -1
          max-spaces-inside-empty: -1
        colons:
          max-spaces-before: 0
          max-spaces-after: 1
        commas:
          max-spaces-before: 0
          min-spaces-after: 1
          max-spaces-after: 1
        comments:
          require-starting-space: true
          min-spaces-from-content: 2
        document-end: disable
        document-start: disable           # No --- to start a file
        empty-lines:
          max: 2
          max-start: 0
          max-end: 0
        hyphens:
          max-spaces-after: 1
        indentation:
          spaces: consistent
          indent-sequences: whatever      # - list indentation will handle both indentation and without
          check-multi-line-strings: false
        key-duplicates: enable
        line-length: disable              # Lines can be any length
        new-line-at-end-of-file: enable
        new-lines:
          type: unix
        trailing-spaces: enable
        truthy:
          level: warning
---
# Source: edp-tekton/templates/resources/pruner/configmap.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: tekton-resource-pruner-scripts
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
data:
  tekton-prune.sh: |
    #!/usr/bin/env bash
  
    set -o errtrace
    trap 'echo "error occurred on line ${LINENO}"; exit 1' ERR
  
    verify() {
      echo 'Verify that kubectl is installed'
      if ! command -v kubectl &> /dev/null; then
        echo "kubectl could not be found"
        exit 1
      fi
      echo 'Ok'
      echo 'Verify that namespace variables are defined'
      if test -z "${NAMESPACE}"; then
        echo 'NAMESPACE env variable not defined.'
        exit 1
      fi
      echo 'Ok'
    }
  
    get_pipelinerun_to_file() {
      pods_file_path="$1"
      kubectl get -n "${NAMESPACE}" pipelinerun -o name > "${pods_file_path}"
    }
  
  
    get_active_pipelineruns() {
      kubectl get -n "${NAMESPACE}" pipelineruns \
        -o jsonpath='{.items[?(@.status.conditions[0].reason=="Running")].metadata.name}'
    }
  
  
    delete_lines_from_file() {
      file="$1"
      lines_to_delete="$2"
      for line in ${lines_to_delete[@]}; do
        sed -i "/${line}/d" "${file}"
      done
    }
  
    prune_resources() {
      resources_to_delete_file_path="$1"
      type="$2"
      resource_list=''
      while IFS= read -r line || [[ -n "${line}" ]]; do
        if ! test -z "${line}"; then resource_list="${resource_list} ${type}${line}"; fi
      done < "$resources_to_delete_file_path"
      if test -z "${resource_list// }"; then
        echo 'No resources to delete'
      else
        kubectl delete -n "${NAMESPACE}" ${resource_list} --force --grace-period=0;
      fi
    }
  
    main() {
      separator=';'
      pvc_owner_kind='PipelineRun'
      pipelinerun_to_delete_file_path='/tmp/runs-to-delete.txt'
  
      verify
  
      echo 'Get active pipelineruns'
      active_pipelineruns=$(get_active_pipelineruns)
      echo "Running pipelineruns: $active_pipelineruns"
  
      echo "Get pipelinerun list"
      get_pipelinerun_to_file "${pipelinerun_to_delete_file_path}"
      cat "${pipelinerun_to_delete_file_path}"
  
      echo 'Exclude running pipelineruns from deletion list':
      delete_lines_from_file "${pipelinerun_to_delete_file_path}" "${active_pipelineruns}"
      cat "${pipelinerun_to_delete_file_path}"
  
      echo 'Delete pipelineruns'
      prune_resources "${pipelinerun_to_delete_file_path}" ''
      echo 'Ok'
  
    }
  
    main
---
# Source: edp-tekton/charts/tekton-cache/templates/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cache
  labels:
    helm.sh/chart: tekton-cache-0.4.2
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: test-pipelines
    app.kubernetes.io/version: "0.4.2"
    app.kubernetes.io/managed-by: Helm
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tekton-triggers-eventlistener-clusterbinding-default
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-sa-default
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-clusterroles
---
# Source: edp-tekton/templates/interceptor/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
rules:
  - verbs:
      - get
      - list
      - watch
      - update
    apiGroups:
      - triggers.tekton.dev
    resources:
      - interceptors

  - verbs:
      - get
      - list
      - watch
      - update
      - create
    apiGroups:
      - ''
    resources:
      - secrets
    resourceNames:
      - tekton-edp-interceptor-certs

  - verbs:
      - get
    apiGroups:
      - ''
    resources:
      - secrets

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebases
      - codebases/status
      - codebases/finalizers

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebasebranches
      - codebasebranches/status
      - codebasebranches/finalizers

  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - gitservers
      - gitservers/status
      - gitservers/finalizers
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
rules:
  - apiGroups:
      - tekton.dev
    verbs:
      - get
      - list
      - delete
    resources:
      - pipelineruns
  - apiGroups:
      - ''
    verbs:
      - get
    resources:
      - ConfigMap
    resourceNames:
      - tekton-resource-pruner-scripts
---
# Source: edp-tekton/templates/resources/role-tekton-autotest.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: tekton-autotests-role
rules:
  - verbs:
      - create
      - get
      - list
      - watch
      - patch
      - update
    apiGroups:
      - tekton.dev
    resources:
      - pipelines
      - pipelineruns
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - v2.edp.epam.com
    resources:
      - codebases
      - gitservers
      - stages
  - verbs:
      - list
      - get
    apiGroups:
      - argoproj.io
    resources:
      - applications
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - ""
    resources:
      - secrets
---
# Source: edp-tekton/templates/resources/role-tekton.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: tekton-pipeline-role
rules:
  # allow to get configs for KRCI from configmap
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch

  # baseline operations with codebase and cbis
  - apiGroups:
      - 'v2.edp.epam.com'
    resources:
      - cdpipelines
      - codebasebranches
      - codebasebranches/status
      - codebaseimagestreams
      - codebases
      - stages
    verbs:
      - get
      - update
      - patch
      - list

  # we need to create jira issues
  - apiGroups:
      - 'v2.edp.epam.com'
    resources:
      - jiraissuemetadatas
    verbs:
      - create
      - get

  # we need to get information about the taskRun running in ns containers
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - tekton.dev
    resources:
      - taskruns

  # we need to manage Argo ApplicationSet (except create, delete)
  - verbs:
      - get
      - list
      - watch
      - update
      - patch
    apiGroups:
      - argoproj.io
    resources:
      - applicationsets
---
# Source: edp-tekton/templates/interceptor/rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-interceptor
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-triggers-edp-interceptor
---
# Source: edp-tekton/templates/resources/pruner/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-resource-pruner
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-resource-pruner
---
# Source: edp-tekton/templates/resources/rolebinding-tekton-autotest.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: tekton-autotests-rolebinding
subjects:
  - kind: ServiceAccount
    name: tekton
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-autotests-role
---
# Source: edp-tekton/templates/resources/rolebinding-tekton.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: tekton-pipeline-role
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tekton-pipeline-role
subjects:
  - kind: ServiceAccount
    name: tekton
    namespace: default
---
# Source: edp-tekton/templates/triggers/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-triggers-eventlistener-binding-default
  namespace: default
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-sa-default
    namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-roles
---
# Source: edp-tekton/charts/tekton-cache/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: tekton-cache
  labels:
    helm.sh/chart: tekton-cache-0.4.2
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: test-pipelines
    app.kubernetes.io/version: "0.4.2"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: test-pipelines
---
# Source: edp-tekton/templates/interceptor/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: tekton-triggers-edp-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8443
      targetPort: https
      protocol: TCP
      name: https
  selector:
    app.kubernetes.io/name: tekton-interceptor
    app.kubernetes.io/instance: test-pipelines
---
# Source: edp-tekton/charts/tekton-cache/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tekton-cache
  labels:
    helm.sh/chart: tekton-cache-0.4.2
    app.kubernetes.io/name: tekton-cache
    app.kubernetes.io/instance: test-pipelines
    app.kubernetes.io/version: "0.4.2"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: tekton-cache
      app.kubernetes.io/instance: test-pipelines
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tekton-cache
        app.kubernetes.io/instance: test-pipelines
    spec:
      volumes:
        - name: cache
          persistentVolumeClaim:
            claimName: cache
      securityContext:
        {}
      initContainers:
        - name: fix-permissions
          image: busybox:1.36.1
          command:
            - chown
            - '-R'
            - '1001:1001'
            - /uploads
          resources: {}
          volumeMounts:
            - name: cache
              mountPath: /uploads
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: Always
          securityContext:
            privileged: true
            runAsUser: 0
      containers:
        - name: tekton-cache
          volumeMounts:
            - mountPath: "/uploads"
              name: cache
          securityContext:
            {}
          image: "ghcr.io/kuberocketci/krci-cache:0.1.1"
          imagePullPolicy: IfNotPresent
          env:
            - name: UPLOADER_HOST
              value: "0.0.0.0"
            - name: UPLOADER_PORT
              value: "8080"
            - name: UPLOADER_DIRECTORY
              value: "/uploads"
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            {}
---
# Source: edp-tekton/templates/interceptor/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tekton-interceptor
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tekton-interceptor
      app.kubernetes.io/instance: test-pipelines
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tekton-interceptor
        app.kubernetes.io/instance: test-pipelines
    spec:
      serviceAccountName: tekton-interceptor
      securityContext:
        {}
      containers:
        - command:
          - /edpinterceptor
          args:
            - '-logtostderr'
            - '-stderrthreshold'
            - INFO
          env:
            - name: SYSTEM_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CONFIG_LOGGING_NAME
              value: config-logging-triggers
            - name: CONFIG_OBSERVABILITY_NAME
              value: config-observability-triggers
            - name: METRICS_DOMAIN
              value: tekton.dev/triggers
            - name: INTERCEPTOR_NAME
              value: edp
          name: tekton-triggers-edp-interceptor
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsGroup: 65532
            runAsNonRoot: true
            runAsUser: 65532
          image: "epamedp/edp-tekton:0.19.0-SNAPSHOT"
          imagePullPolicy: IfNotPresent
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ready
              port: 8443
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          resources:
            limits:
              cpu: 70m
              memory: 60Mi
            requests:
              cpu: 50m
              memory: 40Mi
---
# Source: edp-tekton/templates/resources/pruner/cron-job.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: tekton-resource-pruner
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  schedule: "0 10 */1 * *"
  suspend: false
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          volumes:
            - name: scripts
              configMap:
                name: tekton-resource-pruner-scripts
          containers:
            - name: kubectl
              image: "docker.io/bitnamilegacy/kubectl:1.25.4"
              env:
                - name: NAMESPACE
                  valueFrom:
                    fieldRef:
                      apiVersion: v1
                      fieldPath: metadata.namespace
              command:
                - bash
                - /scripts/tekton-prune.sh
              volumeMounts: [{name: scripts, mountPath: /scripts}]
              resources:
                limits:
                  cpu: 100m
                  memory: 70Mi
                requests:
                  cpu: 50m
                  memory: 50Mi
          restartPolicy: OnFailure
          serviceAccountName: tekton-resource-pruner
          serviceAccount: tekton-resource-pruner
      ttlSecondsAfterFinished: 10
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
---
# Source: edp-tekton/templates/interceptor/interceptor.yaml
apiVersion: triggers.tekton.dev/v1alpha1
kind: Interceptor
metadata:
  name: edp
  labels:
    server/type: https
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  clientConfig:
    service:
      name: tekton-triggers-edp-interceptor
      namespace: default
      port: 8443
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 automation tests with Gradle (default version)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-aut-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 automation tests with Gradle (default version)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-gradle'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 automation tests with Gradle (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-aut-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 automation tests with Gradle (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - sonar
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-aut-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 automation tests with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-aut-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 automation tests with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 automation tests with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
  

  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-aut-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 automation tests with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - update-build-number
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
  

  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 automation tests with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds  
          

  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-aut-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 automation tests with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - get-version
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - get-version
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds  
          

  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-aut-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 automation tests with Maven"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - init-values
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-aut-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 automation tests with Maven"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - init-values
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/autotests/run-autotests.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-run-autotests
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/triggertemplate: gitlab-run-autotests
    app.edp.epam.com/pipelinetype: tests
spec:
  description: >-
    Pipeline for running autotests from gitlab Git provider repositories.
    This pipeline clones the autotests repository from gitlab and executes the specified Makefile target.
    It supports custom base images and configurable Makefile targets for flexible test execution.
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: git-source-url
      default: "https://github.com/SergK/autotests.git"
      description: "URL of the repository containing the autotests to run."
    - name: git-source-revision
      default: "main"
      description: "Branch or commit SHA to checkout from the autotests repository."
    - name: makefile-target
      default: "dev"
      description: "Makefile target to execute for running autotests."
    - name: base-image
      default: "maven:3.9.9-eclipse-temurin-21"
      description: "Docker image that must include all required tools for running autotests and the 'make' command."
  tasks:
    - name: fetch-repository
      taskRef:
          kind: Task
          name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: run-autotests
      taskRef:
        kind: Task
        name: run-autotests
      runAfter:
        - fetch-repository
      params:
        - name: makefile-target
          value: "$(params.makefile-target)"
        - name: base-image
          value: "$(params.base-image)"
      workspaces:
        - name: source
          workspace: shared-workspace
---
# Source: edp-tekton/templates/pipelines/c/cmake/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-cmake-none-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building C/C++ application with CMake (default version)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            mkdir -p build && cd build
    
            cmake ..
    
            cmake --build .
        - name: EXTRA_COMMANDS_TEST
          value: |
            cd build
    
            cmake ..
    
            ctest
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/c/cmake/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-cmake-none-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building C/C++ application with CMake (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            mkdir -p build && cd build
    
            cmake ..
    
            cmake --build .
        - name: EXTRA_COMMANDS_TEST
          value: |
            cd build
    
            cmake ..
    
            ctest
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/c/cmake/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-cmake-none-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building C/C++ with CMake"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            mkdir -p build && cd build
    
            cmake ..
    
            cmake --build .
        - name: EXTRA_COMMANDS_TEST
          value: |
            cd build
    
            cmake ..
    
            ctest
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/c/make/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-make-none-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building C/C++ application with Make (default version)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            make build
        - name: EXTRA_COMMANDS_TEST
          value: |
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/c/make/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-make-none-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building C/C++ application with Make (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            make build
        - name: EXTRA_COMMANDS_TEST
          value: |
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/c/make/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-make-none-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building C/C++ with Make"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/c-make-none"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "make-c"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'docker.io/epamedp/tekton-python-make:0.1.7'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: build
      taskRef:
        kind: Task
        name: edp-c
      runAfter:
        - fetch-repository
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS_BUILD
          value: |
            make build
        - name: EXTRA_COMMANDS_TEST
          value: |
            make test
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/cd-autotests/autotest.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: autotests-maven
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The pipeline for running maven in CD pipeline"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/SergK/autotests.git"
    - name: git-source-revision
      default: "master"
    - name: stage-name
      default: "dev"
    - name: cd-pipeline-name
      default: "dev"
    - name: base-image
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
          kind: Task
          name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: run-autotests
      taskRef:
        kind: Task
        name: run-autotests-maven
      runAfter:
        - fetch-repository
      params:
        - name: base-image
          value: "$(params.base-image)"
        - name: cd-pipeline-name
          value: "$(params.cd-pipeline-name)"
        - name: stage-name
          value: "$(params.stage-name)"
      workspaces:
        - name: source
          workspace: shared-workspace
---
# Source: edp-tekton/templates/pipelines/cd-autotests/autotest.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: autotests-gradle
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The pipeline for running gradle in CD pipeline"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/SergK/autotests.git"
    - name: git-source-revision
      default: "master"
    - name: stage-name
      default: "dev"
    - name: cd-pipeline-name
      default: "dev"
    - name: base-image
      default: ""
  tasks:
    - name: fetch-repository
      taskRef:
          kind: Task
          name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: run-autotests
      taskRef:
        kind: Task
        name: run-autotests-gradle
      runAfter:
        - fetch-repository
      params:
        - name: base-image
          value: "$(params.base-image)"
        - name: cd-pipeline-name
          value: "$(params.cd-pipeline-name)"
        - name: stage-name
          value: "$(params.stage-name)"
      workspaces:
        - name: source
          workspace: shared-workspace
---
# Source: edp-tekton/templates/pipelines/cd/clean.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: clean
  labels:
    app.edp.epam.com/pipelinetype: clean
    app.edp.epam.com/triggertemplate: clean
spec:
  description: |
    This Pipeline is used to delete Argo CD application.
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  tasks:
    - name: pre-clean
      taskRef:
        kind: Task
        name: run-clean-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: clean
      taskRef:
        kind: Task
        name: clean
      runAfter:
        - pre-clean
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)

    - name: post-clean
      taskRef:
        kind: Task
        name: run-clean-gate
      runAfter:
        - clean
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"
---
# Source: edp-tekton/templates/pipelines/cd/deploy-ansible-awx.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-ansible-awx
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy-ansible-awx
spec:
  description: |
    This Pipeline is designed for deploying RPM packages
    to target servers (environments) using tower-cli tool. It automates
    the deployment process by invoking Ansible AWX through the command line,
    ensuring a streamlined and consistent installation of RPM packages across
    the specified environment.
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-ansible-awx
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - post-deploy
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy-ansible.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-ansible
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy-ansible
spec:
  description: |
    This Pipeline is responsible for deploying rpm packages to the target Stage (Environment).
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-ansible
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - post-deploy
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy-diff-approve.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-diff-approve
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy-diff-approve
spec:
  description: |
    This Pipeline is used to deploy applications to the target Environment.
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: preview-changes
      taskRef:
        kind: Task
        name: sync-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: approve
      params:
        - name: description
          value: Deploy application?
      runAfter:
        - preview-changes
      taskRef:
        apiVersion: edp.epam.com/v1alpha1
        kind: ApprovalTask
        name: approve

    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - approve
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - post-deploy
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy-with-approve.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-with-promote-approval
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy-with-approve
spec:
  description: |
    This Pipeline is used to deploy applications to the target Environment. Approval is required to promote the applications to the next Env.

  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: approve
      params:
        - name: description
          value: Promote versions to the next Environment?
      runAfter:
        - deploy-app
      taskRef:
        apiVersion: edp.epam.com/v1alpha1
        kind: ApprovalTask
        name: approve

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - approve
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy-with-autotests.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy-with-autotests
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy-with-autotests
spec:
  description: |
    This Pipeline is used to deploy applications to the target Environment.
  workspaces:
    - name: shared-workspace
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
    - name: autotes-pipeline
      default: "autotes-pipeline"
    - name: codebase_tags
      default: "codebase_tags"
    - name: parent-pipeline-name
      default: $(context.pipelineRun.name)
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: init-autotests
      taskRef:
          kind: Task
          name: init-autotests
      runAfter:
        - post-deploy
      params:
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: AUTOTEST_PIPELINES
          value: $(params.autotes-pipeline)
        - name: codebase_tags
          value: $(params.codebase_tags)
        - name: parent-pipeline-name
          value: $(params.parent-pipeline-name)
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: wait-for-autotests
      taskRef:
          kind: Task
          name: wait-for-autotests
      runAfter:
        - init-autotests
      params:
        - name: AUTOTEST_PIPELINES
          value: $(params.autotes-pipeline)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - wait-for-autotests
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/cd/deploy.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: deploy
  labels:
    app.edp.epam.com/pipelinetype: deploy
    app.edp.epam.com/triggertemplate: deploy
spec:
  description: |
    This Pipeline is used to deploy applications to the target Stage (Environment).
  params:
    - name: pipelineUrl
      description: |
        URL of the pipeline run in Tekton Dashboard.
      type: string
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
      type: string
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
      value: $(tasks.deploy-app.results.APPLICATIONS_PAYLOAD)
  tasks:
    - name: pre-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: deploy-app
      taskRef:
        kind: Task
        name: deploy-applicationset-cli
      runAfter:
        - pre-deploy
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)

    - name: post-deploy
      taskRef:
        kind: Task
        name: run-quality-gate
      runAfter:
        - deploy-app
      params:
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: KUBECONFIG_SECRET_NAME
          value: $(params.KUBECONFIG_SECRET_NAME)
        - name: BASE_IMAGE
          value: "docker.io/bitnamilegacy/kubectl:1.25.4"
        - name: EXTRA_COMMANDS
          value:
            echo "Hello World"

    - name: promote-images
      taskRef:
        kind: Task
        name: promote-images
      runAfter:
        - post-deploy
      params:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: ENVIRONMENT
          value: $(params.CDSTAGE)
        - name: DEPLOYMENT_FLOW
          value: $(params.CDPIPELINE)
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Docker application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)


    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Docker application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'docker-kaniko'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)


    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - dockerfile-lint
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/docker/kaniko/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-kaniko-docker-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Docker with Kaniko"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
      workspaces:
        - name: output
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/gitops/gitlab-build.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-gitops-sys-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: The Build pipeline for linting and validating manifests in the GitOps system repository
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "main"
      type: string
    - name: CODEBASE_NAME
      default: krci-gitops
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: yaml-lint
      runAfter:
        - init-values
      taskRef:
        kind: Task
        name: yaml-lint
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

  finally:

    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/gitops/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-gitops-sys-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: The Review pipeline for linting and validating manifests in the GitOps system repository
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "main"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: krci-gitops
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: yaml-lint
      runAfter:
        - init-values
      taskRef:
        kind: Task
        name: yaml-lint
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building beego application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building gin application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building operator-sdk application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building beego application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building gin application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building operator-sdk application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - sonar
        - get-version
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-beego-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building beego"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-beego"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "beego-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-gin-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building gin"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-gin"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "gin-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/go/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-go-operator-sdk-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building operator-sdk"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/go-go-operator-sdk"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: "operator-sdk-go"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: image
      default: 'docker.io/golang:1.24-bookworm'
      description: "go image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    # we don't need subPath for the source workspace, since we need to have access to both folders
    # /source and /cache
    - name: build
      taskRef:
        kind: Task
        name: golang
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory
            cd source
            make build
            make test
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - build
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Groovy library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Groovy library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/groovy/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-codenarc-codenarc-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Groovy"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/groovy-pipeline-codenarc-codenarc"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'groovy-pipeline'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: build
      taskRef:
        kind: Task
        name: codenarc
      runAfter:
        - init-values
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            build -x test -x compileGroovy
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -PnexusMavenRepositoryUrl=${NEXUS_HOST_URL}/repository/krci-maven-group \
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            -x compileGroovy \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm-pipelines library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - fetch-repository
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm-pipelines library (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
      
      
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-template
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm-pipelines/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-pipeline-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Helm-pipelines"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "."
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-helm-default
      runAfter:
        - init-values
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.VCS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-helm-chart
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push
      runAfter:
        - helm-template
      params:
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds

    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Helm library (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/container-kaniko-docker"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - get-version
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-push
      taskRef:
        kind: Task
        name: helm-push-lib
      runAfter:
        - helm-template
      params:
        - name: chart-dir
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - helm-push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-charts-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Helm"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "charts"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: targetBranch
      description: "Target branch of Merge Request"
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check Chart version increment"
      default: 'true'
      type: string
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-library-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: fetch-target-branch
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - fetch-repository
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git fetch --unshallow
            git fetch origin $(params.targetBranch):refs/remotes/origin/$(params.targetBranch)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-library-lint
      runAfter:
        - fetch-target-branch
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: TARGET_BRANCH
          value: $(params.targetBranch)
        - name: CHART_VERSION_INCREMENT
          value: $(params.CHART_VERSION_INCREMENT)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-library-dependency-update
      runAfter:
        - helm-lint
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: helm-template
      taskRef:
        kind: Task
        name: helm-library-template
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: release_name
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/helm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-helm-helm-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Helm"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "The directory in source that contains the helm chart"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:

    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: check-chart-name
      params:
        - name: codebase_name
          value: $(params.CODEBASE_NAME)
        - name: chart_dir
          value: $(params.CHART_DIR)
      runAfter:
        - fetch-repository
      taskRef:
        name: check-helm-chart-name
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace

    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-dependency-update
      taskRef:
        kind: Task
        name: helm-dependency-update
      runAfter:
        - helm-docs
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - helm-dependency-update
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-template
      taskRef:
        kind: Task
        name: helm-template
      runAfter:
        - helm-lint
      params:
        - name: release_name
          value: $(params.CODEBASE_NAME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Terraform infrastructure (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Terraform infrastructure (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/infrastructure/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-aws-inf-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Terraform infrastructure"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/terraform-terraform-aws"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Gradle (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Gradle (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Gradle (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Gradle (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 library with Gradle (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 library with Gradle (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-gradle'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 library with Gradle (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 library with Gradle (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-gradle
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
        - name: IS_RELEASE_BRANCH
          value: $(tasks.get-version.results.IS_RELEASE_BRANCH)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.branch.name=$(params.git-source-revision) \
            -Dsonar.qualitygate.wait=true \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: gradle
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_ARGS
          value: |
            -Dorg.gradle.internal.publish.checksums.insecure=true \
            -PsnapshotsRepoUrl=${NEXUS_HOST_URL}${SNAPSHOTS_REPO_PATH} \
            -PreleasesRepoUrl=${NEXUS_HOST_URL}${RELEASES_REPO_PATH} \
            publish -i
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 library with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 library with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java17-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 application with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:7.6.5-jdk17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/gradle/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-gradle-java21-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 application with Gradle"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "gradle image version"
      type: string
    - name: sonar_image
      default: 'docker.io/gradle:8.11-jdk21'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: build
      taskRef:
        kind: Task
        name: edp-gradle
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-gradle
      runAfter:
        - build
      params:
        - name: BASE_IMAGE
          value: $(params.sonar_image)
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: EXTRA_COMMANDS
          value: |
            -Dsonar.projectKey=$(params.CODEBASE_NAME) \
            -Dsonar.projectName=$(params.CODEBASE_NAME) \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=$(params.changeNumber) \
            -Dsonar.pullrequest.branch=$(params.git-source-revision) \
            -Dsonar.pullrequest.base=$(params.targetBranch) \
            sonarqube
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 library with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 library with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 library with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 library with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 library with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 library with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 application with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/java/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 application with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - get-maven-module
        - build
        - dockerfile-lint
      params:
        - name: context
          value: "$(tasks.get-maven-module.results.DEPLOYABLE_MODULE_DIR)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building antora application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm cache verify --cache $NPM_CACHE_DIR
            npm ci
            npm run build
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building antora application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm cache verify --cache $NPM_CACHE_DIR
            npm ci
            npm run build
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/antora/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-antora-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building antora application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'antora-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/antora/antora:3.1.4'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            export npm_config_userconfig=/var/configmap/.npmrc-ci
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
            export NPM_CACHE_DIR=/workspace/source/cache
            npm cache verify --cache $NPM_CACHE_DIR
            npm ci
            npm run build
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
            npm publish
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building vue library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building angular library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building express library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building next library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building react library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-vue-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building vue application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-angular-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building angular application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-express-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building express application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-next-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building next application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/npm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-npm-react-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building react application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-npm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/antora/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-antora-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building antora application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/antora/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-antora-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building antora application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'antora-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - build
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/antora/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-antora-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building antora application with PNPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-antora"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'antora-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "Managed by KubeRocketCI. Run with Tekton"

    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: PATH_CONTEXT
          value: "source"
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - build
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react application with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react application with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react library with NPM (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-npm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-npm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-npm-default
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building vue library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'vue-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building angular library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'angular-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building express library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'express-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building next library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'next-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building react library with NPM (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'react-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-pnpm
      runAfter:
        - get-version
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: BRANCH_VERSION
          value: $(tasks.get-version.results.BRANCH_VERSION)
        - name: BUILD_ID
          value: $(tasks.get-version.results.BUILD_ID)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source



    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - update-build-number
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: push
      taskRef:
        kind: Task
        name: npm
      runAfter:
        - sonar
      params:
        - name: BASE_IMAGE
          value: $(params.image)
        - name: EXTRA_COMMANDS
          value: |
            export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
            # Get Nexus repository name
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')
    
            export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
    
            if [[ "$versionLowerCase" == *"snapshot"* ]]; then
                export npm_config_userconfig=/var/configmap/.npmrc-publish-snapshots
            else
                export npm_config_userconfig=/var/configmap/.npmrc-publish-releases
            fi
    
            corepack enable
    
            pnpm publish --access public --no-git-checks
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - push
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building vue library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building angular library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building express library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building next library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building react library with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-vue-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building vue application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-vue"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'vue-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-angular-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building angular application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-angular"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'angular-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-express-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building express application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-express"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'express-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-next-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building next application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-next"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'next-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/js/pnpm/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-pnpm-react-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building react application with NPM"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/javascript-pnpm-react"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'react-pnpm-edp-version'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/library/node:22.15.0-alpine3.21'
      description: "npm image version"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: edp-pnpm
      runAfter:
        - get-cache
      params:
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - fetch-repository
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/ansible/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-ansible-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Ansible library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-ansible"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'ansible'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: ansible-lint
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: ansible-tests
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        -  ansible-lint
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-playbook tests/*.*
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - ansible-tests
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/ansible/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-ansible-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Ansible library (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-ansible"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'ansible'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: ansible-lint
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: ansible-tests
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        -  ansible-lint
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-playbook tests/*.*
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - ansible-tests
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/ansible/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-ansible-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Ansible library"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-ansible"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'ansible'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: ansible-lint
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: ansible-tests
      taskRef:
        kind: Task
        name: ansible
      runAfter:
        -  ansible-lint
      params:
        - name: EXTRA_COMMANDS
          value: |
            ansible-playbook tests/*.*
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: github-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building fastapi application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: github-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building flask application (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python-default
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building fastapi application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building flask application (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: update-build-number-python
      runAfter:
        - get-version
      params:
        - name: VERSION
          value: $(tasks.get-version.results.VERSION)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
        - update-build-number
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: branch
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: push
      taskRef:
        kind: Task
        name: python
      runAfter:
        - sonar
      params:
        - name: EXTRA_COMMANDS
          value: |
            pip3 install -r test-requirements.txt
            python setup.py sdist

            # Get package version from the get-version task
            versionLowerCase=$(echo $(tasks.get-version.results.VERSION) | tr '[:upper:]' '[:lower:]')

            # # Define a repository for publishing the package
            if echo "$versionLowerCase" | grep -q "snapshot"; then
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_SNAPSHOTS}"
            else
                TWINE_REPOSITORY_URL="${REPOSITORY_URL_RELEASES}"
            fi

            echo "[TEKTON][INFO] TWINE_REPOSITORY_URL contains ${TWINE_REPOSITORY_URL}"

            twine upload dist/*
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: kaniko-build
      taskRef:
        kind: Task
        name: kaniko
      runAfter:
        - push
      params:
        - name: codebase-name
          value: "$(params.CODEBASE_NAME)"
        - name: image-tag
          value: "$(tasks.get-version.results.IS_TAG)"
        - name: image-tar
          value: "$(params.CODEBASE_NAME)_$(tasks.get-version.results.IS_TAG)"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - push
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - kaniko-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: $(tasks.get-version.results.IS_TAG)


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-fastapi-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building fastapi"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/python/flask/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-python-flask-app-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building flask"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/python-python-python-3.8"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: "python-app"
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: helm-docs
      taskRef:
        kind: Task
        name: helm-docs
      params:
        - name: CHART_DIR
          value: "deploy-templates"
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: build
      taskRef:
        kind: Task
        name: python
      runAfter:
        - get-cache
      params:
        - name: EXTRA_COMMANDS
          value: |
            # we checkout the source code in the /source directory
            # and hold cache in the /cache directory

            # build
            python setup.py clean build sdist bdist_wheel

            # lint
            pip3 install -r test-requirements.txt
            pylint --output-format=colorized *.py
            flake8 --exclude .local --filename=*.py
            # test
            pytest -sv --color=yes
      workspaces:
        - name: source
          workspace: shared-workspace

    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-general
      runAfter:
        - build
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: target-branch
          value: $(params.targetBranch)
        - name: source-branch
          value: $(params.git-source-revision)
        - name: key-id
          value: $(params.changeNumber)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: dockerfile-lint
      taskRef:
        kind: Task
        name: hadolint
      runAfter:
        - sonar
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


    - name: dockerbuild-verify
      taskRef:
        kind: Task
        name: dockerbuild-verify
      runAfter:
        - sonar
        - dockerfile-lint
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source

    - name: helm-lint
      taskRef:
        kind: Task
        name: helm-lint
      runAfter:
        - sonar
      params:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-default-rpm
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-rpm
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: suffix
          value: "$(tasks.get-version.results.NORMALIZED_VERSION)"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            make rpm-publish RELEASE=${SUFFIX}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - rpm-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: "$(tasks.get-version.results.IS_TAG)"


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-build-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-build-default-rpm
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Maven (default versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-rpm
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
        - name: BASE_IMAGE
          value: $(params.image)
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: suffix
          value: "$(tasks.get-version.results.NORMALIZED_VERSION)"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            make rpm-publish RELEASE=${SUFFIX}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - rpm-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: "$(tasks.get-version.results.IS_TAG)"


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-build-semver-rpm
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java17 application with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: suffix
          value: "$(tasks.get-version.results.SUFFIX)"
        - name: numeric_version
          value: "$(tasks.get-version.results.NUMERIC_VERSION)"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build VERSION=${NUMERIC_VERSION} RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            make rpm-publish RELEASE=${SUFFIX} VERSION=${NUMERIC_VERSION}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - rpm-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: "$(tasks.get-version.results.IS_TAG)"


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-build-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-build-semver-rpm
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building java21 application with Maven (semver versioning)"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache

    - name: update-build-number
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-version
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - versions:set
            - versions:commit
            - '-DnewVersion=$(tasks.get-version.results.VERSION)'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.branch.name=$(params.git-source-revision)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: push
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - build
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - deploy
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - push
        - build
      params:
        - name: suffix
          value: "$(tasks.get-version.results.SUFFIX)"
        - name: numeric_version
          value: "$(tasks.get-version.results.NUMERIC_VERSION)"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build VERSION=${NUMERIC_VERSION} RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            make rpm-publish RELEASE=${SUFFIX} VERSION=${NUMERIC_VERSION}
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - rpm-build
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: update-cbis
      taskRef:
        kind: Task
        name: update-cbis
      runAfter:
        - git-tag
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: IMAGE_TAG
          value: "$(tasks.get-version.results.IS_TAG)"


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java17-app-review-rpm
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java17 application with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java17-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.0-eclipse-temurin-17'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - build
      params:
        - name: suffix
          value: "0.0.0"
        - name: numeric_version
          value: "SNAPSHOT.1"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build VERSION=${NUMERIC_VERSION} RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            echo "Review pipeline - skip push step"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/rpm/maven/gitlab-review.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-maven-java21-app-review-rpm
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building java21 application with Maven"

  workspaces:
    - name: shared-workspace
    - name: ssh-creds

  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: git-source-url
      default: "https://gitlab.com/sergk/spring-petclinic"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: CODEBASE_NAME
      default: 'java21-maven'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "maven image version"
      type: string
    - name: sonar_image
      default: 'docker.io/maven:3.9.9-eclipse-temurin-21'
      description: "sonar image version"
      type: string
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: get-cache
      taskRef:
        kind: Task
        name: get-cache
      runAfter:
        - fetch-repository
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache
    - name: get-maven-module
      taskRef:
        kind: Task
        name: get-maven-module
      runAfter:
        - init-values
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: compile
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - get-cache
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - compile
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: test
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - compile
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - org.jacoco:jacoco-maven-plugin:prepare-agent
            - '-Dmaven.test.failure.ignore=true'
            - verify
            - org.jacoco:jacoco-maven-plugin:report
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: sonar
      taskRef:
        kind: Task
        name: sonarqube-maven
      runAfter:
        - test
      params:
        - name: SONAR_PROJECT_KEY
          value: $(params.CODEBASE_NAME)
        - name: SONAR_PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: MAVEN_IMAGE
          value: $(params.sonar_image)
        - name: EXTRA_COMMANDS
          value:
            - -B
            - '-Dsonar.projectKey=$(params.CODEBASE_NAME)'
            - '-Dsonar.projectName=$(params.CODEBASE_NAME)'
            - '-Dsonar.pullrequest.key=$(params.changeNumber)'
            - '-Dsonar.pullrequest.branch=$(params.git-source-revision)'
            - '-Dsonar.pullrequest.base=$(params.targetBranch)'
            - '-Dsonar.qualitygate.wait=true'
            - verify
            - sonar:sonar
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: build
      taskRef:
        kind: Task
        name: maven
      runAfter:
        - sonar
      params:
        - name: MAVEN_IMAGE
          value: $(params.image)
        - name: GOALS
          value:
            - -B
            - clean
            - package
            - '-DskipTests=true'
      workspaces:
        - name: source
          workspace: shared-workspace


    - name: rpm-build
      taskRef:
        kind: Task
        name: rpm-build
      runAfter:
        - get-maven-module
        - build
      params:
        - name: suffix
          value: "0.0.0"
        - name: numeric_version
          value: "SNAPSHOT.1"
        - name: EXTRA_LINT_COMMAND
          value: |
            make rpm-lint
        - name: EXTRA_BUILD_COMMAND
          value: |
            make rpm-build VERSION=${NUMERIC_VERSION} RELEASE=${SUFFIX}
        - name: EXTRA_PUSH_COMMAND
          value: |
            echo "Review pipeline - skip push step"
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    - name: save-cache
      taskRef:
        kind: Task
        name: save-cache
      runAfter:
        - build
      params:
        - name: CACHE_NAME
          value: $(params.CODEBASE_NAME)
      workspaces:
        - name: cache
          workspace: shared-workspace
          subPath: cache


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/security/image-scan-remote.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: image-scan-remote
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: security
    app.edp.epam.com/triggertemplate: image-scan-remote
spec:
  description: >-
    The 'image-scan-remote' Tekton pipeline is used for scanning container images as part of the CI/CD process.
    To streamline and standardize its usage, a dedicated TriggerTemplate must be created
    with the necessary parameters for basic scan operations.
  params:
    - name: IMAGE_NAMES
      type: array
      description: List of container images to be scanned. Each image can be in the format
        `registry/repository/image:tag` or `registry/repository/image`.
    - name: COMPONENT_NAME
      type: string
      description: Name of the component to which the images belong.
        Pipeline will use this name to create/update the appropriate
        Engagement with scan reports in DefectDojo.
  results:
    - description: DefectDojo URL with the generated vulnerability scan reports
      name: SCAN_REPORT_URL
      type: string
      value: $(tasks.image-scan.results.SCAN_REPORT_URL)
  tasks:
    - name: image-scan
      params:
        - name: IMAGE_NAMES
          value: $(params.IMAGE_NAMES[*])
        - name: COMPONENT_NAME
          value: $(params.COMPONENT_NAME)
      taskRef:
        kind: Task
        name: image-scan-remote
      workspaces:
        - name: source
          subPath: source
          workspace: shared-workspace
  workspaces:
    - name: shared-workspace
---
# Source: edp-tekton/templates/pipelines/security/security-scan-gitlab.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-security-scan
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/triggertemplate: gitlab-security-template
    app.edp.epam.com/pipelinetype: security
spec:
  description: >-
    A specialized pipeline for GitLab projects that executes a trio of security tools:
    gitleaks for detecting credential exposure, cdxgen for dependency analysis and SBOM creation,
    and semgrep for identifying code vulnerabilities. Security findings are automatically
    synchronized with DefectDojo for comprehensive vulnerability lifecycle management.
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "main"
      type: string
    - name: git-source-url
      description: 'url to checkout'
      default: "https://gitlab.com/Rolika4/springboot.git"
      type: string
    - name: CODEBASE_NAME
      default: 'gradle'
      description: "Project name"
      type: string
  results:
    - description: DefectDojo URL with the generated vulnerability scan reports
      name: SCAN_REPORT_URL
      type: string
      value: $(tasks.security.results.SCAN_REPORT_URL)
  tasks:
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds

    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: security
      taskRef:
        kind: Task
        name: security
      runAfter:
        - init-values
      params:
        - name: DD_PRODUCT_NAME
          value: $(tasks.init-values.results.TENANT_NAME)
        - name: DD_ENGAGEMENT_NAME
          value: "$(params.CODEBASE_NAME)-$(params.git-source-revision)"
        - name: PROJECT_NAME
          value: $(params.CODEBASE_NAME)
        - name: PROJECT_BRANCH
          value: $(params.git-source-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-build-lib-default.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-build-default
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Terraform library (default versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-default
      runAfter:
        - init-values
      params:
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-build-lib-edp.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-build-semver
  labels:
    app.edp.epam.com/pipelinetype: build
    app.edp.epam.com/triggertemplate: gitlab-build-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Build pipeline for building Terraform library (semver versioning)"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "master"
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: CODEBASEBRANCH_NAME
      description: "Codebasebranch name"
      type: string
    - name: changeNumber
      description: Change number from Merge Request
      default: ""
      type: string
    - name: TICKET_NAME_PATTERN
      description: "Ticket name pattern"
      default: ""
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
      default: ""
    - name: COMMIT_MESSAGE
      description: "Commit message"
      default: ""
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      description: "Jira Payload"
      default: ""
    - name: JIRA_SERVER
      description: "Jira server name"
      default: ""
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.
  results:
    - description: VCS tag
      name: VCS_TAG
      type: string
      value: $(tasks.get-version.results.VCS_TAG)

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      when:
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
          
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)

    - name: get-version
      taskRef:
        kind: Task
        name: get-version-edp
      runAfter:
        - init-values
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - get-version
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
    
    - name: git-tag
      taskRef:
        kind: Task
        name: git-cli
      runAfter:
        - terraform-check
      params:
        - name: GIT_USER_EMAIL
          value: edp-ci@edp.ci-user
        - name: GIT_USER_NAME
          value: edp-ci
        - name: GIT_SCRIPT
          value: |
            git tag -a "$(tasks.get-version.results.VCS_TAG)" -m "Tag is added automatically by CI user"
            git push --tags
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source
        - name: ssh-directory
          workspace: ssh-creds


  finally:
  
    - name: update-cbb
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded", "Completed"]
      taskRef:
        kind: Task
        name: update-cbb
      params:
        - name: CODEBASEBRANCH_NAME
          value: $(params.CODEBASEBRANCH_NAME)
        - name: CURRENT_BUILD_NUMBER
          value: $(tasks.get-version.results.BUILD_ID)
  
  
    - name: push-to-jira
      taskRef:
        kind: Task
        name: push-to-jira
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: "$(params.JIRA_SERVER)"
          operator: notin
          values: [""]
        - input: "$(params.COMMIT_MESSAGE)"
          operator: notin
          values: [""]
      params:
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(tasks.fetch-repository.results.commit)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(tasks.get-version.results.VCS_TAG)"
        - name: VERSION
          value: "$(tasks.get-version.results.VERSION)"
        - name: GIT_URL
          value: $(params.git-source-url)


    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
    
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
        - input: $(params.COMMIT_MESSAGE)
          operator: notin
          values: [""]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Build Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/pipelines/terraform/gitlab-review-lib.yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: gitlab-terraform-terraform-lib-review
  labels:
    app.edp.epam.com/pipelinetype: review
    app.edp.epam.com/triggertemplate: gitlab-review-template
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: "The Review pipeline for building Terraform library"
  workspaces:
    - name: shared-workspace
    - name: ssh-creds
  params:
    - name: pipelineUrl
      default: https://portal-default./c/main/pipelines/pipelineruns/$(context.pipelineRun.namespace)/$(context.pipelineRun.name)
      type: string
    - name: git-source-url
      default: "https://github.com/epmd-edp/hcl-terraform-terraform"
      description: git url to clone
      type: string
    - name: git-source-revision
      description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
      default: "edp"
      type: string
    - name: git-refspec
      description: Refspec to fetch before checking out revision.
      default: ""
      type: string
    - name: CODEBASE_NAME
      default: 'terraform-terraform'
      description: "Project name"
      type: string
    - name: gitfullrepositoryname
      description: "repository full name"
      type: string
    - name: terraform_default_version
      type: string
      default: "1.5.7"
      description: The default terraform version used if the `.terraform-version` file does not exist in the repository.

  tasks:
    - name: report-pipeline-start-to-gitlab
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "pending"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "IN PROGRESS"
    
    - name: fetch-repository
      taskRef:
        kind: Task
        name: git-clone
      runAfter:
        - report-pipeline-start-to-gitlab
      params:
        - name: url
          value: $(params.git-source-url)
        - name: revision
          value: $(params.git-source-revision)
        - name: refspec
          value: $(params.git-refspec)
        - name: subdirectory
          value: source
      workspaces:
        - name: output
          workspace: shared-workspace
        - name: ssh-directory
          workspace: ssh-creds
    
    - name: init-values
      taskRef:
        kind: Task
        name: init-values
      runAfter:
        - fetch-repository
      params:
        - name: CODEBASE_NAME
          value: $(params.CODEBASE_NAME)
        - name: BRANCH_NAME
          value: $(params.git-source-revision)
    - name: terraform-check
      taskRef:
        kind: Task
        name: terraform-check
      runAfter:
        - init-values
      params:
        - name: EXTRA_COMMANDS
          value: |
            if [ -f .terraform-version ]; then
                tfenv install
            else
                tfenv install "$(params.terraform_default_version)";
                tfenv use "$(params.terraform_default_version)";
            fi
            terraform init
            chown -R $(whoami):$(whoami) .
            pre-commit run --all-files
      workspaces:
        - name: source
          workspace: shared-workspace
          subPath: source


  finally:
    - name: gitlab-set-success-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Succeeded"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "PASSED"
  
    - name: gitlab-set-failure-status
      when:
        - input: "$(tasks.status)"
          operator: in
          values: ["Failed"]
      taskRef:
        kind: Task
        name: gitlab-set-status
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.git-source-url)"
        - name: "REPO_FULL_NAME"
          value: "$(params.gitfullrepositoryname)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: ci-gitlab
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: token
        - name: "SHA"
          value: "$(params.git-source-revision)"
        - name: "TARGET_URL"
          value: $(params.pipelineUrl)
        - name: "CONTEXT"
          value: "Review Pipeline"
        - name: "DESCRIPTION"
          value: "FAILED"
---
# Source: edp-tekton/templates/tasks/ansible.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ansible
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task runs Ansible commands using a specified base image within a given project directory, allowing for additional custom commands.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing ansible files
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: docker.io/pipelinecomponents/ansible-lint:0.72.0
      description: The ansible image.
  steps:
    - name: ansible
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/init-autotests.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: init-autotests
spec:
  description: >-
    This task initializes and triggers autotests for a specified Deployment Flow and Environment by dynamically generating Tekton PipelineRun commands based on autotest configurations.
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  volumes:
    - name: autotests-workspace-template
      configMap:
        name: autotests-workspace-template
  params:
    - name: ENVIRONMENT
      type: string
    - name: DEPLOYMENT_FLOW
      type: string
    - name: AUTOTEST_PIPELINES
      default: 'autotes-pipeline'
    - name: codebase_tags
      default: 'codebase_tags'
    - name: parent-pipeline-name
      default: ''
    - name: step_init_autotest_image
      description: "The base image for the task."
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  results:
    - name: AUTOTEST_PIPELINES
      type: string
    - name: codebase_tags
      type: string
  steps:
    - name: init-autotests
      image: $(params.step_init_autotest_image)
      workingDir: $(workspaces.source.path)
      volumeMounts:
        - name: autotests-workspace-template
          mountPath: "/var/configmap"
      env:
        - name: CODEBASE_TAGS
          value: "$(params.codebase_tags)"
        - name: AUTOTEST_PIPELINES
          value: "$(params.AUTOTEST_PIPELINES)"
        - name: ENVIRONMENT
          value: $(params.ENVIRONMENT)
        - name: DEPLOYMENT_FLOW
          value: $(params.DEPLOYMENT_FLOW)
        - name: PARENT_PIPELINE_NAME
          value: $(params.parent-pipeline-name)
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        #!/usr/bin/env python

        import subprocess
        import json
        import os
        import re

        autotestsList = []
        autotestBuildTool = []
        gitAutotesUrl = []
        autotestsBranch = []
        pipelines = ""
        applications = []
        tags = []
        codebases = ""
        autotestFramework =[]
        gitSecret = {}

        frameworks = {
          "gradle-java8": "gradle:7.6.5-jdk8",
          "gradle-java11": "gradle:7.6.5-jdk11",
          "gradle-java17": "gradle:7.6.5-jdk17",
          "maven-java8": "maven:3.9.0-eclipse-temurin-8",
          "maven-java11": "maven:3.9.0-eclipse-temurin-11",
          "maven-java17": "maven:3.9.0-eclipse-temurin-17"
        }
        cdPipelineName = os.getenv('DEPLOYMENT_FLOW')
        stage = os.getenv('ENVIRONMENT')
        parentPipelineName = os.getenv('PARENT_PIPELINE_NAME')
        codebaseFileTags = os.getenv('CODEBASE_TAGS')

        autotests = json.loads(subprocess.check_output(["kubectl", "get", "stages.v2.edp.epam.com", cdPipelineName + "-" + stage, "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))

        for element in autotests["qualityGates"]:
            if element["qualityGateType"] == "autotests":
              autotestGitServer = subprocess.check_output(["kubectl", "get", "codebase", element["autotestName"], "-o=jsonpath='{.spec.gitServer}'"]).decode("utf-8").strip("'")
              gitserver = json.loads(subprocess.check_output(["kubectl", "get", "gitserver", autotestGitServer , "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))
              autotestsList.append(element["autotestName"])
              autotestsBranch.append(element["branchName"])
              autotest = json.loads(subprocess.check_output(["kubectl", "get", "codebase", element["autotestName"], "-o=jsonpath='{.spec}'"]).decode("utf-8").strip("'"))
              gitAutotesUrl.append("ssh://" + gitserver['gitUser'] + "@" + gitserver['gitHost'] + ":" + str(gitserver['sshPort']) + autotest['gitUrlPath'])
              autotestBuildTool.append(autotest["buildTool"])
              autotestFramework.append(autotest["framework"])

              gitSecret[element["autotestName"]] = gitserver['nameSshKeySecret']

        for count, element in enumerate(autotestsList):
            print("[TEKTON][DEBUG]: Run autotest - autotests-" + autotestBuildTool[count])
            print("[TEKTON][DEBUG]: Autotest URL - " + gitAutotesUrl[count])
            print("[TEKTON][DEBUG]: Autotest branch - " + autotestsBranch[count])
            command = "tkn pipeline start autotests-" + autotestBuildTool[count] + " \
            --use-param-defaults \
            -p git-source-url=" + gitAutotesUrl[count] + " \
            -p git-source-revision=" + autotestsBranch[count] + " \
            -p stage-name=" + stage +" \
            -p cd-pipeline-name=" + cdPipelineName +" \
            -p base-image=" + frameworks[autotestBuildTool[count] + "-" + autotestFramework[count]] + " \
            --labels app.edp.epam.com/pipeline=" + cdPipelineName + " \
            --labels app.edp.epam.com/stage=" + stage + " \
            --labels app.edp.epam.com/codebase=" + autotestsList[count] + " \
            --labels app.edp.epam.com/branch=" + autotestsBranch[count] + " \
            --labels app.edp.epam.com/parentPipelineRun=" + parentPipelineName + " \
            --workspace name=ssh-creds,secret=" + gitSecret[autotestsList[count]] + " \
            --workspace name=shared-workspace,volumeClaimTemplateFile=/var/configmap/volumeclaimtemplate.yaml"

            result = subprocess.run(command, shell=True, capture_output=True, text=True)
            output = re.search("autotests(-[A-Za-z0-9]*)* ", result.stdout)
            pipelines += output.group() + " "

        autotests_pipelines_file = os.getenv("AUTOTEST_PIPELINES")
        with open(autotests_pipelines_file, "w") as outfile:
            outfile.write(pipelines)

        try:
            listApplications = json.loads(subprocess.check_output(["kubectl", "get", "cdpipeline", cdPipelineName , "-o=jsonpath='{.spec.applicationsToPromote}'"]).decode("utf-8").strip("'"))
            kindApplications = subprocess.check_output(["kubectl", "get", "applications"])

            for element in listApplications:
                output = re.search(cdPipelineName + "-" + stage + "-" + element, str(kindApplications))
                applications.append(output.group())

            print("[TEKTON][DEBUG]: Images to promote:")
            for element in applications:
                print(element)

            for count, element in enumerate(applications):
                temp = subprocess.check_output(["kubectl", "get", "application", element.strip(" ") , "-o=jsonpath='{.spec.source.helm.parameters[0].value}'"]).decode("utf-8").strip("'")
                codebases += listApplications[count] + "=" + temp + " "

            with open(codebaseFileTags, "w") as outfile:
                outfile.write(codebases)

            with open("/tekton/results/" + codebaseFileTags, "w") as outfile:
                outfile.write(codebases)
        except:
            with open("/tekton/results/" + codebaseFileTags, "w") as outfile:
                outfile.write("not-set")
            print("[TEKTON][DEBUG]: No images to promote.")
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/run-autotests-java.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-autotests-maven
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Autootest Tools
    tekton.dev/tags: autotest-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task runs autotests for a specified stage using either Maven or Gradle based on the provided configuration, extracting and executing the relevant commands from a `run.json` file.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  params:
    - name: cd-pipeline-name
      type: string
    - name: stage-name
      type: string
    - name: base-image
      type: string
  steps:
    - name: run-autotests
      image: "$(params.base-image)"
      workingDir: $(workspaces.source.path)
      env:
        - name: STAGE_NAME
          value: $(params.stage-name)
        - name: CD_PIPELINE_NAME
          value: $(params.cd-pipeline-name)
      envFrom:
        - configMapRef:
            name: $(params.cd-pipeline-name)-$(params.stage-name)
      script: |
        #!/bin/bash

        set -exo pipefail
        $(sed -n 's/.*"'$STAGE_NAME'": "\(.*\)",/\1/p' run.json | awk -F '"' '{print $1}')
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/run-autotests-java.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-autotests-gradle
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Autootest Tools
    tekton.dev/tags: autotest-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task runs autotests for a specified stage using either Maven or Gradle based on the provided configuration, extracting and executing the relevant commands from a `run.json` file.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  params:
    - name: cd-pipeline-name
      type: string
    - name: stage-name
      type: string
    - name: base-image
      type: string
  steps:
    - name: run-autotests
      image: "$(params.base-image)"
      workingDir: $(workspaces.source.path)
      env:
        - name: STAGE_NAME
          value: $(params.stage-name)
        - name: CD_PIPELINE_NAME
          value: $(params.cd-pipeline-name)
      envFrom:
        - configMapRef:
            name: $(params.cd-pipeline-name)-$(params.stage-name)
      script: |
        #!/bin/bash

        set -exo pipefail
        $(sed -n 's/.*"'$STAGE_NAME'": "\(.*\)",/\1/p' run.json | awk -F '"' '{print $1}')
---
# Source: edp-tekton/templates/tasks/autotest-cd-pipeline/wait-autotest.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: wait-for-autotests
spec:
  description: >-
    This task waits for the completion of specified autotest pipelines by monitoring their statuses and exits if any pipeline fails.
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  params:
    - name: AUTOTEST_PIPELINES
      default: 'autotes-pipeline'
    - name: step_wait_for_image
      description: "The base image for the task."
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  steps:
    - name: wait-for
      image: $(params.step_wait_for_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: AUTOTEST_PIPELINES
          value: "$(params.AUTOTEST_PIPELINES)"
      script: |
        #!/usr/bin/env python

        import subprocess
        import json
        import os
        import time

        pipelines = os.getenv('AUTOTEST_PIPELINES')
        output = ""
        pipelines_name = []

        with open(pipelines, 'r') as f:
            output = f.read()

        pipelines_name = output.split()

        while pipelines_name:
            value = pipelines_name[0]
            result = subprocess.check_output(["kubectl", "get", "pipelinerun", value, "-o=jsonpath='{.status.conditions[].reason}'"]).decode("utf-8").strip("'")
            if result.strip() == 'Succeeded':
                pipelines_name.pop(0)
            if result.strip() == 'Failed':
                print("[DEBUG]: Autotest failed.")
                exit(1)
            else:
                continue

        print("[TEKTON][DEBUG]: All autotests finished.")
---
# Source: edp-tekton/templates/tasks/autotests/run-autotests.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-autotests
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    This task is intended for executing autotests using a specified Makefile target.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  params:
    - name: makefile-target
      type: string
    - name: base-image
      type: string
  steps:
    - name: run-autotests
      image: "$(params.base-image)"
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash

        set -exo pipefail

        make $(params.makefile-target)
---
# Source: edp-tekton/templates/tasks/bitbucket-set-status.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: bitbucket-set-status
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/categories: Git
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: bitbucket
    tekton.dev/displayName: "set bitbucket status"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task will set the status of the CI job to the specified value along
    with a link to the specified target URL where developers can follow the
    progress of the CI job.

    The `bitbucket-set-status` task allows external services to mark Bitbucket commits
    with an `INPROGRESS`, `SUCCESSFUL`, or `FAILED` state, which is then
    reflected in pull requests involving those commits. Statuses include a
    `description` and a `target_url` to give users information about the CI
    statuses or a direct link to the full log.
  volumes:
    - name: bitbuckettoken
      secret:
        secretName: $(params.BITBUCKET_TOKEN_SECRET_NAME)
  params:
    - name: BITBUCKET_HOST_URL
      description: |
        The Bitbucket host, adjust this if you run a Bitbucket server.
      default: "api.bitbucket.org"
      type: string
    - name: API_PATH_PREFIX
      description: |
        The API path prefix, Bitbucket may have a prefix for certain versions.
      default: "https://api.bitbucket.org/2.0/repositories/"
      type: string
    - name: REPO_FULL_NAME
      description: |
        The Bitbucket repository full name, e.g.: myorg/myrepo
      type: string
    - name: BITBUCKET_TOKEN_SECRET_NAME
      description: |
        The name of the kubernetes secret that contains the Bitbucket token, default: bitbucket
      type: string
      default: ci-bitbucket
    - name: BITBUCKET_TOKEN_SECRET_KEY
      description: |
        The key within the kubernetes secret that contains the Bitbucket token, default: token
      type: string
      default: token
    - name: SHA
      description: |
        Commit SHA to set the status for.
      type: string
    - name: TARGET_URL
      description: |
        The target URL to associate with this status. This URL will be linked
        from the Bitbucket UI to allow users to easily see the source of the
        status.
      type: string
    - name: DESCRIPTION
      description: |
        A short description of the status.
      type: string
    - name: STATE
      description: |
        The state of the status. Can be one of the following `INPROGRESS`,
        `SUCCESSFUL`, or `FAILED`.
      type: string
    - name: AUTH_TYPE
      description: |
        The type of authentication to use. You could use the less secure "Basic" for example.
      type: string
      default: Basic
    - name: IMAGE
      description: |
        Image providing the python binary which this task uses.
      type: string
      default: docker.io/python:3.10.8-alpine3.16
    - name: SHEBANG
      description: |
        Python path. Depends on the image.
      type: string
      default: /usr/bin/env python
    - name: KEY
      description: |
        The key that holds the status, e.g., build, review, deploy.
      type: string
    - name: NAME
      description: |
        If the name field is present, it'll be displayed to users in the UI.
      type: string
  steps:
    - name: set-status
      volumeMounts:
        - name: bitbuckettoken
          mountPath: /etc/bitbucket-set-status
      env:
        - name: BITBUCKET_HOST_URL
          value: $(params.BITBUCKET_HOST_URL)
        - name: API_PATH_PREFIX
          value: $(params.API_PATH_PREFIX)
        - name: REPO_FULL_NAME
          value: $(params.REPO_FULL_NAME)
        - name: BITBUCKET_TOKEN_SECRET_NAME
          value: $(params.BITBUCKET_TOKEN_SECRET_NAME)
        - name: BITBUCKET_TOKEN_SECRET_KEY
          value: $(params.BITBUCKET_TOKEN_SECRET_KEY)
        - name: SHA
          value: $(params.SHA)
        - name: TARGET_URL
          value: $(params.TARGET_URL)
        - name: DESCRIPTION
          value: $(params.DESCRIPTION)
        - name: STATE
          value: $(params.STATE)
        - name: AUTH_TYPE
          value: $(params.AUTH_TYPE)
        - name: SHEBANG
          value: $(params.SHEBANG)
        - name: KEY
          value: $(params.KEY)
        - name: NAME
          value: $(params.NAME)

      image: $(params.IMAGE)
      script: |
        #!$(params.SHEBANG)

        """This script will set the CI status on Bitbucket PR with enhanced debugging"""

        import json
        import os
        import sys
        import http.client

        # Load the token
        bitbucket_token_filename = "/etc/bitbucket-set-status/" + \
            os.getenv("BITBUCKET_TOKEN_SECRET_KEY")
        bitbucket_token = open(bitbucket_token_filename, "r").read().strip()

        # Form the status URL
        status_url = os.getenv("API_PATH_PREFIX") + os.getenv("REPO_FULL_NAME") + "/commit/" + os.getenv("SHA") + "/statuses/build"

        # Prepare the data
        data = {
            "state": os.getenv("STATE"),
            "url": os.getenv("TARGET_URL"),
            "description": os.getenv("DESCRIPTION"),
            "key": os.getenv("KEY"),
            "name": os.getenv("NAME")
        }

        authHeader = os.getenv("AUTH_TYPE") + " " + bitbucket_token
        headers = {
            "User-Agent": "TektonCD, the peaceful cat",
            "Authorization": authHeader,
            "Accept": "application/json",
            "Content-Type": "application/json"
        }

        # This is for our fake bitbucket server
        if "$(params.BITBUCKET_HOST_URL)".startswith("http://"):
            conn = http.client.HTTPConnection("$(params.BITBUCKET_HOST_URL)".replace("http://", ""))
        else:
            conn = http.client.HTTPSConnection("$(params.BITBUCKET_HOST_URL)")

        # Send the request
        conn.request("POST", status_url, body=json.dumps(data), headers=headers)

        resp = conn.getresponse()

        response_body = resp.read()

        if not str(resp.status).startswith("2"):
            print("Error: %d" % (resp.status))
            print(response_body)
            sys.exit(1)
        else:
            print("Bitbucket status '{state}' has been set on {repo}#{sha}".format(
                state=os.getenv("STATE"),
                repo=os.getenv("REPO_FULL_NAME"),
                sha=os.getenv("SHA"),
                key=os.getenv("KEY"),
                name=os.getenv("NAME"),)
            )
---
# Source: edp-tekton/templates/tasks/cd/clean.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: clean
spec:
  description: >-
    This task cleans up Argo CD applications for a specified Deployment Flow and Environment by deleting the applications matching the provided labels.
  params:
    - name: DEPLOYMENT_FLOW
      type: string
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: ENVIRONMENT
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string

  steps:
    - name: clean-argo-app
      image: docker.io/epamedp/tekton-cd-pipeline:0.1.4
      env:
        - name: ARGOCD_URL
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: url
        - name: ARGOCD_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: token
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        set -ex

        export ARGOCD_OPTS="--core=false --grpc-web"
        # the address of the Argo CD server without https:// prefix
        export ARGOCD_SERVER=${ARGOCD_URL#*//}

        pipeline=$(params.DEPLOYMENT_FLOW)
        stage=$(params.ENVIRONMENT)

        selector="app.edp.epam.com/stage=$(params.ENVIRONMENT),app.edp.epam.com/pipeline=$(params.DEPLOYMENT_FLOW)"

        argocd app delete -l $selector -y
---
# Source: edp-tekton/templates/tasks/cd/deploy-ansible-awx.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: deploy-ansible-awx
spec:
  description: >
    This Task is designed to configure the tower-cli tool and invoke 
    an Ansible AWX Template that runs an Ansible Playbook for installing 
    RPM packages on target servers.
  params:
    - description: >
        Applications payload in format: {"codebase1": {"imageTag": "version1",
        "customValues": true}, "codebase2": {"imageTag": "version2",
        "customValues": true}}.
      name: APPLICATIONS_PAYLOAD
      type: string
    - description: >
        KRCI kind:CDPipeline name used for deployment. For example: mypipe,
        myfeature
      name: DEPLOYMENT_FLOW
      type: string
    - description: >
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE
        values. For example: dev, test, prod
      name: ENVIRONMENT
      type: string
    - name: APPLICATIONS_PAYLOAD_FILE
      default: 'applications_payload'
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
  steps:
    - name: deploy-ansible-awx
      image: docker.io/epamedp/tekton-ansible:0.1.1
      env:
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: APPLICATIONS_PAYLOAD_FILE
          value: "$(params.APPLICATIONS_PAYLOAD_FILE)"
        - name: DEPLOYMENT_FLOW
          value: $(params.DEPLOYMENT_FLOW)
        - name: ENVIRONMENT
          value: $(params.ENVIRONMENT)
        - name: AWX_HOST
          valueFrom:
            secretKeyRef:
              name: ci-awx
              key: url
        - name: AWX_USERNAME
          valueFrom:
            secretKeyRef:
              name: ci-awx
              key: username
        - name: AWX_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ci-awx
              key: password
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        #!/usr/bin/env sh

        set -eu
        tower-cli config host ${AWX_HOST}
        tower-cli config username ${AWX_USERNAME}
        tower-cli config password ${AWX_PASSWORD}
        tower-cli config verify_ssl false

        tower-cli job launch --job-template=package-install \
          --extra-vars="{\"APPLICATIONS_PAYLOAD\":${APPLICATIONS_PAYLOAD},\"STAGE\":\"${ENVIRONMENT}\",\"PIPELINE\":\"${DEPLOYMENT_FLOW}\"}" \
          --inventory=${DEPLOYMENT_FLOW} --wait --limit=${DEPLOYMENT_FLOW}_${ENVIRONMENT}

        # Write results to the output
        result_file = os.getenv("APPLICATIONS_PAYLOAD_FILE")
          with open(result_file, "w") as outfile:
              outfile.write(payload)
---
# Source: edp-tekton/templates/tasks/cd/deploy-ansible.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-ansible
spec:
  description: |
    This task deploys applications using Ansible through an inline Python script.
  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: DEPLOYMENT_FLOW
      type: string
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: ENVIRONMENT
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
    - name: APPLICATIONS_PAYLOAD_FILE
      default: 'applications_payload'
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
  steps:
    - name: run-ansible-script
      image: docker.io/epamedp/tekton-ansible:0.1.1
      env:
        - name: APPLICATIONS_PAYLOAD
          value: "$(params.APPLICATIONS_PAYLOAD)"
        - name: APPLICATIONS_PAYLOAD_FILE
          value: "$(params.APPLICATIONS_PAYLOAD_FILE)"
        - name: DEPLOYMENT_FLOW
          value: "$(params.DEPLOYMENT_FLOW)"
        - name: ENVIRONMENT
          value: "$(params.ENVIRONMENT)"
        - name: GIT_URL
          valueFrom:
            secretKeyRef:
              name: cd-ansible-gitops-key
              key: url
        - name: NEXUS_USERNAME
          valueFrom:
            secretKeyRef:
              name: ci-nexus
              key: username
        - name: NEXUS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ci-nexus
              key: password
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        #!/usr/bin/env python
        import os
        import subprocess
        import json
        from glob import glob

        def load_payload(payload):
            """Load the JSON payload into a dictionary."""
            return json.loads(payload)

        def clone_git_repo(git_url, ssh_key_path):
            """Clone the Git repository using the provided SSH key and URL."""
            repo_dir = "/tmp/repo"

            os.makedirs("/root/.ssh", exist_ok=True)
            subprocess.run(["cp", ssh_key_path, "/root/.ssh/id_rsa_gitops"], check=True)
            subprocess.run(["chmod", "400", "/root/.ssh/id_rsa_gitops"], check=True)

            os.environ['GIT_SSH_COMMAND'] = 'ssh -i /root/.ssh/id_rsa_gitops -o StrictHostKeyChecking=no'
            subprocess.run(["git", "clone", git_url, repo_dir], check=True)

            print(f"Cloned {git_url} into {repo_dir}")

            return repo_dir

        def run_ansible_playbook(playbook_path, inventory_path, ansible_group, repo_dir):
            """Run an Ansible playbook."""
            ansible_command = [
                "ansible-playbook",
                "-i", inventory_path,
                playbook_path,
                "-e", f"target={ansible_group} src_path={repo_dir}",  # Pass the ansible_group variable to the playbook
            ]

            print(f"Running Ansible playbook {playbook_path} on group={ansible_group}...")
            subprocess.run(ansible_command, check=True)

        def run_ansible_deployment(repo_dir, payload, ansible_group, pipeline, stage):
            """Run Ansible playbook for each application in the payload."""
            inventory_path = os.path.join(repo_dir, 'inventory.ini')

            for codebase, details in payload.items():
                image_tag = details.get("imageTag")
                custom_values = details.get("customValues", False)

                if image_tag:
                    # Construct the Ansible command to install the package
                    ansible_command = [
                        "ansible",
                        "-i", inventory_path,
                        ansible_group,
                        "-m", "yum",
                        "-a", f"name={codebase}-{image_tag} state=present allow_downgrade=true",
                        "-b",
                        "--become"
                    ]

                    print(f"Running Ansible command to deploy {codebase} with image tag {image_tag}...")
                    subprocess.run(ansible_command, check=True)

                if custom_values:
                    # Construct the path for custom values with the PIPELINE variable
                    custom_values_dir = os.path.join(repo_dir, pipeline, stage, codebase)
                    repository_dir = os.path.join(pipeline, stage, codebase)
                    print(f"Custom values directory: {repository_dir}")

                    if os.path.exists(custom_values_dir):
                        print(f"Repository directory exists: {repository_dir}")
                        custom_values_playbooks = sorted(glob(os.path.join(custom_values_dir, '*.yml')))
                        repository_dir_playbook = sorted(glob(os.path.join(repository_dir, '*.yml')))

                        if custom_values_playbooks:
                            print(f"Found playbooks: {repository_dir_playbook}")
                            for playbook_file in custom_values_playbooks:
                                print(f"Running custom values playbook {playbook_file}...")
                                run_ansible_playbook(playbook_file, inventory_path, ansible_group, repo_dir)
                        else:
                            print(f"No playbooks found in directory: {repository_dir}")
                    else:
                        print(f"Directory does not exist: {repository_dir}")

        def prepare_ssh_keys(gitops_ssh_key_path, ansible_ssh_key_path):
            """Prepare SSH keys for Git and Ansible."""
            os.makedirs("/root/.ssh", exist_ok=True)
            subprocess.run(["cp", gitops_ssh_key_path, "/root/.ssh/id_rsa_gitops"], check=True)
            subprocess.run(["chmod", "400", "/root/.ssh/id_rsa_gitops"], check=True)
            subprocess.run(["cp", ansible_ssh_key_path, "/root/.ssh/id_rsa_ansible"], check=True)
            subprocess.run(["chmod", "400", "/root/.ssh/id_rsa_ansible"], check=True)

        def main():
            ansible_ssh_key_path = "/tmp/ssh-key/id_rsa"
            gitops_ssh_key_path = "/tmp/ssh-gitops-key/id_rsa"
            git_url = os.getenv('GIT_URL')
            payload = load_payload(os.getenv("APPLICATIONS_PAYLOAD", "{}"))
            pipeline = os.getenv('DEPLOYMENT_FLOW')
            stage = os.getenv('ENVIRONMENT')
            ansible_group = f"{pipeline}_{stage}"

            print(f"APPLICATIONS_PAYLOAD: {payload}")
            print(f"DEPLOYMENT_FLOW: {pipeline}")
            print(f"ENVIRONMENT: {stage}")
            print(f"ansible_group: {ansible_group}")
            print(f"GIT_URL: {git_url}")
            print(f"NEXUS_USERNAME: {os.getenv('NEXUS_USERNAME')}")

            prepare_ssh_keys(gitops_ssh_key_path, ansible_ssh_key_path)

            repo_dir = clone_git_repo(git_url, gitops_ssh_key_path)

            # Run pre-deploy playbook
            pre_deploy_playbook_path = os.path.join(repo_dir, 'pre-deploy.yml')
            run_ansible_playbook(pre_deploy_playbook_path, os.path.join(repo_dir, 'inventory.ini'), ansible_group, repo_dir)

            # Run deployment playbooks
            run_ansible_deployment(repo_dir, payload, ansible_group, pipeline, stage)

            # Write results to the output
            result_file = os.getenv("APPLICATIONS_PAYLOAD_FILE")
              with open(result_file, "w") as outfile:
                  outfile.write(payload)

        if __name__ == "__main__":
            main()

      volumeMounts:
        - name: ansible-ssh-key-volume
          mountPath: /tmp/ssh-key
        - name: gitops-ssh-key-volume
          mountPath: /tmp/ssh-gitops-key

  volumes:
    - name: ansible-ssh-key-volume
      secret:
        secretName: cd-ansible-ssh-key
    - name: gitops-ssh-key-volume
      secret:
        secretName: cd-ansible-gitops-key
    - name: nexus-credentials
      secret:
        secretName: ci-nexus
---
# Source: edp-tekton/templates/tasks/cd/deploy-applicationset-cli.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-applicationset-cli
spec:
  description: |
    This task is used to deploy Codebases across specific Environment using ApplicationSet object.

  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: DEPLOYMENT_FLOW
      type: string
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: ENVIRONMENT
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
  steps:
    - name: wait-for-deploy
      image: docker.io/epamedp/tekton-cd-pipeline:0.1.4
      env:
        - name: ARGOCD_URL
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: url
        - name: ARGOCD_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: token
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        set -ex

        export ARGOCD_OPTS="--core=false --grpc-web"
        # the address of the Argo CD server without https:// prefix
        export ARGOCD_SERVER=${ARGOCD_URL#*//}

        pipeline=$(params.DEPLOYMENT_FLOW)
        stage=$(params.ENVIRONMENT)
        # quotes are important here
        new_tags='$(params.APPLICATIONS_PAYLOAD)'

        selector="app.edp.epam.com/stage=$(params.ENVIRONMENT),app.edp.epam.com/pipeline=$(params.DEPLOYMENT_FLOW)"

        patch=$(kubectl get applicationset $pipeline -o json | jq --argjson updates "$new_tags" --arg stage $stage '
          .spec.generators[0].list.elements |= map(
            if (.stage == $stage) and (.codebase | IN($updates | keys[])) then
              .imageTag = $updates[.codebase].imageTag
              # Update customValues field if customValues is true in payload
              | .customValues = if ($updates[.codebase].customValues == true) then true elif ($updates[.codebase].customValues == false) then false else .customValues end
            else
              .
            end
          )
        ')

        kubectl patch applicationset $pipeline --type=merge -p "$patch"

        # Delay to ensure the Argo CD Application controller has enough time to process the updated ApplicationSet resource.
        sleep 5

        argocd app list -l $selector

        argocd app sync -l $selector --prune --timeout 300
        # TODO: we build our custom argocd-cli that has fixed issue with argocd app wait
        argocd app wait -l $selector --health --sync

        printf "%s" "${new_tags}" > "$(results.APPLICATIONS_PAYLOAD.path)"
---
# Source: edp-tekton/templates/tasks/cd/run-quality-gate.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-quality-gate
spec:
  description: >-
    This task runs a quality gate. It can use a Kubeconfig secret to connect to a remote Kubernetes cluster.
  volumes:
    - name: kubeconfig
      secret:
        secretName: $(params.KUBECONFIG_SECRET_NAME)
        optional: true
  params:
    - description: >
        KRCI kind:CDPipeline name used for deployment. For example: mypipe,
        myfeature
      name: DEPLOYMENT_FLOW
      type: string
    - description: >
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE
        values. For example: dev, test, prod
      name: ENVIRONMENT
      type: string
    - name: BASE_IMAGE
      description: The base image for the task (different for buildtools).
      type: string
      default: ""
    - name: EXTRA_COMMANDS
      type: string
      description: Extra commands
      default: ""
    - name: KUBECONFIG_SECRET_NAME
      type: string
      description: The name of secret with Kubeconfig to connect to the remote cluster
      default: "in-cluster"
  steps:
    - name: run
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: kubeconfig
          mountPath: /workspace/source/kube
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        set -ex
        export KUBECONFIG="workspace/source/kube/config"
        $(params.EXTRA_COMMANDS)
---
# Source: edp-tekton/templates/tasks/cd/run-Ñleanup-gate.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-clean-gate
spec:
  description: >-
    This task runs a clean gate. It can use a Kubeconfig secret to connect to a remote Kubernetes cluster.
  volumes:
    - name: kubeconfig
      secret:
        secretName: $(params.KUBECONFIG_SECRET_NAME)
        optional: true
  params:
    - description: >
        KRCI kind:CDPipeline name used for deployment. For example: mypipe,
        myfeature
      name: DEPLOYMENT_FLOW
      type: string
    - description: >
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE
        values. For example: dev, test, prod
      name: ENVIRONMENT
      type: string
    - name: BASE_IMAGE
      description: The base image for the task (different for buildtools).
      type: string
      default: ""
    - name: EXTRA_COMMANDS
      type: string
      description: Extra commands
      default: ""
    - name: KUBECONFIG_SECRET_NAME
      type: string
      description: The name of secret with Kubeconfig to connect to the remote cluster
      default: "in-cluster"
  steps:
    - name: run
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: kubeconfig
          mountPath: /workspace/source/kube
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        set -ex
        export KUBECONFIG="workspace/source/kube/config"
        $(params.EXTRA_COMMANDS)
---
# Source: edp-tekton/templates/tasks/cd/sync-app.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sync-app
spec:
  description: |
    This task is used to deploy Codebases across specific Environment using ApplicationSet object.

  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: DEPLOYMENT_FLOW
      type: string
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: ENVIRONMENT
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
      type: string
  results:
    - description: APPLICATIONS_PAYLOAD
      name: APPLICATIONS_PAYLOAD
      type: string
  steps:
    - name: update-argo-appset
      image: docker.io/epamedp/tekton-cd-pipeline:0.1.4
      env:
        - name: ARGOCD_URL
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: url
        - name: ARGOCD_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: token
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        set -ex

        export ARGOCD_OPTS="--core=false --grpc-web"
        # the address of the Argo CD server without https:// prefix
        export ARGOCD_SERVER=${ARGOCD_URL#*//}

        pipeline=$(params.DEPLOYMENT_FLOW)
        stage=$(params.ENVIRONMENT)
        # quotes are important here
        new_tags='$(params.APPLICATIONS_PAYLOAD)'

        selector="app.edp.epam.com/stage=$(params.ENVIRONMENT),app.edp.epam.com/pipeline=$(params.DEPLOYMENT_FLOW)"

        patch=$(kubectl get applicationset $pipeline -o json | jq --argjson updates "$new_tags" --arg stage $stage '
          .spec.generators[0].list.elements |= map(
            if (.stage == $stage) and (.codebase | IN($updates | keys[])) then
              .imageTag = $updates[.codebase].imageTag
              # Update customValues field if customValues is true in payload
              | .customValues = if ($updates[.codebase].customValues == true) then true elif ($updates[.codebase].customValues == false) then false else .customValues end
            else
              .
            end
          )
        ')

        kubectl patch applicationset $pipeline --type=merge -p "$patch"

        # Delay to ensure the Argo CD Application controller has enough time to process the updated ApplicationSet resource.
        sleep 5

    - name: argocd-diff
      image: docker.io/bitnamilegacy/kubectl:1.25.4
      env:
        - name: ARGOCD_URL
          valueFrom:
            secretKeyRef:
              name: ci-argocd
              key: url
        - name: NAMESPACE
          value: default
        - name: APPLICATIONS_PAYLOAD
          value: $(params.APPLICATIONS_PAYLOAD)
        - name: DEPLOYMENT_FLOW
          value: $(params.DEPLOYMENT_FLOW)
        - name: ENVIRONMENT
          value: $(params.ENVIRONMENT)
      envFrom:
        - configMapRef:
            name: $(params.DEPLOYMENT_FLOW)-$(params.ENVIRONMENT)
      script: |
        #!/usr/bin/env bash
        set -e

        apps=($(echo $APPLICATIONS_PAYLOAD | jq -r 'keys[]'))

        for app in "${apps[@]}"; do
          echo "ArgoCD diff for $app application:"
          echo "${ARGOCD_URL}/applications/${NAMESPACE}/${DEPLOYMENT_FLOW}-${ENVIRONMENT}-$app"
        done
---
# Source: edp-tekton/templates/tasks/cdxgen.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: cdxgen
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/displayName: Dep-Analysis
    tekton.dev/platforms: linux/amd64
spec:
  description: >-
   This task generates a CycloneDX Software Bill of Materials (SBOM) and uploads it to Dependency Track for analysis and tracking of project dependencies.

  workspaces:
    - name: source
  params:
    - default: ''
      description: That is the name of the project that will be updated/created on the dependency track side
      name: PROJECT_NAME
      type: string
    - name: ci-dependency-track
      type: string
      description: Name of the secret holding the ci-dependency-track api token
      default: ci-dependency-track
  steps:
    - env:
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: token
        - name: DEPTRACK_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: url
        - name: PROJECT_NAME
          value: $(params.PROJECT_NAME)
      image: >-
        ghcr.io/cyclonedx/cdxgen:v9.6.0@sha256:ea01324872d2c21b024264a2224d761ab63851b9cc4722903b5e74be56ca6fa6
      name: cdxgen
      computeResources: {}
      script: >
        #!/usr/bin/env sh

        set -e

        set +x

        /opt/cdxgen/bin/cdxgen.js --api-key=$API_TOKEN --server-url=$DEPTRACK_URL --project-name=$PROJECT_NAME
      workingDir: $(workspaces.source.path)
---
# Source: edp-tekton/templates/tasks/check-helm-chart-name.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: check-helm-chart-name
spec:
  description: >-
   This task checks if the name specified in the Helm chart's `Chart.yaml` matches the provided `CODEBASE_NAME`.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: codebase_name
      type: string
    - name: chart_dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: check-helm-chart-name
      env:
        - name: CODEBASE_NAME
          value: $(params.codebase_name)
        - name: CHART_DIR
          value: $(params.chart_dir)
      image: docker.io/alpine:3.18.9
      script: |
        #!/bin/sh
        # Extract the chart name from the Chart.yaml
        CHART_NAME=$(awk '/^name:/ {print $2}' ${CHART_DIR}/Chart.yaml)

        # Compare with CODEBASE_NAME
        if [ "$CHART_NAME" == "$CODEBASE_NAME" ]; then
            echo "The name in Chart.yaml matches the CODEBASE_NAME."
        else
            echo "The name in Chart.yaml does not match the CODEBASE_NAME."
            exit 1
        fi

      workingDir: $(workspaces.source.path)
---
# Source: edp-tekton/templates/tasks/codenarc.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: codenarc
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: CodeNarc
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task can be used to run a Gradle build and a Groovy CodeNarc review.
    Download the output of the 'codenarc-report' step as logs from Tekton
    and save it as 'html'.
    Open the 'html' file in a browser to see the CodeNarc report.

  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  volumes:
    - name: settings-codenarc
      configMap:
        name: custom-codenarc-settings
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: docker.io/gradle:7.6.5-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: EXTRA_ARGS
      description: Extra arguments to add to the gradle build
      default: |
        -Dorg.gradle.internal.publish.checksums.insecure=true \
        publish
  steps:
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-codenarc
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_ARGS)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: codenarc-report
      image: docker.io/alpine:3.18.9
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        cat /workspace/source/build/reports/codenarc/main.html
---
# Source: edp-tekton/templates/tasks/commit-validate.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/displayName: Commit-Validate
    tekton.dev/platforms: linux/amd64
  name: commit-validate
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
   This task validates a commit message against a specified regex pattern and checks that each line does not exceed a maximum length.
  params:
    - name: COMMIT_MESSAGE
      description: "Commit message"
    - name: COMMIT_MESSAGE_PATTERN
      description: "Pattern to validate a commit message"
    - name: BASE_IMAGE
      description: "The base image for the task."
      default: "docker.io/python:3.10.8-alpine3.16"
    - name: MAX_LINE_LENGTH
      description: "Maximum length of each line in the commit message."
      default: "80"
  steps:
    - image: $(params.BASE_IMAGE)
      name: commit-validate
      env:
        - name: COMMIT_MESSAGE_PATTERN
          value: $(params.COMMIT_MESSAGE_PATTERN)
        - name: COMMIT_MESSAGE
          value: $(params.COMMIT_MESSAGE)
        - name: MAX_LINE_LENGTH
          value: $(params.MAX_LINE_LENGTH)
      script: |
        #!/usr/bin/env python

        import os
        import sys
        import re

        commit_message_pattern = os.getenv("COMMIT_MESSAGE_PATTERN")

        if not commit_message_pattern:
            print("[TEKTON] Pattern to validate commit message is empty")
            sys.exit(1)

        commit_message = os.getenv("COMMIT_MESSAGE")

        print("[TEKTON] Pattern to validate commit message: " +
        commit_message_pattern)

        print("[TEKTON] Commit message to validate has been fetched:\n" +
        commit_message)

        # Extract the first line of the commit message

        first_line = commit_message.split('\n', 1)[0]


        # Apply regex validation to the first line only

        result = re.match(commit_message_pattern, first_line)

        if result is None:
            print("[TEKTON] Commit message is invalid. The required pattern is " + commit_message_pattern)
            sys.exit(1)

        max_line_length = int(os.getenv("MAX_LINE_LENGTH"))

        lines = commit_message.split('\n')

        for line in lines:
            if len(line) > max_line_length:
                print(f"[TEKTON] A line in the commit message is too long. Each line should be no longer than {max_line_length} characters.")
                sys.exit(1)
---
# Source: edp-tekton/templates/tasks/create-ecr-repository.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-ecr-repository
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Init ECR repository"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
   This task creates an Amazon ECR repository if it doesn't already exist, based on the provided repository name and AWS region configuration.
  params:
    - name: REPO_NAME
      description: "The name of the ecr repository where we are going to push the image"
    - name: krci-config
      type: string
      description: "This configmap holds aws_region parameter"
      default: krci-config
  steps:
    - name: init-repository
      image: docker.io/amazon/aws-cli:2.7.35
      
      env:
        - name: REPO_NAME
          value: "$(params.REPO_NAME)"
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: "$(params.krci-config)"
              key: 'aws_region'
      command: ["/bin/sh"]
      args:
        - "-c"
        - |
          ECR_REPO_NAME=$(echo "${REPO_NAME}" | cut -d'/' -f2-)
          aws ecr describe-repositories --repository-names "$ECR_REPO_NAME" || aws ecr create-repository --repository-name "$ECR_REPO_NAME"
---
# Source: edp-tekton/templates/tasks/dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: dotnet
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: DotNet
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task builds a .NET project with integration for Nexus and SonarQube, allowing for custom build commands and using a specified NuGet configuration.

  workspaces:
    - name: source
      description: The workspace consisting of the dotnet project.
  volumes:
    - name: settings-nuget
      configMap:
        name: custom-nuget-settings
  params:
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
    - name: PROJECT_DIR
      description: The directory containing source code.
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: EXTRA_COMMANDS
      type: string
  steps:
    - name: dotnet
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)

      volumeMounts:
        - name: settings-nuget
          mountPath: $(workspaces.source.path)/$(params.PROJECT_DIR)/nuget.config
          subPath: nuget.config

      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        #!/usr/bin/env sh
        set -e
        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/ecr-to-docker.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ecr-to-docker
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Copy
    tekton.dev/tags: image-copy
    tekton.dev/displayName: "Push ECR images to DockerHUB"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task copies images from ECR to DockerHUB.
    It must be used after kaniko-build task.
    It is necessary to add a Service Account in a Pipeline for this task to run
    since it uses AWS ECR authentication.
  params:
    - name: ECR_LOGIN
      type: string
      default: '/workspace/ecr_login_pass'
    - name: ECR_USER
      type: string
      default: 'AWS'
    - name: CODEBASE_NAME
      type: string
    - name: IMAGE_TAG
      type: string
    - name: DOCKERHUB_HOST
      type: string
      default: 'index.docker.io'
    - name: dockerhub-credentials
      type: string
      description: secret holding dockerhub login token
      default: dockerhub-credentials
    - name: krci-config
      type: string
      description: this configmap holds aws_region parameter
      default: krci-config
  steps:
    - image: docker.io/amazon/aws-cli:2.7.35
      name: get-ecr-pass
      computeResources: {}
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: AWS_REGION
          valueFrom:
            configMapKeyRef:
              name: "$(params.krci-config)"
              key: 'aws_region'
      script: |
        aws ecr get-login-password --region "${AWS_REGION}" > "${ECR_LOGIN}"
        ls -l "${ECR_LOGIN}"
    - name: copy-image
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: ECR_USER
          value: "$(params.ECR_USER)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: IMAGE_TAG
          value: "$(params.IMAGE_TAG)"
        - name: DOCKERHUB_HOST
          value: "$(params.DOCKERHUB_HOST)"
        - name: DOCKERHUB_USERNAME
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'username'
        - name: DOCKERHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'accesstoken'
        - name: DOCKERHUB_ACCOUNT
          valueFrom:
            secretKeyRef:
              name: "$(params.dockerhub-credentials)"
              key: 'account'
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
      image: gcr.io/go-containerregistry/crane/debug:c195f151efe3369874c72662cd69ad43ee485128
      script: |
        #!/busybox/sh
        DOCKERHUB_IMAGE_TAGGED="${DOCKERHUB_HOST}/${DOCKERHUB_ACCOUNT}/${CODEBASE_NAME}:${IMAGE_TAG}"
        echo "${DOCKERHUB_TOKEN}" | crane auth login "${DOCKERHUB_HOST}" -u "${DOCKERHUB_USERNAME}" --password-stdin
        if crane manifest "${DOCKERHUB_IMAGE_TAGGED}"; then
            echo " [INFO] Image "${DOCKERHUB_IMAGE_TAGGED}" already exists in Docker Hub"
            exit 1
        else
            cat "${ECR_LOGIN}" | crane auth login "${CONTAINER_REGISTRY_URL}" -u "${ECR_USER}" --password-stdin
            crane cp "${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG}" "${DOCKERHUB_IMAGE_TAGGED}"
        fi
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-c.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-c
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run npm goals on a project
    where package.json is present and has some pre-defined
    npm scripts.
  workspaces:
    - name: source
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The directory containing source code.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/epamedp/tekton-python-make:0.1.7"
      description: C base image
    - name: EXTRA_COMMANDS_BUILD
      type: string
    - name: EXTRA_COMMANDS_TEST
      type: string
  steps:
    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        set -ex

        $(params.EXTRA_COMMANDS_BUILD)
    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        set -ex

        $(params.EXTRA_COMMANDS_TEST)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-dotnet
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: DotNet
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
   This task builds and tests a .NET project using a specified base image, with support for caching dependencies and running coverage analysis on test projects.

  workspaces:
    - name: source
      description: The workspace consisting of the dotnet project.
  params:
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "mcr.microsoft.com/dotnet/sdk:3.1.423-alpine3.16"
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "source"
    - name: DOTNET_CACHE
      type: string
      description: name of the secret for the Sonarqube integration
      default: "/workspace/source/cache"
  steps:
    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: DOTNET_CACHE
          value: $(params.DOTNET_CACHE)
      script: |
        #!/usr/bin/env sh
        set -e
        dotnet restore --packages ${DOTNET_CACHE}
        dotnet build
    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: DOTNET_CACHE
          value: $(params.DOTNET_CACHE)
      script: |
        #!/usr/bin/env sh
        set -e
        dotnet restore --packages ${DOTNET_CACHE}
        ls *Tests*/*.csproj | while read -r file;
            do dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover "${file}";
        done
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: Gradle
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
   This task compiles, tests, and builds a Gradle project with configurable integration for Nexus, using custom Gradle settings and caching.
  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: docker.io/gradle:7.6.5-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "source"
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: GRADLE_USER_CACHE
      description: Gradle user cache directory
      default: /workspace/source/cache
  steps:
    - name: compile
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            clean \
            compileJava \
            -x test
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: test
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            test \
            jacocoTestReport
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
    - name: build
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
            build -x test
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(params.GRADLE_USER_CACHE)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-npm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-npm
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run npm goals on a project
    where package.json is present and has some pre-defined
    npm scripts.
  workspaces:
    - name: source
  volumes:
    - name: settings-npm
      configMap:
        name: custom-npm-settings
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The path where package.json of the project is defined.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/library/node:22.15.0-alpine3.21"
      description: The node image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: CACHE_DIR
      default: "/workspace/source/cache"
      description: The path to the cache directory.
  steps:
    - name: init
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)

      volumeMounts:
        - name: settings-npm
          mountPath: /var/configmap

      env:
        - name: HOME
          value: "$(workspaces.source.path)/"
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: NPM_CACHE_DIR
          value: $(params.CACHE_DIR)
      script: |
        #!/usr/bin/env sh
        set -e

        export upBase64=$(echo -n ${CI_USERNAME}:${CI_PASSWORD} | base64)
        export npm_config_userconfig=/var/configmap/.npmrc-ci
        export NEXUS_HOST="//${NEXUS_HOST_URL#*://}"
        npm cache verify --cache $NPM_CACHE_DIR
        npm ci

    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        npm run build
      

    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        npm run test:coverage
      
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-pnpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: edp-pnpm
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run pnpm goals on a project
    where package.json is present and has some pre-defined
    pnpm scripts.
  workspaces:
    - name: source
  volumes:
    - name: settings-npm
      configMap:
        name: custom-npm-settings
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The path where package.json of the project is defined.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/library/node:22.15.0-alpine3.21"
      description: The node image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: CACHE_DIR
      default: "/workspace/source/cache"
      description: The path to the cache directory.
  steps:
    - name: init
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)

      volumeMounts:
        - name: settings-npm
          mountPath: /var/configmap

      env:
        - name: HOME
          value: "$(workspaces.source.path)/"
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: NPM_CACHE_DIR
          value: $(params.CACHE_DIR)
      script: |
        #!/usr/bin/env sh
        set -e

        corepack enable
        pnpm config set store-dir "$(params.CACHE_DIR)"
        pnpm i

    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        corepack enable

        pnpm run build
      

    - name: test
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        corepack enable

        pnpm run lint
      
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/edp-rpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: rpm-build
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task builds an RPM package from source code using a specified RPM build image. It includes steps for linting, building, and publishing the RPM artifact to a Nexus repository.
    The task is customizable through parameters for context paths, image versions, additional commands, and Nexus integration secrets.
  workspaces:
    - name: source
  params:
    - name: PATH_CONTEXT
      type: string
      default: ""
      description: The path to the context.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/epamedp/tekton-rpm:0.1.4"
      description: The rpm image. Should contain all necessary tools to build rpm.
    - name: ci-nexus
      type: string
      description: Name of the secret for the Nexus integration
      default: ci-nexus
    - name: numeric_version
      type: string
      description: Current numeric version of application
      default: ""
    - name: suffix
      type: string
      description: Current build version of application
      default: "1"
    - name: EXTRA_LINT_COMMAND
      type: string
      description: Run rpm lint command
    - name: EXTRA_BUILD_COMMAND
      type: string
      description: Run rpm build command
    - name: EXTRA_PUSH_COMMAND
      type: string
      description: Publish rpm artifact
  steps:
    - name: lint
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        set -e

        $(params.EXTRA_LINT_COMMAND)

    - name: build
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: NUMERIC_VERSION
          value: $(params.numeric_version)
        - name: SUFFIX
          value: $(params.suffix)
      script: |
        set -e

        $(params.EXTRA_BUILD_COMMAND)

    - name: publish
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: NUMERIC_VERSION
          value: $(params.numeric_version)
        - name: SUFFIX
          value: $(params.suffix)
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        set -e

        $(params.EXTRA_PUSH_COMMAND)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/gerrit-ssh-cmd.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gerrit-ssh-cmd
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Gerrit Tools
    tekton.dev/tags: ssh, gerrit api
    tekton.dev/displayName: "gerrit api over ssh"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The following task can be used to run gerrit votes using ssh.

    The following task takes gerrit host and required credentials as input along
    with the command and run it on gerrit server.
  workspaces:
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before ssh commands are executed.
  params:
    - name: GERRIT_HOST
      type: string
      description: Remote host to connect
      default: "gerrit"
    - name: USERNAME
      type: string
      description: SSH username
      default: "edp-ci"
    - name: GERRIT_PORT
      type: string
      description: SSH port, default is 22
      default: "22"
    - name: SSH_GERRIT_COMMAND
      type: string
      description: The gerrit command you want to run over ssh
    - name: ERR_EXIT_CODE
      type: string
      description: Define Error exit code for task. By default - 1. In case of skip set 0
      default: "1"
    - name: userHome
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"
  steps:
    - name: ssh
      image: 'docker.io/epamedp/tekton-openssh-client:0.1.5'
      env:
        - name: GERRIT_HOST
          value: "$(params.GERRIT_HOST)"
        - name: GERRIT_PORT
          value: "$(params.GERRIT_PORT)"
        - name: USERNAME
          value: "$(params.USERNAME)"
        - name: SSH_GERRIT_COMMAND
          value: "$(params.SSH_GERRIT_COMMAND)"
        - name: PARAM_USER_HOME
          value: $(params.userHome)
        - name: ERR_EXIT_CODE
          value: $(params.ERR_EXIT_CODE)
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        ssh -o StrictHostKeyChecking=no -p ${GERRIT_PORT} ${USERNAME}@${GERRIT_HOST} gerrit ${SSH_GERRIT_COMMAND} || exit ${ERR_EXIT_CODE}
---
# Source: edp-tekton/templates/tasks/get-cache.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-cache
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "get-cache"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task is used to get the cache from the distribution server. It stores cache in the root of the workspace.
  workspaces:
    - name: cache
  params:
    - name: CACHE_NAME
      description: "Cache name (filename) to be downloaded from the cache server."
      type: string
    - name: BASE_IMAGE
      description: "Base image"
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
      type: string
  steps:
    - name: get-cache
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.cache.path)

      script: |
        #!/usr/bin/env sh
        set -ex
        set -o pipefail

        curl -fsI ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.zst || {
              echo "no cache found"
              exit 0
        }

        echo "Getting cache"
        curl -O ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.zst

        echo "Extracting cache archive"
        tar -x --zstd -f ${CACHE_NAME}.tar.zst
      env:
        - name: CACHE_SERVER_URL
          valueFrom:
            configMapKeyRef:
              name: tekton-cache
              key: url
              optional: true
        - name: CACHE_NAME
          value: "$(params.CACHE_NAME)"
      # TODO: We need to run this task as root because the workspace is owned by root.
      securityContext:
        runAsUser: 0

      computeResources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/GetVersion.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-default
spec:
  description: |
    This task generates a version number for the application based on the current timestamp and the branch name.
    The version number is used to tag the image and the codebase image stream.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: TIMESTAMP
      description: Current timestamp
    - name: NORMALIZED_VERSION
      description: Normalized version
  steps:
    - name: get-timestamp
      image: docker.io/alpine:3.18.9
      script: |
        ts=$(date "+%Y%m%d-%H%M%S")
        nts=$(date "+%Y%m%d.%H%M%S")
        echo "Current Timestamp: ${ts}"
        echo "Current Normalized Timestamp: ${nts}"
        echo ${ts} | tr -d "\n" | tee $(results.TIMESTAMP.path)
        echo ${nts} | tr -d "\n" | tee $(results.NORMALIZED_VERSION.path)

    - name: get-version
      image: docker.io/alpine:3.18.9
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
      script: |
        set -e

        # get current BUILD ID
        BUILD_ID=$(cat $(results.TIMESTAMP.path))

        BUILD_VERSION="${BUILD_ID}"
        VCS_TAG="${BRANCH_NAME}-${BUILD_VERSION}"
        NORMALIZED_BRANCH=$(printf '%s' "${BRANCH_NAME}" | sed 's/\//-/g')
        IS_TAG="${NORMALIZED_BRANCH}-${BUILD_VERSION}"
        NORMALIZED_VERSION="$(cat $(results.NORMALIZED_VERSION.path))"

        echo "Application version - ${BUILD_VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "Normalized Version - ${NORMALIZED_VERSION}"

        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
        printf "%s" "${BUILD_ID}" > "$(results.VERSION.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/GetVersionHelm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-helm-default
spec:
  description: >-
    This task retrieves the version from a Helm chart's `Chart.yaml` file and generates a VCS tag and IS tag based on the branch name and chart version.
  workspaces:
    - name: source
      description: The workspace consisting of csharp project.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
    - name: chart-dir
      type: string
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
  steps:
    - name: get-version
      image: docker.io/linuxserver/yq
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
        - name: CHART_DIR
          value: "$(params.chart-dir)"
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        BUILD_VERSION=$(grep -m 1 -oE 'version:[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)*' ${CHART_DIR}/Chart.yaml | awk '{print $2}')
        BUILD_VERSION=$(cat ${CHART_DIR}/Chart.yaml | yq -r ".version")

        VCS_TAG="${BRANCH_NAME}-${BUILD_VERSION}"
        IS_TAG="${BUILD_VERSION}"

        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "VERSION tag - ${BUILD_VERSION}"

        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/GetVersionRPM.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-rpm
spec:
  description: |
    This task generates a version number for the application based on the current timestamp and the branch name.
    The version number is used to tag the image and the codebase image stream.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: TIMESTAMP
      description: Current timestamp
    - name: NORMALIZED_VERSION
      description: Normalized version
  steps:
    - name: get-timestamp
      image: docker.io/alpine:3.18.9
      script: |
        ts=$(date "+%Y%m%d-%H%M%S")
        nts=$(date "+%Y%m%d.%H%M%S")
        echo "Current Timestamp: ${ts}"
        echo "Current Normalized Timestamp: ${nts}"
        echo ${ts} | tr -d "\n" | tee $(results.TIMESTAMP.path)
        echo ${nts} | tr -d "\n" | tee $(results.NORMALIZED_VERSION.path)

    - name: get-version
      image: docker.io/alpine/make:4.2.1
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        VERSION=$(make version)
        NORMALIZED_VERSION="$(cat $(results.NORMALIZED_VERSION.path))"
        VCS_TAG="${VERSION}-${NORMALIZED_VERSION}"
        IS_TAG="${VCS_TAG}"

        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "Normalized Version - ${NORMALIZED_VERSION}"

        printf "%s" "${VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberDotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-dotnet-default
spec:
  description: >-
    This task retrieves the version information for a .NET project, generates a build version and VCS tag based on the branch name and current timestamp.
  workspaces:
    - name: source
      description: The workspace consisting of dotnet project.
  params:
    - name: BRANCH_NAME
      type: string
      description: Branch name.
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: DEPLOYABLE_MODULE_DIR
    - name: TIMESTAMP
      description: Current timestamp
  steps:
    - name: get-timestamp
      image: docker.io/alpine:3.18.9
      script: |
        ts=$(date "+%Y%m%d-%H%M%S")
        echo "Current Timestamp: ${ts}"
        echo ${ts} | tr -d "\n" | tee $(results.TIMESTAMP.path)

    - name: get-version
      image: docker.io/alpine:3.18.9
      env:
        - name: BRANCH_NAME
          value: "$(params.BRANCH_NAME)"
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj' | xargs awk  -F '[><]' '/<DeployableModule>/ {print $3}')

        VERSION=$(find ${DEPLOYABLE_MODULE} -name '*.csproj' | xargs awk  -F '[><]' '/<Version>/ {print $3}' | tr '[:upper:]' '[:lower:]')

        # get current BUILD ID
        BUILD_ID=$(cat $(results.TIMESTAMP.path))

        BUILD_VERSION="${VERSION}-${BUILD_ID}"
        VCS_TAG="${BUILD_VERSION}"
        NORMALIZED_BRANCH=$(printf '%s' "${BRANCH_NAME}" | sed 's/\//-/g')
        IS_TAG="${BUILD_VERSION}"

        echo "Application version - ${BUILD_VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"

        printf "%s" "${BUILD_VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"

        DEPLOYABLE_MODULE_DIR="."

        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberGradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-gradle-default
spec:
  description: >-
    This task updates the version in a Gradle project's `build.gradle` file to the specified version.
  workspaces:
    - name: source
      description: The workspace consisting of gradle project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        sed -i "s/version = .*/version = \"${VERSION}\"/" build.gradle
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberNpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-npm-default
spec:
  description: >-
    This task updates the version in an npm project's `package.json` file to a new build version by appending a specified version suffix.
  workspaces:
    - name: source
      description: The workspace consisting of npm project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/library/node:22.15.0-alpine3.21"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/usr/bin/env sh
        set -ex

        NPM_VERSION=$(node -p "require('./package.json').version" | tr '[:upper:]' '[:lower:]')

        BUILD_VERSION="${NPM_VERSION}-${VERSION}"

        npm --no-git-tag-version version ${BUILD_VERSION}
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberPnpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-pnpm-default
spec:
  description: >-
    This task updates the version in an npm project's `package.json` file to a new build version by appending a specified version suffix.
  workspaces:
    - name: source
      description: The workspace consisting of npm project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/library/node:22.15.0-alpine3.21"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/usr/bin/env sh
        set -ex

        corepack enable

        NPM_VERSION=$(node -p "require('./package.json').version" | tr '[:upper:]' '[:lower:]')

        BUILD_VERSION="${NPM_VERSION}-${VERSION}"

        pnpm version ${BUILD_VERSION} --no-git-tag-version
---
# Source: edp-tekton/templates/tasks/getversion/defaulttype/UpdateBuildNumberPython.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-python-default
spec:
  description: >-
    This task updates the version in a Python project's `version/__init__.py` file to the specified version.
  workspaces:
    - name: source
      description: The workspace consisting of python project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/bin/sh
        set -ex

        sed -i 's/\(__version__\s*=\s*\).*/\1'\"${VERSION}\"'/' version/__init__.py
        cat version/__init__.py
---
# Source: edp-tekton/templates/tasks/getversion/edptype/GetVersionEDP.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-version-edp
spec:
  description: >-
    This task retrieves and updates the version information for a specified CodebaseBranch, generating the application version, VCS tag, build ID, and other version details.
  params:
    - name: CODEBASEBRANCH_NAME
      type: string
      description: "Codebasebranch name"
    - name: step_get_version_image
      description: "The base image for the task"
      default: "docker.io/bitnamilegacy/kubectl:1.25.4"
  results:
    - name: VERSION
      description: "Application version"
    - name: VCS_TAG
      description: "VCS tag"
    - name: IS_TAG
      description: "CodebaseImageStream tag"
    - name: BUILD_ID
      description: "Build id"
    - name: NUMERIC_VERSION
      description: "Numeric version"
    - name: SUFFIX
      description: "Version suffix"
    - name: BRANCH_VERSION
      description: "Branch version"
    - name: IS_RELEASE_BRANCH
    - name: DEPLOYABLE_MODULE_DIR
  steps:
    - name: get-version
      image: $(params.step_get_version_image)
      env:
        - name: CODEBASEBRANCH_NAME
          value: "$(params.CODEBASEBRANCH_NAME)"
      script: |
        #!/usr/bin/env bash
        set -e

        # replace '/' with '-'
        CODEBASEBRANCH_NAME=${CODEBASEBRANCH_NAME//\//-}
        # get current BUILD ID
        BUILD_ID=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.status.build})
        # and increment it
        BUILD_ID=$((BUILD_ID+1))
        # set new version
        kubectl patch codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} --subresource=status --type=merge -p "{\"status\": {\"build\": \"$BUILD_ID\"}}"

        IS_RELEASE_BRANCH=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.spec.release})

        # Get current version
        VERSION=$(kubectl get codebasebranches.v2.edp.epam.com ${CODEBASEBRANCH_NAME} -o txt --output=jsonpath={.spec.version})

        # Get current number version (eg 0.0.0)
        NUMERIC_VERSION=$(printf '%s' ${VERSION} | sed -nE 's/.*([0-9]+\.[0-9]+\.[0-9]+).*/\1/p')

        SUFFIX=$(echo "$VERSION" | sed -nE 's/^[0-9]+\.[0-9]+\.[0-9]+-//p')
        SUFFIX=${SUFFIX}.${BUILD_ID}

        # Replace slashes
        VERSION=$(printf '%s' ${VERSION} | sed 's/\//-/g')

        BRANCH_VERSION=${VERSION}
        VERSION="${VERSION}.${BUILD_ID}"
        VCS_TAG="build/${VERSION}"
        IS_TAG=${VERSION}
        DEPLOYABLE_MODULE_DIR="."

        if [ "${IS_RELEASE_BRANCH}" = "true" ] ; then
            VERSION="${BRANCH_VERSION}.${BUILD_ID}"
        else
            VERSION="${BRANCH_VERSION}"
        fi

        echo "Application version - ${VERSION}"
        echo "VCS tag - ${VCS_TAG}"
        echo "IS tag - ${IS_TAG}"
        echo "Build id - ${BUILD_ID}"
        echo "Branch version - ${BRANCH_VERSION}"
        echo "Numeric version - ${NUMERIC_VERSION}"
        echo "Suffix - ${SUFFIX}"


        printf "%s" "${VERSION}" > "$(results.VERSION.path)"
        printf "%s" "${VCS_TAG}" > "$(results.VCS_TAG.path)"
        printf "%s" "${IS_TAG}" > "$(results.IS_TAG.path)"
        printf "%s" "${BUILD_ID}" > "$(results.BUILD_ID.path)"
        printf "%s" "${BRANCH_VERSION}" > "$(results.BRANCH_VERSION.path)"
        printf "%s" "${IS_RELEASE_BRANCH}" > "$(results.IS_RELEASE_BRANCH.path)"
        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
        printf "%s" "${NUMERIC_VERSION}" > "$(results.NUMERIC_VERSION.path)"
        printf "%s" "${SUFFIX}" > "$(results.SUFFIX.path)"
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberCsharp.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-csharp
spec:
  description: >-
    This task updates the version in a C# project's `.csproj` file to the specified version.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj')
        sed -i "s#\(<Version>\).*\(</Version>\)#\1${VERSION}\2#" ${DEPLOYABLE_MODULE}
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberDotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-dotnet
spec:
  description: >-
    This task updates the version in a .NET project's `.csproj` file to the specified version.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(find ./ -name '*.csproj' | xargs awk  -F '[><]' '/<DeployableModule>/ {print $3}')
        sed -i "s#\(<Version>\).*\(</Version>\)#\1${VERSION}\2#" ${DEPLOYABLE_MODULE}/${DEPLOYABLE_MODULE}.csproj
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberGradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-gradle
spec:
  description: >-
    This task updates the version in a Gradle project's `build.gradle` file based on the branch version, build ID, and release branch status.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BRANCH_VERSION
      type: string
      description: "Branch version"
    - name: BUILD_ID
      type: string
      description: "Version"
    - name: IS_RELEASE_BRANCH
      type: string
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: BRANCH_VERSION
          value: "$(params.BRANCH_VERSION)"
        - name: BUILD_ID
          value: "$(params.BUILD_ID)"
      script: |
        set -ex

        if [ "${IS_RELEASE_BRANCH}" = "true" ] ; then
            sed -i "s/version = .*/version = \"${BRANCH_VERSION}-${BUILD_ID}\"/" build.gradle
        else
            sed -i "s/^version = .*/version = \"${BRANCH_VERSION}\"/" build.gradle
        fi
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberHelmChart.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-helm-chart
spec:
  description: >-
    This task updates the version number in a Helm chart's `Chart.yaml` file to the specified version.
  workspaces:
    - name: source
      description: The workspace consisting of helm chart project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
        - name: CHART_DIR
          value: $(params.CHART_DIR)
      script: |
        #!/bin/sh
        set -ex

        sed -i "s/^version: .*$/version: ${VERSION}/" ${CHART_DIR}/Chart.yaml
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberNpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-npm
spec:
  description: >-
    This task updates the build number in an npm project by setting a new version in the `package.json` file using the provided branch version and build ID.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BRANCH_VERSION
      type: string
      description: "Branch version"
    - name: BUILD_ID
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/library/node:22.15.0-alpine3.21"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: BRANCH_VERSION
          value: "$(params.BRANCH_VERSION)"
        - name: BUILD_ID
          value: "$(params.BUILD_ID)"
      script: |
        #!/usr/bin/env sh
        set -ex

        npm --no-git-tag-version version ${BRANCH_VERSION}-${BUILD_ID}
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberPnpm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-pnpm
spec:
  description: >-
    This task updates the build number in an pnpm project by setting a new version in the `package.json` file using the provided branch version and build ID.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BRANCH_VERSION
      type: string
      description: "Branch version"
    - name: BUILD_ID
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/library/node:22.15.0-alpine3.21"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: BRANCH_VERSION
          value: "$(params.BRANCH_VERSION)"
        - name: BUILD_ID
          value: "$(params.BUILD_ID)"
      script: |
        #!/usr/bin/env sh
        set -ex

        corepack enable

        pnpm version ${BRANCH_VERSION}-${BUILD_ID} --no-git-tag-version
---
# Source: edp-tekton/templates/tasks/getversion/edptype/UpdateBuildNumberPython.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-build-number-python
spec:
  description: >-
    This task updates the build number in a Python project by modifying the version in the `version/__init__.py` file, provided the version does not contain "snapshot".
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: VERSION
      type: string
      description: "Version"
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  steps:
    - name: update-build-number
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/bin/sh
        set -ex

        VERSION_LOWER_CASE=$(echo "${VERSION}" | tr '[:upper:]' '[:lower:]')
        if [[ ! ${VERSION_LOWER_CASE} == *"snapshot"* ]]; then
            sed -i 's/\(__version__\s*=\s*\).*/\1'\"${VERSION}\"'/' version/__init__.py
        fi
        cat version/__init__.py
---
# Source: edp-tekton/templates/tasks/git-cli.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-cli
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/pipelines.minVersion: "0.21.0"
    tekton.dev/categories: Git
    tekton.dev/tags: git
    tekton.dev/displayName: "git cli"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to perform git operations.

    Git command that needs to be run can be passed as a script to
    the task. This task needs authentication to git in order to push
    after the git operation.
  workspaces:
    - name: source
      description: A workspace that contains the fetched git repository.
    - name: input
      optional: true
      description: |
        An optional workspace that contains the files that need to be added to git. You can
        access the workspace from your script using `$(workspaces.input.path)`, for instance:

          cp $(workspaces.input.path)/file_that_i_want .
          git add file_that_i_want
          # etc
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types.
    - name: basic-auth
      optional: true
      description: |
        A Workspace containing a .gitconfig and .git-credentials file. These
        will be copied to the user's home before any git commands are run. Any
        other files in this Workspace are ignored. It is strongly recommended
        to use ssh-directory over basic-auth whenever possible and to bind a
        Secret to this Workspace over other volume types.
  params:
    - name: BASE_IMAGE
      description: |
        The base image for the task.
      type: string
      default: docker.io/alpine/git:v2.26.2 #@sha256:23618034b0be9205d9cc0846eb711b12ba4c9b468efdd8a59aac1d7b1a23363f
    - name: GIT_USER_NAME
      type: string
      description: |
        Git user name for performing git operation.
      default: ""
    - name: GIT_USER_EMAIL
      type: string
      description: |
        Git user email for performing git operation.
      default: ""
    - name: GIT_SCRIPT
      description: The git script to run.
      type: string
      default: |
        git help
    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"
    - name: VERBOSE
      description: Log the commands that are executed during `git-clone`'s operation.
      type: string
      default: "true"
  results:
    - name: commit
      description: The precise commit SHA after the git operation.
  steps:
    - name: git
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: GIT_SSH_COMMAND
          value: ssh -i $(params.USER_HOME)/.ssh/id_rsa -o StrictHostKeyChecking=no
        - name: HOME
          value: $(params.USER_HOME)
        - name: PARAM_VERBOSE
          value: $(params.VERBOSE)
        - name: PARAM_USER_HOME
          value: $(params.USER_HOME)
        - name: WORKSPACE_OUTPUT_PATH
          value: $(workspaces.output.path)
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
          value: $(workspaces.basic-auth.bound)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
          value: $(workspaces.basic-auth.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${PARAM_VERBOSE}" = "true" ] ; then
          set -x
        fi

        if [ "${WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND}" = "true" ] ; then
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.git-credentials" "${PARAM_USER_HOME}/.git-credentials"
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.gitconfig" "${PARAM_USER_HOME}/.gitconfig"
          chmod 400 "${PARAM_USER_HOME}/.git-credentials"
          chmod 400 "${PARAM_USER_HOME}/.gitconfig"
        fi

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          echo "" >> "${PARAM_USER_HOME}"/.ssh/id_rsa
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        # Setting up the config for the git.
        git config --global user.email "$(params.GIT_USER_EMAIL)"
        git config --global user.name "$(params.GIT_USER_NAME)"

        # remove git-hooks. We potentially might have hooks installed by components, for example - pre-commit
        # this leads to the situation when we have a hook and are not able to perform git command
        rm -rf .git/hooks

        eval '$(params.GIT_SCRIPT)'

        RESULT_SHA="$(git rev-parse HEAD | tr -d '\n')"
        EXIT_CODE="$?"
        if [ "$EXIT_CODE" != 0 ]
        then
          exit $EXIT_CODE
        fi
        # Make sure we don't add a trailing newline to the result!
        printf "%s" "$RESULT_SHA" > "$(results.commit.path)"
---
# Source: edp-tekton/templates/tasks/git-clone.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone
  labels:
    app.kubernetes.io/based-on: "0.7"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.29.0"
    tekton.dev/categories: Git
    tekton.dev/tags: git
    tekton.dev/displayName: "git clone"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le,linux/arm64"
spec:
  description: >-
    These Tasks are Git tasks to work with repositories used by other tasks
    in your Pipeline.

    The git-clone Task will clone a repo from the provided url into the
    output Workspace. By default the repo will be cloned into the root of
    your Workspace. You can clone into a subdirectory by setting this Task's
    subdirectory param. This Task also supports sparse checkouts. To perform
    a sparse checkout, pass a list of comma separated directory patterns to
    this Task's sparseCheckoutDirectories param.
  workspaces:
    - name: output
      description: The git repo will be cloned onto the volume backing this Workspace.
    - name: ssh-directory
      optional: true
      description: |
        A .ssh directory with private key, known_hosts, config, etc. Copied to
        the user's home before git commands are executed. Used to authenticate
        with the git remote when performing the clone. Binding a Secret to this
        Workspace is strongly recommended over other volume types.
    - name: basic-auth
      optional: true
      description: |
        A Workspace containing a .gitconfig and .git-credentials file. These
        will be copied to the user's home before any git commands are run. Any
        other files in this Workspace are ignored. It is strongly recommended
        to use ssh-directory over basic-auth whenever possible and to bind a
        Secret to this Workspace over other volume types.
    - name: ssl-ca-directory
      optional: true
      description: |
        A workspace containing CA certificates, this will be used by Git to
        verify the peer with when fetching or pushing over HTTPS.
  params:
    - name: url
      description: Repository URL to clone from.
      type: string
    - name: revision
      description: Revision to checkout. (branch, tag, sha, ref, etc...)
      type: string
      default: ""
    - name: refspec
      description: Refspec to fetch before checking out revision.
      default: ""
    - name: submodules
      description: Initialize and fetch git submodules.
      type: string
      default: "true"
    - name: depth
      description: Perform a shallow clone, fetching only the most recent N commits.
      type: string
      default: "2"
    - name: sslVerify
      description: Set the `http.sslVerify` global git config. Setting this to `false` is not advised unless you are sure that you trust your git remote.
      type: string
      default: "true"
    - name: crtFileName
      description: file name of mounted crt using ssl-ca-directory workspace. default value is ca-bundle.crt.
      type: string
      default: "ca-bundle.crt"
    - name: subdirectory
      description: Subdirectory inside the `output` Workspace to clone the repo into.
      type: string
      default: ""
    - name: sparseCheckoutDirectories
      description: Define the directory patterns to match or exclude when performing a sparse checkout.
      type: string
      default: ""
    - name: deleteExisting
      description: Clean out the contents of the destination directory if it already exists before cloning.
      type: string
      default: "true"
    - name: httpProxy
      description: HTTP proxy server for non-SSL requests.
      type: string
      default: ""
    - name: httpsProxy
      description: HTTPS proxy server for SSL requests.
      type: string
      default: ""
    - name: noProxy
      description: Opt out of proxying HTTP/HTTPS requests.
      type: string
      default: ""
    - name: verbose
      description: Log the commands that are executed during `git-clone`'s operation.
      type: string
      default: "true"
    - name: gitInitImage
      description: The image providing the git-init binary that this Task runs.
      type: string
      default: "ghcr.io/tektoncd/github.com/tektoncd/pipeline/cmd/git-init:v0.29.0"
    - name: userHome
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user or have overridden
        the gitInitImage param with an image containing custom user configuration.
      type: string
      default: "/tekton/home"
  results:
    - name: commit
      description: The precise commit SHA that was fetched by this Task.
    - name: url
      description: The precise URL that was fetched by this Task.
  steps:
    - name: clone
      image: "$(params.gitInitImage)"
      env:
      - name: HOME
        value: "$(params.userHome)"
      - name: PARAM_URL
        value: $(params.url)
      - name: PARAM_REVISION
        value: $(params.revision)
      - name: PARAM_REFSPEC
        value: $(params.refspec)
      - name: PARAM_SUBMODULES
        value: $(params.submodules)
      - name: PARAM_DEPTH
        value: $(params.depth)
      - name: PARAM_SSL_VERIFY
        value: $(params.sslVerify)
      - name: PARAM_CRT_FILENAME
        value: $(params.crtFileName)
      - name: PARAM_SUBDIRECTORY
        value: $(params.subdirectory)
      - name: PARAM_DELETE_EXISTING
        value: $(params.deleteExisting)
      - name: PARAM_HTTP_PROXY
        value: $(params.httpProxy)
      - name: PARAM_HTTPS_PROXY
        value: $(params.httpsProxy)
      - name: PARAM_NO_PROXY
        value: $(params.noProxy)
      - name: PARAM_VERBOSE
        value: $(params.verbose)
      - name: PARAM_SPARSE_CHECKOUT_DIRECTORIES
        value: $(params.sparseCheckoutDirectories)
      - name: PARAM_USER_HOME
        value: $(params.userHome)
      - name: WORKSPACE_OUTPUT_PATH
        value: $(workspaces.output.path)
      - name: WORKSPACE_SSH_DIRECTORY_BOUND
        value: $(workspaces.ssh-directory.bound)
      - name: WORKSPACE_SSH_DIRECTORY_PATH
        value: $(workspaces.ssh-directory.path)
      - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
        value: $(workspaces.basic-auth.bound)
      - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
        value: $(workspaces.basic-auth.path)
      - name: WORKSPACE_SSL_CA_DIRECTORY_BOUND
        value: $(workspaces.ssl-ca-directory.bound)
      - name: WORKSPACE_SSL_CA_DIRECTORY_PATH
        value: $(workspaces.ssl-ca-directory.path)
      script: |
        #!/usr/bin/env sh
        set -eu

        if [ "${PARAM_VERBOSE}" = "true" ] ; then
          set -x
        fi


        if [ "${WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND}" = "true" ] ; then
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.git-credentials" "${PARAM_USER_HOME}/.git-credentials"
          cp "${WORKSPACE_BASIC_AUTH_DIRECTORY_PATH}/.gitconfig" "${PARAM_USER_HOME}/.gitconfig"
          chmod 400 "${PARAM_USER_HOME}/.git-credentials"
          chmod 400 "${PARAM_USER_HOME}/.gitconfig"
        fi

        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" "${PARAM_USER_HOME}"/.ssh
          chmod 700 "${PARAM_USER_HOME}"/.ssh
          echo "" >> "${PARAM_USER_HOME}"/.ssh/id_rsa
          chmod -R 400 "${PARAM_USER_HOME}"/.ssh/*
        fi

        if [ "${WORKSPACE_SSL_CA_DIRECTORY_BOUND}" = "true" ] ; then
           export GIT_SSL_CAPATH="${WORKSPACE_SSL_CA_DIRECTORY_PATH}"
           if [ "${PARAM_CRT_FILENAME}" != "" ] ; then
              export GIT_SSL_CAINFO="${WORKSPACE_SSL_CA_DIRECTORY_PATH}/${PARAM_CRT_FILENAME}"
           fi
        fi
        CHECKOUT_DIR="${WORKSPACE_OUTPUT_PATH}/${PARAM_SUBDIRECTORY}"

        cleandir() {
          # Delete any existing contents of the repo directory if it exists.
          #
          # We don't just "rm -rf ${CHECKOUT_DIR}" because ${CHECKOUT_DIR} might be "/"
          # or the root of a mounted volume.
          if [ -d "${CHECKOUT_DIR}" ] ; then
            # Delete non-hidden files and directories
            rm -rf "${CHECKOUT_DIR:?}"/*
            # Delete files and directories starting with . but excluding ..
            rm -rf "${CHECKOUT_DIR}"/.[!.]*
            # Delete files and directories starting with .. plus any other character
            rm -rf "${CHECKOUT_DIR}"/..?*
          fi
        }

        if [ "${PARAM_DELETE_EXISTING}" = "true" ] ; then
          cleandir
        fi

        test -z "${PARAM_HTTP_PROXY}" || export HTTP_PROXY="${PARAM_HTTP_PROXY}"
        test -z "${PARAM_HTTPS_PROXY}" || export HTTPS_PROXY="${PARAM_HTTPS_PROXY}"
        test -z "${PARAM_NO_PROXY}" || export NO_PROXY="${PARAM_NO_PROXY}"

        /ko-app/git-init \
          -url="${PARAM_URL}" \
          -revision="${PARAM_REVISION}" \
          -refspec="${PARAM_REFSPEC}" \
          -path="${CHECKOUT_DIR}" \
          -sslVerify="${PARAM_SSL_VERIFY}" \
          -submodules="${PARAM_SUBMODULES}" \
          -depth="${PARAM_DEPTH}" \
          -sparseCheckoutDirectories="${PARAM_SPARSE_CHECKOUT_DIRECTORIES}"
        cd "${CHECKOUT_DIR}"
        RESULT_SHA="$(git rev-parse HEAD)"
        EXIT_CODE="$?"
        if [ "${EXIT_CODE}" != 0 ] ; then
          exit "${EXIT_CODE}"
        fi
        printf "%s" "${RESULT_SHA}" > "$(results.commit.path)"
        printf "%s" "${PARAM_URL}" > "$(results.url.path)"
---
# Source: edp-tekton/templates/tasks/github-set-status.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: github-set-status
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/categories: Git
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: github
    tekton.dev/displayName: "set github status"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task will set the status of the CI job to the specified value along
    with a link to the specified target URL where developers can follow the
    progress of the CI job.

    The `github-set-status` task allows external services to mark GitHub commits
    with an `error`, `failure`, `pending`, or `success` state, which is then
    reflected in pull requests involving those commits. Statuses include as well a
    `description` and a `target_url`, to give the user informations about the CI
    statuses or a direct link to the full log.
  volumes:
    - name: githubtoken
      secret:
        secretName: $(params.GITHUB_TOKEN_SECRET_NAME)
  params:
    - name: GITHUB_HOST_URL
      description: |
        The GitHub host, adjust this if you run a GitHub enteprise.
      default: "api.github.com"
      type: string
    - name: API_PATH_PREFIX
      description: |
        The API path prefix, GitHub Enterprise has a prefix e.g. /api/v3
      default: ""
      type: string
    - name: REPO_FULL_NAME
      description: |
        The GitHub repository full name, e.g.: tektoncd/catalog
      type: string
    - name: GITHUB_TOKEN_SECRET_NAME
      description: |
        The name of the kubernetes secret that contains the GitHub token, default: github
      type: string
      default: github
    - name: GITHUB_TOKEN_SECRET_KEY
      description: |
        The key within the kubernetes secret that contains the GitHub token, default: token
      type: string
      default: token
    - name: SHA
      description: |
        Commit SHA to set the status for.
      type: string
    - name: TARGET_URL
      description: |
        The target URL to associate with this status. This URL will be linked
        from the GitHub UI to allow users to easily see the source of the
        status.
      type: string
    - name: DESCRIPTION
      description: |
        A short description of the status.
      type: string
    - name: CONTEXT
      description: |
        The GitHub context, A string label to differentiate this status from
        the status of other systems. ie: "continuous-integration/tekton"
      default: "continuous-integration/tekton"
      type: string
    - name: STATE
      description: |
        The state of the status. Can be one of the following `error`,
        `failure`, `pending`, or `success`.
      type: string
    - name: AUTH_TYPE
      description: |
        The type of authentication to use. You could use the less secure "Basic" for example
      type: string
      default: Bearer
    - name: IMAGE
      description: |
        Image providing the python binary which this task uses.
      type: string
      default: docker.io/python:3.10.8-alpine3.16
    - name: SHEBANG
      description: |
        Python path. Depends on the image.
      type: string
      default: /usr/bin/env python
  steps:
    - name: set-status
      volumeMounts:
        - name: githubtoken
          mountPath: /etc/github-set-status
      env:
        - name: GITHUB_HOST_URL
          value: $(params.GITHUB_HOST_URL)
        - name: API_PATH_PREFIX
          value: $(params.API_PATH_PREFIX)
        - name: REPO_FULL_NAME
          value: $(params.REPO_FULL_NAME)
        - name: GITHUB_TOKEN_SECRET_NAME
          value: $(params.GITHUB_TOKEN_SECRET_NAME)
        - name: GITHUB_TOKEN_SECRET_KEY
          value: $(params.GITHUB_TOKEN_SECRET_KEY)
        - name: SHA
          value: $(params.SHA)
        - name: TARGET_URL
          value: $(params.TARGET_URL)
        - name: DESCRIPTION
          value: $(params.DESCRIPTION)
        - name: CONTEXT
          value: $(params.CONTEXT)
        - name: STATE
          value: $(params.STATE)
        - name: AUTH_TYPE
          value: $(params.AUTH_TYPE)
        - name: SHEBANG
          value: $(params.SHEBANG)

      image: $(params.IMAGE)
      script: |
        #!$(params.SHEBANG)

        """This script will set the CI status on GitHub PR"""

        import json
        import os
        import sys
        import http.client

        github_token_filename = "/etc/github-set-status/" + \
            os.getenv("GITHUB_TOKEN_SECRET_KEY")
        github_token = open(github_token_filename, "r").read()

        status_url = os.getenv("API_PATH_PREFIX") + "/repos/" + \
            os.getenv("REPO_FULL_NAME") + "/statuses/" + os.getenv("SHA")

        data = {
            "state": os.getenv("STATE"),
            "target_url": os.getenv("TARGET_URL"),
            "description": os.getenv("DESCRIPTION"),
            "context": os.getenv("CONTEXT")
        }
        print("Sending this data to GitHub@{url}: ".format(
          url=os.getenv("GITHUB_HOST_URL")))
        print(data)

        authHeader = os.getenv("AUTH_TYPE") + " " + github_token

        # This is for our fake github server
        if "$(params.GITHUB_HOST_URL)".startswith("http://"):
          conn = http.client.HTTPConnection("$(params.GITHUB_HOST_URL)".replace("http://", ""))
        else:
          conn = http.client.HTTPSConnection("$(params.GITHUB_HOST_URL)")

        conn.request(
            "POST",
            status_url,
            body=json.dumps(data),
            headers={
                "User-Agent": "TektonCD, the peaceful cat",
                "Authorization": authHeader,
                "Accept": "application/vnd.github.v3+json ",
            })
        resp = conn.getresponse()
        if not str(resp.status).startswith("2"):
            print("Error: %d" % (resp.status))
            print(resp.read())
            sys.exit(1)
        else:
            print("GitHub status '{state}' has been set on {repo}#{sha} ".format(
                state=os.getenv("STATE"),
                repo=os.getenv("REPO_FULL_NAME"),
                sha=os.getenv("SHA")))
---
# Source: edp-tekton/templates/tasks/gitlab-set-status.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gitlab-set-status
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Git
    tekton.dev/tags: gitlab, git
    tekton.dev/displayName: "Set Gitlab commit status"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task will set the status of the CI job to the specified value along
    with a link to the specified target URL where developers can follow the
    progress of the CI job.

    The `gitlab-set-status` task allows external services to mark GitLab commits
    with an `error`, `failure`, `pending`, or `success` state, which is then
    reflected in merge requests involving those commits. Statuses include as well a
    `description` and a `target_url`, to give the user informations about the CI
    statuses or a direct link to the full log.
  params:
    - name: GITLAB_HOST_URL
      description: |
        The GitLab host, adjust this if you run a GitLab enterprise. In KRCI we use git_ssh_url
        value from the event payload, format: "git@example.com:mike/diaspora.git"
      default: "gitlab.com"
      type: string
    - name: API_PATH_PREFIX
      description: |
        The API path prefix, GitLab Enterprise has a prefix e.g. /api/v4
      default: "/api/v4"
      type: string
    - name: REPO_FULL_NAME
      description: |
        The GitLab repository full name, e.g.: tektoncd/catalog
      type: string
    - name: GITLAB_TOKEN_SECRET_NAME
      description: |
        The name of the kubernetes secret that contains the GitLab token, default: gitlab-api-secret
      type: string
      default: gitlab-api-secret
    - name: GITLAB_TOKEN_SECRET_KEY
      description: |
        The key within the kubernetes secret that contains the GitLab token, default: token
      type: string
      default: token
    - name: SHA
      description: |
        Commit SHA to set the status for.
      type: string
    - name: TARGET_URL
      description: |
        The target URL to associate with this status. This URL will be linked
        from the GitLab UI to allow users to easily see the source of the
        status.
      type: string
    - name: DESCRIPTION
      description: |
        A short description of the status.
      type: string
    - name: CONTEXT
      description: |
        The GitLab context, A string label to differentiate this status from
        the status of other systems. ie: "continuous-integration/tekton"
      default: "continuous-integration/tekton"
      type: string
    - name: STATE
      description: |
        The state of the status. Can be one of the following `pending`,
        `running`, `success`, `failed`, or `canceled`.
      type: string

  steps:
    - name: set-status
      image: registry.access.redhat.com/ubi8/python-38@sha256:af6f93b81f9313de95966e8cd681edb9dbcb5fdbddc5a4cc365af8e4534096ef
      script: |
        #!/usr/libexec/platform-python

        import os
        import sys
        import json
        import http.client
        import urllib.parse

        GITLAB_TOKEN = os.getenv("GITLAB_TOKEN")
        GITLAB_HOST_URL = "ssh://$(params.GITLAB_HOST_URL)"
        API_PATH_PREFIX = "$(params.API_PATH_PREFIX)"
        REPO_FULL_NAME = "$(params.REPO_FULL_NAME)"
        SHA = "$(params.SHA)"
        STATE = "$(params.STATE)"
        CONTEXT = "$(params.CONTEXT)"
        TARGET_URL = "$(params.TARGET_URL)"
        DESCRIPTION = "$(params.DESCRIPTION)"

        headers = {
            "User-Agent": "TektonCD, the peaceful cat",
            "Authorization": f"Bearer {GITLAB_TOKEN}",
        }

        URLENCODED_REPO_NAME = urllib.parse.quote(REPO_FULL_NAME, safe="")

        params = {
            "state": STATE,
            "context": CONTEXT,
            "target_url": TARGET_URL,
            "description": DESCRIPTION
        }

        encoded_params = urllib.parse.urlencode(params)

        api_url = f"{API_PATH_PREFIX}/projects/{URLENCODED_REPO_NAME}/statuses/{SHA}?{encoded_params}"

        # we need to adapt to KRCI approach and extract the host from the git_ssh_url
        # which is in the format: git@example.com:mike/diaspora.git
        GITLAB_HOST_URL = urllib.parse.urlparse(GITLAB_HOST_URL).hostname

        print(f"POST to {GITLAB_HOST_URL}{api_url}")

        if GITLAB_HOST_URL.startswith("http://"):
            conn = http.client.HTTPConnection(GITLAB_HOST_URL[7:])
        elif GITLAB_HOST_URL.startswith("https://"):
            conn = http.client.HTTPSConnection(GITLAB_HOST_URL[8:])
        else:
            conn = http.client.HTTPSConnection(GITLAB_HOST_URL)
        try:
            conn.request("POST", api_url, headers=headers)

            resp = conn.getresponse()
            if not str(resp.status).startswith("2"):
                print(f"{resp.status} | Unable to set status")
                response_data = json.dumps(json.loads(resp.read()), indent=4)
                print(response_data)
                sys.exit(1)
            else:
                print(f"Just set status of {REPO_FULL_NAME}#{SHA} to {STATE}")
        finally:
            conn.close()

      env:
        - name: GITLAB_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.GITLAB_TOKEN_SECRET_NAME)
              key: $(params.GITLAB_TOKEN_SECRET_KEY)
---
# Source: edp-tekton/templates/tasks/gitops/yaml-lint.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: yaml-lint
spec:
  description: >-
    This Task is used to lint the YAML manifests in the GitOps system repository.
  workspaces:
    - name: source
  params:
    - name: BASE_IMAGE
      description: "Base image containing yamllint and its configuration"
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
      type: string
  steps:
    - name: yaml-lint
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -e

        echo "Linting YAML manifests..."

        yamllint .

        echo "YAML manifests linted successfully."
---
# Source: edp-tekton/templates/tasks/go.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: golang
  labels:
    app.kubernetes.io/version: "0.3"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "golang build"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
   This task builds a Go project using specified parameters for the target operating system, architecture, and build settings, with support for additional custom commands.
  workspaces:
    - name: source
  params:
    - name: GOOS
      description: "running program's operating system target"
      default: linux
      type: string
    - name: GOARCH
      description: "running program's architecture target"
      default: amd64
      type: string
    - name: GO111MODULE
      description: "value of module support"
      default: auto
      type: string
    - name: GOCACHE
      description: "Go caching directory path"
      default: "$(workspaces.source.path)/cache"
      type: string
    - name: GOMODCACHE
      description: "Go mod caching directory path"
      default: "$(workspaces.source.path)/cache"
      type: string
    - name: CGO_ENABLED
      description: "Toggle cgo tool during Go build. Use value '0' to disable cgo (for static builds)."
      default: '0'
      type: string
    - name: GOSUMDB
      description: "Go checksum database url. Use value 'off' to disable checksum validation."
      default: ""
      type: string
    - name: EXTRA_COMMANDS
      type: string
      description: Extra commands
      default: ""
    - name: BASE_IMAGE
      description: "Base image"
      default: "docker.io/golang:1.24-bookworm"
      type: string
    - name: GOPROXY
      description: "Go proxy server"
      default: ""
      type: string
  steps:
    - name: golang
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)

      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      env:
        - name: GOOS
          value: "$(params.GOOS)"
        - name: GOARCH
          value: "$(params.GOARCH)"
        - name: GO111MODULE
          value: "$(params.GO111MODULE)"
        - name: GOCACHE
          value: "$(params.GOCACHE)"
        - name: GOMODCACHE
          value: "$(params.GOMODCACHE)"
        - name: CGO_ENABLED
          value: "$(params.CGO_ENABLED)"
        - name: GOSUMDB
          value: "$(params.GOSUMDB)"
        - name: GOPROXY
          value: "$(params.GOPROXY)"
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/displayName: Gradle
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
   This task runs a Gradle build in a specified project directory with configurable integration for Nexus and SonarQube, using custom settings and extra build arguments.
  workspaces:
    - name: source
      description: The workspace consisting of the gradle project.
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  params:
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: docker.io/gradle:7.6.5-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret for the Sonarqube integration
      default: "ci-sonarqube"
    - name: EXTRA_ARGS
      description: Extra arguments to add to the gradle build
      default: |
        -Dorg.gradle.internal.publish.checksums.insecure=true \
        publish
  steps:
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_ARGS)
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: SNAPSHOTS_REPO_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-gradle-settings
              key: SNAPSHOTS_REPO_PATH
              optional: true
        - name: RELEASES_REPO_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-gradle-settings
              key: RELEASES_REPO_PATH
              optional: true
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/hadolint.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Hadolint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
    tekton.dev/tags: 'Kubernetes, Misconfiguration'
  name: hadolint
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    This task makes it possible to use Hadolint within Tekton Pipeline.
    A smarter Dockerfile linter that helps you build best practice Docker
    images. The linter parses the Dockerfile into an AST and performs rules on
    top of the AST
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: ghcr.io/hadolint/hadolint:v2.12.0-alpine@sha256:3c206a451cec6d486367e758645269fd7d696c5ccb6ff59d8b03b0e45268a199
    - default: './Dockerfile'
      description: Dockerfile path.
      name: dockerfile-path
      type: string
    - default: tty
      description: >-
        The output format for the results [tty | json | checkstyle | codeclimate
        | gitlab_codeclimate | codacy] (default tty).
      name: output-format
      type: string
  steps:
    - image: $(params.BASE_IMAGE)
      name: lint-dockerfile
      workingDir: $(workspaces.source.path)
      env:
        - name: DOCKERFILE
          value: "$(params.dockerfile-path)"
        - name: OFORMAT
          value: "$(params.output-format)"
      script: |
        set -e
        hadolint "$DOCKERFILE" -f "$OFORMAT"
---
# Source: edp-tekton/templates/tasks/helm-dependency-update.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-dependency-update
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
   This task updates the dependencies of a Helm chart using the `helm dependency update` command with optional extra parameters.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: extra_params
      description: "Extra parameters passed for the helm dependency build command"
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "docker.io/alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: EXTRA_PARAMS
          value: $(params.extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        helm dependency update ${CHART_DIR} ${EXTRA_PARAMS}
---
# Source: edp-tekton/templates/tasks/helm-docs.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-docs
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
   This task generates documentation for Helm charts using `helm-docs` and validates if the generated README.md is up-to-date.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: helm_docs_image
      description: "Specify a specific helm-docs image"
      default: "docker.io/jnorwood/helm-docs:v1.13.1"
    - name: git_image
      description: "Specify a specific git image"
      default: "docker.io/alpine/git:v2.26.2"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm-docs
      image: $(params.helm_docs_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        README_FILE_PATH="${CHART_DIR}/README.md"
        if [ -f "${README_FILE_PATH}" ]; then
            echo "[TEKTON][INFO] The file has been found at the given location \"${README_FILE_PATH}\""
        else
            echo "[TEKTON][ERROR] The file has not been found at the given location \"${README_FILE_PATH}\""
            exit 1
        fi

        helm-docs --chart-search-root ${CHART_DIR}
    - name: validate-helm-docs
      image: $(params.git_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        git config --global --add safe.directory $(pwd)
        git diff -s --exit-code ${CHART_DIR}/README.md || (echo "Run 'helm-docs' to address the issue." && git diff && exit 1)
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-dependency-update-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-dependency-update
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task updates dependencies for all Helm charts in a specified directory using the `helm dependency update` command with optional extra parameters.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: extra_params
      description: "Extra parameters passed for the helm dependency build command"
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "docker.io/alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: EXTRA_PARAMS
          value: $(params.extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        #!/bin/bash
        set -ex

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            helm dependency update $i ${EXTRA_PARAMS}
        done
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-docs-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-docs
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task generates and validates documentation for multiple Helm charts using `helm-docs`, ensuring that the README.md files are up-to-date.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: step_helm_docs_image
      description: "Specify a specific helm-docs image"
      default: "docker.io/jnorwood/helm-docs:v1.13.1"
    - name: step_validate_helm_docs_image
      description: "Specify a specific git image"
      default: "docker.io/alpine/git:v2.26.2"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm-docs
      image: $(params.step_helm_docs_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        chart_directory=$(ls -1 ${CHART_DIR}/)
        for i in ${chart_directory}
        do
            README_FILE_PATH="${CHART_DIR}/${i}/README.md"
            if [ -f "${README_FILE_PATH}" ]; then
                echo "[TEKTON][INFO] The file has been found at the given location \"${README_FILE_PATH}\""
            else
                echo "[TEKTON][ERROR] The file has not been found at the given location \"${README_FILE_PATH}\""
                exit 1
            fi
        done

        helm-docs --chart-search-root ${CHART_DIR}

    - name: validate-helm-docs
      image: $(params.step_validate_helm_docs_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        git config --global --add safe.directory $(pwd)

        chart_directory=$(ls -1 ${CHART_DIR}/)
        for i in ${chart_directory}
        do
            git diff -s --exit-code ${CHART_DIR}/${i}/README.md || (echo "Run 'helm-docs' to address the issue." && git diff && exit 1)
        done
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-lint-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Helm-Lint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
  name: helm-library-lint
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    This task runs `helm lint` to validate Helm charts using configurable chart testing settings, with support for version increment checks and custom commands.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  volumes:
    - name: ct-config-volume
      configMap:
        name: ct-config
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: quay.io/helmpack/chart-testing:v3.10.1
      type: string
    - name: EXTRA_COMMANDS
      description: Arguments to add to the helm-lint step
      default: ""
      type: string
    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
      type: string
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."
      type: string
    - name: CHART_VERSION_INCREMENT
      description: "Check version increment"
      default: 'false'
      type: string
    - name: TARGET_BRANCH
      description: "Git branch"
      default: "master"
      type: string
  steps:
    - image: $(params.BASE_IMAGE)
      name: helm-lint
      workingDir: $(workspaces.source.path)
      env:
        - name: HOME
          value: $(params.USER_HOME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: CT_CONFIGS_DIR_DEFAULT
          value: "ct-configs"
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)

        CT_FILE_PATH=""
        LINTCONF_FILE_PATH=""
        CHART_SCHEMA_FILE_PATH=""

        if [ -f "${CT_CONFIGS_DIR}/ct.yaml" ]; then
            CT_FILE_PATH="${CT_CONFIGS_DIR}/ct.yaml"
        else
            CT_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/ct.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/lintconf.yaml" ]; then
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR}/lintconf.yaml"
        else
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/lintconf.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/chart_schema.yaml" ]; then
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR}/chart_schema.yaml"
        else
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/chart_schema.yaml"
        fi

        echo "[TEKTON][INFO] Specific charts to test are located at \"${CT_FILE_PATH}\""
        echo "[TEKTON][INFO] The config file for YAML linting is located at \"${LINTCONF_FILE_PATH}\""
        echo "[TEKTON][INFO] The schema for chart.yml validation is located at \"${CHART_SCHEMA_FILE_PATH}\""

        git config --global --add safe.directory $(pwd)

        ct lint \
        --debug \
        --target-branch $(params.TARGET_BRANCH) \
        --config ${CT_FILE_PATH} \
        --lint-conf ${LINTCONF_FILE_PATH} \
        --chart-yaml-schema ${CHART_SCHEMA_FILE_PATH} \
        --check-version-increment=$(params.CHART_VERSION_INCREMENT)

      volumeMounts:
        - name: ct-config-volume
          mountPath: /workspace/source/ct-configs/
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-push-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-push-lib
spec:
  description: |
    This Task allows Uset to push a new version of the Helm Chart
    to the repository with Snapshot versions.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  params:
    - name: chart-dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: init-repository
      image: docker.io/amazon/aws-cli:2.7.35
      workingDir: $(workspaces.source.path)
      env:
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: aws_region
              optional: true
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_type
      script: |
          #!/bin/bash

          set -ex

          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            chart_directory=(${CHART_DIR}/*)
            for i in "${chart_directory[@]}"
            do
                REPO_NAME=$(awk '/^name:/ {print $2}' ${i}/Chart.yaml)
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}";
            done

          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: push-helm-chart
      image: docker.io/alpine/k8s:1.25.15
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_type
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              key: platform
              name: krci-config
      script: |
        #!/bin/bash
        set -ex

        helm_push_command="helm push *-*.tgz oci://${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}"

        if [ $CONTAINER_REGISTRY_TYPE != "ecr" ]; then
          helm_push_command+=" --registry-config /.config/helm/registry/config.json"
        fi

        if [ $PLATFORM == "openshift" ]; then
          helm_push_command+=" --insecure-skip-tls-verify"
        fi

        if [ $CONTAINER_REGISTRY_TYPE == "ecr" ]; then
          aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | helm registry login --username AWS --password-stdin ${CONTAINER_REGISTRY_URL}
        fi

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            if ! git diff --quiet HEAD^ HEAD -- $i; then
                helm package ${i}
                $helm_push_command
                rm *-*.tgz
            fi
        done

      # Adding this securityContext makes it explicit that it needs to run as root.
      # Required for Openshift.
      securityContext:
        runAsUser: 0
      # This secret mount is necessary for helm push to internal openshift registry
      volumeMounts:
        - mountPath: /.config/helm/registry
          name: dockerconfig
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/helm-libraries/helm-template-lib.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-library-template
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task templates all Helm charts in a specified directory using `helm template` with additional parameters and commands for customization.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: release_name
      description: The helm release name
      default: "helm-release"
    - name: template_extra_params
      description: "Extra parameters passed for the helm template command"
      default: ""
    - name: extra_commands
      description: Arguments to add to the helm-lint step
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "docker.io/alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: RELEASE_NAME
          value: $(params.release_name)
        - name: TEMPLATE_EXTRA_PARAMS
          value: $(params.template_extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        #!/bin/bash
        set -ex

        chart_directory=(${CHART_DIR}/*)
        for i in "${chart_directory[@]}"
        do
            helm template ${RELEASE_NAME} ${i} ${TEMPLATE_EXTRA_PARAMS}
            $(params.extra_commands)
        done
---
# Source: edp-tekton/templates/tasks/helm-lint.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  annotations:
    tekton.dev/categories: Code Quality
    tekton.dev/displayName: Helm-Lint
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/platforms: linux/amd64
  name: helm-lint
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
   This task validates Helm charts using `helm-lint` with configurable chart and configuration directories, supporting custom user environments and additional commands.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  volumes:
    - name: ct-config-volume
      configMap:
        name: ct-config
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      default: quay.io/helmpack/chart-testing:v3.10.1
    - name: EXTRA_COMMANDS
      description: Arguments to add to the helm-lint step
      default: ""
    - name: USER_HOME
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
    - name: CHART_DIR
      description: "Deploy templates directory for helm-lint"
      default: "deploy-templates"
    - name: CT_CONFIGS_DIR
      description: "ct-configs directory for helm-lint"
      default: "."

  steps:
    - image: $(params.BASE_IMAGE)
      name: helm-lint
      workingDir: $(workspaces.source.path)
      env:
        - name: HOME
          value: $(params.USER_HOME)
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: CT_CONFIGS_DIR
          value: $(params.CT_CONFIGS_DIR)
        - name: CT_CONFIGS_DIR_DEFAULT
          value: "ct-configs"
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)

        CT_FILE_PATH=""
        LINTCONF_FILE_PATH=""
        CHART_SCHEMA_FILE_PATH=""

        if [ -f "${CT_CONFIGS_DIR}/ct.yaml" ]; then
            CT_FILE_PATH="${CT_CONFIGS_DIR}/ct.yaml"
        else
            CT_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/ct.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/lintconf.yaml" ]; then
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR}/lintconf.yaml"
        else
            LINTCONF_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/lintconf.yaml"
        fi

        if [ -f "${CT_CONFIGS_DIR}/chart_schema.yaml" ]; then
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR}/chart_schema.yaml"
        else
            CHART_SCHEMA_FILE_PATH="${CT_CONFIGS_DIR_DEFAULT}/chart_schema.yaml"
        fi

        echo "[TEKTON][INFO] Specific charts to test are located at \"${CT_FILE_PATH}\""
        echo "[TEKTON][INFO] The config file for YAML linting is located at \"${LINTCONF_FILE_PATH}\""
        echo "[TEKTON][INFO] The schema for chart.yml validation is located at \"${CHART_SCHEMA_FILE_PATH}\""

        ct lint \
        --charts ${CHART_DIR}/ \
        --config ${CT_FILE_PATH} \
        --lint-conf ${LINTCONF_FILE_PATH} \
        --chart-yaml-schema ${CHART_SCHEMA_FILE_PATH}

      volumeMounts:
        - name: ct-config-volume
          mountPath: /workspace/source/ct-configs/
---
# Source: edp-tekton/templates/tasks/helm-push.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-push
spec:
  description: >-
   This task pushes a new version of a Helm chart to a container registry, supporting both ECR and other registry types, and includes handling for different platforms and registry configurations.
  workspaces:
    - name: source
      description: A workspace that contains the repository.
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  params:
    - name: image-tag
      description: Image tag
    - name: chart-dir
      description: The directory in source that contains the helm chart
      default: "."
  steps:
    - name: init-repository
      image: docker.io/amazon/aws-cli:2.7.35
      workingDir: $(workspaces.source.path)
      env:
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: aws_region
              optional: true
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_type
      script: |
          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            REPO_NAME=$(awk '/^name:/ {print $2}' ${CHART_DIR}/Chart.yaml)
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_SPACE}/${REPO_NAME}";
          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: push-helm-chart
      image: docker.io/alpine/k8s:1.25.15
      workingDir: $(workspaces.source.path)
      env:
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: CHART_DIR
          value: $(params.chart-dir)
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_type
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              key: platform
              name: krci-config
      script: |
        #!/bin/bash

        set -ex

        helm package ${CHART_DIR} --version ${IMAGE_TAG}

        helm_push_command="helm push *-${IMAGE_TAG}.tgz oci://${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}"


        if [ $CONTAINER_REGISTRY_TYPE != "ecr" ]; then
          helm_push_command+=" --registry-config /.config/helm/registry/config.json"
        fi

        if [ $PLATFORM == "openshift" ]; then
          helm_push_command+=" --insecure-skip-tls-verify"
        fi

        if [ $CONTAINER_REGISTRY_TYPE == "ecr" ]; then
          aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | helm registry login --username AWS --password-stdin ${CONTAINER_REGISTRY_URL}
        fi

        $helm_push_command

      # Adding this securityContext makes it explicit that it needs to run as root.
      # Required for Openshift.
      securityContext:
        runAsUser: 0
      # This secret mount is necessary for helm push to internal openshift registry
      volumeMounts:
        - mountPath: /.config/helm/registry
          name: dockerconfig
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/helm-template.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: helm-template
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/categories: CI
    tekton.dev/pipelines.minVersion: "0.41.0"
    tekton.dev/tags: helm
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
   This task runs the `helm template` command to generate Kubernetes manifests from a Helm chart, with optional extra parameters and commands for customization.
  workspaces:
    - description: A workspace that contains fetched git repo.
      name: source
  params:
    - name: CHART_DIR
      description: The directory in source that contains the helm chart
      default: "."
    - name: release_name
      description: The helm release name
      default: "helm-release"
    - name: template_extra_params
      description: "Extra parameters passed for the helm template command"
      default: ""
    - name: extra_commands
      description: Arguments to add to the helm-lint step
      default: ""
    - name: helm_image
      description: "Specify a specific helm image"
      default: "docker.io/alpine/helm:3.11.1"
    - name: user_home
      description: |
        Absolute path to the user's home directory. Set this explicitly if you are running the image as a non-root user
      type: string
      default: "/tekton/home"
  steps:
    - name: helm
      image: $(params.helm_image)
      workingDir: $(workspaces.source.path)
      env:
        - name: CHART_DIR
          value: $(params.CHART_DIR)
        - name: RELEASE_NAME
          value: $(params.release_name)
        - name: TEMPLATE_EXTRA_PARAMS
          value: $(params.template_extra_params)
        - name: HOME
          value: $(params.user_home)
      script: |
        set -ex

        helm template ${RELEASE_NAME} ${CHART_DIR} ${TEMPLATE_EXTRA_PARAMS}
        $(params.extra_commands)
---
# Source: edp-tekton/templates/tasks/image-scan-remote.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: image-scan-remote
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    This task scans container images from remote registries for vulnerabilities using Trivy and Grype
    and uploads the scan reports to DefectDojo.
  workspaces:
    - name: source
  params:
    - name: ECR_LOGIN
      type: string
      default: '/workspace/ecr_login_pass'
    - name: krci-config
      type: string
      description: this configmap holds aws_region parameter
      default: krci-config
    - name: IMAGE_NAMES
      type: array
      description: List of container images to be scanned. Each image can be in the format
        `repository/image:tag` or `repository/image`.
    - name: COMPONENT_NAME
      type: string
      description: Name of the component to which the images belong.
        Pipeline will use this name to create/update the appropriate
        Engagement with scan reports in DefectDojo.
    - name: BASE_IMAGE_TRIVY
      type: string
      default: "docker.io/aquasec/trivy:0.65.0"
    - name: BASE_IMAGE_GRYPE
      type: string
      default: "docker.io/anchore/grype:v0.97.1-debug"
    - name: BASE_IMAGE
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
    - name: TRIVY_SCAN_REPORT
      type: string
      description: The name of the Trivy scan report
      default: image-scan-trivy-report.json
    - name: GRYPE_SCAN_REPORT
      type: string
      description: The name of the Grype scan report
      default: image-scan-grype-report.json
    - name: ci-defectdojo
      type: string
      description: Name of the secret holding the DefectDojo CI integration data
      default: ci-defectdojo
  results:
    - name: SCAN_REPORT_URL
      description: DefectDojo URL with the generated vulnerability scan reports
  steps:
    - name: get-ecr-pass
      image: docker.io/amazon/aws-cli:2.28.3
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: AWS_REGION
          valueFrom:
            configMapKeyRef:
              name: "$(params.krci-config)"
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: "$(params.krci-config)"
              key: container_registry_type
      script: |
        if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
          aws ecr get-login-password --region "${AWS_REGION}" > "${ECR_LOGIN}"
        else
          echo 'Registry not ECR, stage skipped';
        fi

    - name: trivy
      args: ["$(params.IMAGE_NAMES[*])"]
      image: $(params.BASE_IMAGE_TRIVY)
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env sh
        set -e

        for IMAGE in "$@"; do
          COMPONENT_NAME=$(basename "${IMAGE%%:*}")
          REPORT_FILE="trivy-report-${COMPONENT_NAME}.json"

          trivy image --format json -o "$REPORT_FILE" "$IMAGE"

          cat "$REPORT_FILE"
        done

    - name: grype
      args: ["$(params.IMAGE_NAMES[*])"]
      image: $(params.BASE_IMAGE_GRYPE)
      workingDir: $(workspaces.source.path)
      env:
        - name: ECR_LOGIN
          value: "$(params.ECR_LOGIN)"
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              key: container_registry_type
              name: "$(params.krci-config)"
      securityContext:
        runAsUser: 0
      script: |
        #!/busybox/sh
        set -e

        for IMAGE in "$@"; do
          COMPONENT_NAME=$(basename "${IMAGE%%:*}")
          REPORT_NAME="grype-report-${COMPONENT_NAME}.json"

          if [[ "${CONTAINER_REGISTRY_TYPE}" == "ecr" && "${IMAGE}" == *".ecr."* ]]; then
            GRYPE_REGISTRY_AUTH_USERNAME=AWS \
            GRYPE_REGISTRY_AUTH_PASSWORD=$(cat "${ECR_LOGIN}") \
            /grype "${IMAGE}" -o json > "${REPORT_NAME}"
          else
            /grype "${IMAGE}" -o json > "${REPORT_NAME}"
          fi

          cat "${REPORT_NAME}"
        done

    - name: upload-report
      args: ["$(params.IMAGE_NAMES[*])"]
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: DD_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: $(params.ci-defectdojo)
        - name: DD_HOST_URL
          valueFrom:
            secretKeyRef:
              key: url
              name: $(params.ci-defectdojo)
        - name: DD_PRODUCT_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      script: |
        #!/usr/bin/env sh
        set -e

        PRODUCT_ID=$(curl -s -X GET "${DD_HOST_URL}/api/v2/products/?name_exact=${DD_PRODUCT_NAME}" \
          -H "accept: application/json" \
          -H "Authorization: Token ${DD_TOKEN}" \
          | jq -r '.results[0].id')

        for IMAGE in "$@"; do
          COMPONENT_NAME=$(basename "${IMAGE%%:*}")

          for SCAN_TYPE in "Trivy Scan" "Anchore Grype"; do
            if [ "$SCAN_TYPE" = "Trivy Scan" ]; then
              REPORT_NAME="trivy-report-${COMPONENT_NAME}.json"
            else
              REPORT_NAME="grype-report-${COMPONENT_NAME}.json"
            fi

            curl -s -X POST "${DD_HOST_URL}/api/v2/reimport-scan/" \
              -H "accept: application/json" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -H "Content-Type: multipart/form-data" \
              -F "scan_date=$(date +%Y-%m-%d)" \
              -F "minimum_severity=Info" \
              -F "active=true" \
              -F "verified=false" \
              -F "scan_type=${SCAN_TYPE}" \
              -F "file=@${REPORT_NAME};type=application/json" \
              -F "product_type_name=Tenant" \
              -F "product_name=${DD_PRODUCT_NAME}" \
              -F "engagement_name=$(params.COMPONENT_NAME)" \
              -F "auto_create_context=true" \
              -F "close_old_findings=true" \
              -F "push_to_jira=false" \
              -F "environment=Development" \
              -F "test_title=${COMPONENT_NAME}" \
              -F "tags=${IMAGE%:*}"
          done
        done

        ENGAGEMENT_ID=$(curl -s -X GET "${DD_HOST_URL}/api/v2/engagements/?product=${PRODUCT_ID}&name=$(params.COMPONENT_NAME)" \
          -H "accept: application/json" \
          -H "Authorization: Token ${DD_TOKEN}" \
          | jq -r '.results[0].id')

        SCAN_REPORT_URL="${DD_HOST_URL}/engagement/${ENGAGEMENT_ID}"
        printf "%s" "$SCAN_REPORT_URL" > "$(results.SCAN_REPORT_URL.path)"
---
# Source: edp-tekton/templates/tasks/image-scan.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: image-scan
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task scans container images for vulnerabilities using Trivy and Grype, generates reports in JSON format, and uploads the reports to DefectDojo.
  workspaces:
    - name: source
  params:
    - name: IMAGE_TAR
      type: string
      description: Name (reference) of the image tar package.
    - name: BASE_IMAGE_TRIVY
      type: string
      default: "docker.io/aquasec/trivy:0.59.1"
    - name: BASE_IMAGE_GRYPE
      type: string
      default: "docker.io/anchore/grype:v0.87.0-debug"
    - name: BASE_IMAGE_CURL
      type: string
      default: "docker.io/alpine/curl:8.12.0"
    - name: PATH_CONTEXT
      description: The build context used by Trivy.
      default: "."
    - name: TRIVY_SCAN_REPORT
      type: string
      description: The name of the Trivy scan report
      default: image-scan-trivy-report.json
    - name: GRYPE_SCAN_REPORT
      type: string
      description: The name of the Grype scan report
      default: image-scan-grype-report.json
    - name: DD_PRODUCT_NAME
      type: string
    - name: DD_ENGAGEMENT_NAME
      type: string
    - name: ci-defectdojo
      type: string
      description: name of the secret holding the DefectDojo CI integration data
      default: ci-defectdojo
  steps:
    - name: trivy
      image: $(params.BASE_IMAGE_TRIVY)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        #!/usr/bin/env sh
        set -e

        trivy image --format json \
            -o $(params.TRIVY_SCAN_REPORT) --input $(params.IMAGE_TAR).tar

        cat $(params.TRIVY_SCAN_REPORT)

    - name: grype
      image: $(params.BASE_IMAGE_GRYPE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      script: |
        #!/busybox/sh
        set -e

        /grype $(params.IMAGE_TAR).tar -o json > $(params.GRYPE_SCAN_REPORT)

        cat $(params.GRYPE_SCAN_REPORT)

    - name: upload-report
      image: $(params.BASE_IMAGE_CURL)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: DD_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: $(params.ci-defectdojo)
        - name: DD_HOST_URL
          valueFrom:
            secretKeyRef:
              key: url
              name: $(params.ci-defectdojo)
      script: |
        #!/usr/bin/env sh
        set -e

        for REPORT_NAME in $(params.TRIVY_SCAN_REPORT) $(params.GRYPE_SCAN_REPORT)
        do
            SCAN_TYPE=""
            if [ "$REPORT_NAME" = "$(params.TRIVY_SCAN_REPORT)" ]; then
                SCAN_TYPE="Trivy Scan"
            elif [ "$REPORT_NAME" = "$(params.GRYPE_SCAN_REPORT)" ]; then
                SCAN_TYPE="Anchore Grype"
            fi

            curl -X POST "${DD_HOST_URL}/api/v2/reimport-scan/" \
                -H "accept: application/json" \
                -H "Authorization: Token ${DD_TOKEN}" \
                -H "Content-Type: multipart/form-data" \
                -F "scan_date=$(date +%Y-%m-%d)" \
                -F "minimum_severity=Info" \
                -F "active=true" \
                -F "verified=false" \
                -F "scan_type=${SCAN_TYPE}" \
                -F "file=@${REPORT_NAME};type=application/json" \
                -F "product_type_name=Tenant" \
                -F "product_name=$(params.DD_PRODUCT_NAME)" \
                -F "engagement_name=$(params.DD_ENGAGEMENT_NAME)" \
                -F "auto_create_context=true" \
                -F "close_old_findings=true" \
                -F "push_to_jira=false" \
                -F "environment=Development" \
                -F "test_title=security-scan"
        done
---
# Source: edp-tekton/templates/tasks/init-values.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: init-values
spec:
  description: >-
   This task initializes pipeline values by generating a tenant name, a normalized branch name, and a formatted codebase image name based on provided parameters.
  params:
    - name: CODEBASE_NAME
      type: string
      description: Codebasebranch name.
      default: "CODEBASE_NAME_placeholder"
    - name: BRANCH_NAME
      type: string
      description: Branch name.
      default: "BRANCH_placeholder"
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: docker.io/bitnamilegacy/kubectl:1.25.4
  results:
    - name: TENANT_NAME
      description: "krci name"
    - name: NORMALIZED_BRANCH
      description: "Branch name without '/' symbols and lowercase"
  steps:
    - name: get-values
      image: $(params.BASE_IMAGE)
      env:
        - name: CODEBASE
          value: "$(params.CODEBASE_NAME)"
        - name: BRANCH
          value: "$(params.BRANCH_NAME)"
      script: |
        #!/usr/bin/env bash
        set -e

        tenantName=$(kubectl get cm krci-config -o jsonpath='{.data.edp_name}')
        echo "${tenantName}" | tr -d '\n' | tee $(results.TENANT_NAME.path)

        normalizedBranch=$(echo ${BRANCH//[^\(?!.)a-zA-Z0-9]/-} | tr '[:upper:]' '[:lower:]')
        printf "%s" "${normalizedBranch}" > "$(results.NORMALIZED_BRANCH.path)"
---
# Source: edp-tekton/templates/tasks/kaniko-dockerbuild-verify.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: dockerbuild-verify
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Build and upload container image using Kaniko"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
   This task builds a Docker image from a Dockerfile using Kaniko without pushing it to a registry. It outputs the image digest and stores the image as a tar file.
  workspaces:
    - name: source
      description: Holds the context and Dockerfile
    - name: dockerconfig
      description: Includes a docker `config.json`
      optional: true
      mountPath: /kaniko/.docker
  params:
    - name: codebase-name
      description: Name of codebase
      default: "placeholder"
    - name: image-tag
      description: Image tag
      default: "lastest"
    - name: image-tar
      description: Name (reference) of the image tar.
      default: "image_tar"
    - name: dockerfile
      description: Dockerfile name.
      default: "Dockerfile"
    - name: context
      description: The build context used by Kaniko.
      default: ./
    - name: builder-image
      description: The image on which builds will run
      default: gcr.io/kaniko-project/executor:v1.12.1-debug
  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built.
    - name: IMAGE_URL
      description: URL of the image just built.
  steps:
    - name: build-no-push
      workingDir: $(workspaces.source.path)
      image: "$(params.builder-image)"
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: IMAGE_TAR
          value: "$(params.image-tar)"
        - name: DOCKERFILE
          value: "$(params.dockerfile)"
        - name: CONTEXT
          value: "$(params.context)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_GROUP
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
      script: |
        /kaniko/executor \
          --dockerfile=$(workspaces.source.path)/${DOCKERFILE} \
          --context=$(workspaces.source.path)/${CONTEXT} \
          --destination=${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}:${IMAGE_TAG} \
          --digest-file=$(results.IMAGE_DIGEST.path) \
          --tar-path=${IMAGE_TAR}.tar \
          --no-push
      # kaniko assumes it is running as root, which means this example fails on platforms
      # that default to run containers as random uid (like OpenShift). Adding this securityContext
      # makes it explicit that it needs to run as root.
      securityContext:
        runAsUser: 0
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/kaniko.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko
  labels:
    app.kubernetes.io/based-on: "0.6"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Build and upload container image using Kaniko"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This Task builds a simple Dockerfile with kaniko and pushes to a registry.
    This Task stores the image name and digest as results, allowing Tekton Chains to pick up
    that an image was built & sign it.
  workspaces:
    - name: source
      description: Holds the context and Dockerfile
  volumes:
    - name: dockerconfig
      secret:
        secretName: kaniko-docker-config
        items:
          - key: .dockerconfigjson
            path: config.json
        optional: true
  params:
    - name: codebase-name
      description: Name of codebase
    - name: image-tag
      description: Image tag
    - name: image-tar
      description: Name (reference) of the image tar.
      default: "image_tar"
    - name: dockerfile
      description: Dockerfile name.
      default: "Dockerfile"
    - name: context
      description: The build context used by Kaniko.
      default: ./
    - name: builder-image
      description: The image on which builds will run
      default: gcr.io/kaniko-project/executor:v1.12.1-debug
  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built.
    - name: IMAGE_URL
      description: URL of the image just built.
  steps:
    - name: init-repository
      image: docker.io/amazon/aws-cli:2.7.35
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: aws_region
              optional: true
        - name: CONTAINER_REGISTRY_GROUP
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: CONTAINER_REGISTRY_TYPE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_type
      script: |
          if [[ "$CONTAINER_REGISTRY_TYPE" == "ecr" ]]; then
            aws ecr describe-repositories --repository-names "${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}" || aws ecr create-repository --repository-name "${CONTAINER_REGISTRY_GROUP}/${CODEBASE_NAME}";
          else
            echo 'Registry not ECR, stage skipped';
          fi

    - name: build-and-push
      workingDir: $(workspaces.source.path)
      image: "$(params.builder-image)"
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: IMAGE_TAR
          value: "$(params.image-tar)"
        - name: DOCKERFILE
          value: "$(params.dockerfile)"
        - name: CONTEXT
          value: "$(params.context)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_host
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: container_registry_space
        - name: PLATFORM
          valueFrom:
            configMapKeyRef:
              name: krci-config
              key: platform
      script: |
        base_command="/kaniko/executor \
          --dockerfile=/workspace/source/${DOCKERFILE} \
          --context=/workspace/source/${CONTEXT} \
          --destination=${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG} \
          --digest-file=/tekton/results/IMAGE_DIGEST \
          --tar-path=${IMAGE_TAR}.tar "

        okd_skip_tls=" --skip-tls-verify "

        custom_certs=false

        command=$base_command

        if [ $PLATFORM == "openshift" ]; then
          command="$command $okd_skip_tls";
        fi

        if [ "$custom_certs" == "true" ]; then
          command="$command --registry-certificate $CONTAINER_REGISTRY_URL=/kaniko/.custom-certs/ca.crt";
        fi

        $command
      securityContext:
        runAsUser: 0
      volumeMounts:
        - name: dockerconfig
          mountPath: /kaniko/.docker
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
    - image: docker.io/alpine:3.18.9
      name: write-url
      env:
        - name: CODEBASE_NAME
          value: "$(params.codebase-name)"
        - name: IMAGE_TAG
          value: "$(params.image-tag)"
        - name: CONTAINER_REGISTRY_URL
          valueFrom:
            configMapKeyRef:
              key: container_registry_host
              name: krci-config
        - name: CONTAINER_REGISTRY_SPACE
          valueFrom:
            configMapKeyRef:
              key: container_registry_space
              name: krci-config
      script: |
        set -e
        echo -n "${CONTAINER_REGISTRY_URL}/${CONTAINER_REGISTRY_SPACE}/${CODEBASE_NAME}:${IMAGE_TAG}" | tee "$(results.IMAGE_URL.path)"
---
# Source: edp-tekton/templates/tasks/maven-get-module.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: get-maven-module
spec:
  description: >-
    This task determines the deployable multi-module directory in a Maven project and outputs its name as a result.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE
      description: "The base image for the task"
      default: "docker.io/alpine:3.18.9"
  results:
    - name: DEPLOYABLE_MODULE_DIR
      description: Maven deployable multimodule directory.
  steps:
    - name: get-maven-module
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      script: |
        set -ex

        DEPLOYABLE_MODULE=$(grep '<deployable.module>' pom.xml | awk -F '[><]' '{print $3}' || true)

        if [ -z "${DEPLOYABLE_MODULE}" ] ; then
            DEPLOYABLE_MODULE_DIR="."
        else
            DEPLOYABLE_MODULE_DIR="${DEPLOYABLE_MODULE}"
        fi

        echo "Deployable module directory: ${DEPLOYABLE_MODULE_DIR}"

        printf "%s" "${DEPLOYABLE_MODULE_DIR}" > "$(results.DEPLOYABLE_MODULE_DIR.path)"
---
# Source: edp-tekton/templates/tasks/maven.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: maven
  labels:
    app.kubernetes.io/based-on: "0.2"
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task runs a Maven build for a specified project, using custom Maven settings and integration with SonarQube and Nexus for quality analysis and artifact management.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  volumes:
    - name: settings-maven
      configMap:
        name: custom-maven-settings
  params:
    - name: MAVEN_IMAGE
      type: string
      description: Maven base image
      default: docker.io/maven:3.9.0-eclipse-temurin-11
    - name: GOALS
      description: maven goals to run
      type: array
      default:
        - "package"
    - name: CONTEXT_DIR
      type: string
      description: >-
        The context directory within the repository for sources on
        which we want to execute maven goals.
      default: "source"
    - name: ci-nexus
      type: string
      description: name of the secret holding the Nexus CI integration data
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
  steps:
    - name: mvn-goals
      image: $(params.MAVEN_IMAGE)
      volumeMounts:
        - name: settings-maven
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.CONTEXT_DIR)
      command: ["/usr/bin/mvn"]
      args:
        - -s
        - /var/configmap/settings.xml
        - "$(params.GOALS)"
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/npm.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: npm
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run npm goals on a project
    where package.json is present and has some pre-defined
    npm scripts.
  workspaces:
    - name: source
  volumes:
    - name: settings-npm
      configMap:
        name: custom-npm-settings
  params:
    - name: PATH_CONTEXT
      type: string
      default: "."
      description: The path where package.json of the project is defined.
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: "docker.io/library/node:22.15.0-alpine3.21"
      description: The node image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
  steps:
    - name: npm
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)

      volumeMounts:
        - name: settings-npm
          mountPath: /var/configmap

      env:
        - name: HOME
          value: "$(workspaces.source.path)"
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      script: |
        #!/usr/bin/env sh
        set -e

        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/opa.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: opa
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task runs OPA tests on a project, generates results in JSON format, and converts them to JUnit XML format for easier integration with other tools.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing opa files
      type: string
      default: "."
    - name: OPA_RESULTS
      type: string
      default: '/workspace/opa_results'
    - name: JUNIT_SCRIPT
      type: string
      default: '/workspace/opa_test_to_junit.py'
    - name: step_download_image
      type: string
      default: "docker.io/alpine/curl:8.12.0"
      description: The opa image.
    - name: step_convert_image
      type: string
      default: "docker.io/python:3.10.8-alpine3.16"
      description: The opa image.
    - name: BASE_IMAGE
      type: string
      default: "docker.io/openpolicyagent/opa:0.45.0-debug"
      description: The opa image.
    - name: EXTRA_COMMANDS
      type: string
  steps:
    - name: opa-results-json
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: OPA_RESULTS
          value: "$(params.OPA_RESULTS)"
      script: |
        #!/busybox/sh
        set -e
        opa test --bundle ./ --format json > "${OPA_RESULTS}"
        cat "${OPA_RESULTS}"
    - image: $(params.step_download_image)
      name: download-converter
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: JUNIT_SCRIPT
          value: "$(params.JUNIT_SCRIPT)"
      script: |
        set -e
        curl -fsSL https://raw.githubusercontent.com/open-policy-agent/contrib/main/junit/opa_test_to_junit.py \
            -o "${JUNIT_SCRIPT}"
        cat "${JUNIT_SCRIPT}"
    - name: convert-to-xml
      image: $(params.step_convert_image)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: OPA_RESULTS
          value: "$(params.OPA_RESULTS)"
        - name: JUNIT_SCRIPT
          value: "$(params.JUNIT_SCRIPT)"
      script: |
        set -e
        $(params.EXTRA_COMMANDS)
---
# Source: edp-tekton/templates/tasks/promote-images.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: promote-images
spec:
  description: "The task promotes images to the next deployment stage."
  params:
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: docker.io/epamedp/tekton-cd-pipeline:0.1.4
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
      type: string
    - name: DEPLOYMENT_FLOW
      description: Deployment Flow name
      type: string
    - name: ENVIRONMENT
      description: Environment name
      type: string
    - name: CBIS_CRD
      description: CodebaseImageStream custom resource definition.
      type: string
      default: "cbis.v2.edp.epam.com"
    - name: STAGE_CRD
      description: Stage custom resource definition.
      type: string
      default: "stages.v2.edp.epam.com"
    - name: CDPIPELINE_CRD
      description: CDPipeline custom resource definition.
      type: string
      default: "cdpipelines.v2.edp.epam.com"

  steps:
    - name: annotate
      image: $(params.BASE_IMAGE)
      env:
        - name: APPLICATIONS_PAYLOAD
          value: "$(params.APPLICATIONS_PAYLOAD)"
        - name: DEPLOYMENT_FLOW
          value: "$(params.DEPLOYMENT_FLOW)"
        - name: ENVIRONMENT
          value: "$(params.ENVIRONMENT)"
        - name: STAGE_CRD
          value: "$(params.STAGE_CRD)"
      script: |
        set -ex
        STAGE_CR="${DEPLOYMENT_FLOW}-${ENVIRONMENT}"
        echo ${APPLICATIONS_PAYLOAD} | jq -r 'to_entries[] |
        "\(.key)=\(.value.imageTag)"' | while IFS= read -r i; do
          kubectl annotate --overwrite "${STAGE_CRD}" "${STAGE_CR}" "app.edp.epam.com/${i}"
        done
    - name: promote-images
      image: $(params.BASE_IMAGE)
      env:
        - name: DEPLOYMENT_FLOW
          value: "$(params.DEPLOYMENT_FLOW)"
        - name: ENVIRONMENT
          value: "$(params.ENVIRONMENT)"
        - name: CDPIPELINE_CRD
          value: "$(params.CDPIPELINE_CRD)"
        - name: CBIS_CRD
          value: "$(params.CBIS_CRD)"
        - name: STAGE_CRD
          value: "$(params.STAGE_CRD)"
      script: |
        set -ex

        APPS_PROMOTE=$(kubectl get "${CDPIPELINE_CRD}" "${DEPLOYMENT_FLOW}" -o jsonpath='{.spec.applicationsToPromote[*]}')
        DATE_FORMAT_RFC3339=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        STAGE_CR="${DEPLOYMENT_FLOW}-${ENVIRONMENT}"

        for APP in ${APPS_PROMOTE}; do
          VERIFIED_SBIS="${STAGE_CR}-${APP}-verified"
          IMAGE_TAG=$(kubectl get "${STAGE_CRD}" "${STAGE_CR}" -o jsonpath="{.metadata.annotations.app\.edp\.epam\.com/${APP}}")

          if [ -n "${IMAGE_TAG}" ]; then
            CBIS_TAG=$(kubectl get "${CBIS_CRD}" "${VERIFIED_SBIS}" -o jsonpath='{.spec.tags[*].name}')
            NEW_CBIS_TAG="{\"name\":\"${IMAGE_TAG}\",\"created\":\"${DATE_FORMAT_RFC3339}\"}"

            if [ -n "${CBIS_TAG}" ] && [ "${CBIS_TAG}" = "$(printf '%s' "${CBIS_TAG}" | sed 's/'"${IMAGE_TAG}"'//g')" ]; then
              echo "[TEKTON][DEBUG] ImageStream ${VERIFIED_SBIS} doesn't contain ${IMAGE_TAG} tag ... it will be added."
              kubectl patch "${CBIS_CRD}" "${VERIFIED_SBIS}" --type json \
                -p "[{\"op\": \"add\", \"path\": \"/spec/tags/-\", \"value\": ${NEW_CBIS_TAG} }]"
            elif [ -z "${CBIS_TAG}" ]; then
              echo "[TEKTON][DEBUG] There're no tags in imageStream ${VERIFIED_SBIS} ... the first one will be added."
              kubectl patch "${CBIS_CRD}" "${VERIFIED_SBIS}" --type=merge \
                -p "{\"spec\":{\"tags\":[${NEW_CBIS_TAG}]}}"
            fi
          fi
        done
---
# Source: edp-tekton/templates/tasks/push-to-jira.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-jira
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/displayName: Push-to-Jira
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The push-to-jira Task will create JiraIssueMetadata Custom Resource

  params:
    - name: TICKET_NAME_PATTERN
      type: string
    - name: COMMIT_MESSAGE
      type: string
    - name: COMMIT_ID
      type: string
    - name: JIRA_ISSUE_METADATA_PAYLOAD
      type: string
    - name: CODEBASE_NAME
      type: string
    - name: VCS_TAG
      type: string
    - name: VERSION
      type: string
    - name: GIT_URL
      description: Repository URL to clone from.
      type: string
    - name: step_push_to_jira_image
      description: "The base image for the task."
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
      type: string
  steps:
    - name: push-to-jira
      image: $(params.step_push_to_jira_image)
      env:
        - name: GIT_URL
          value: $(params.GIT_URL)
        - name: TICKET_NAME_PATTERN
          value: "$(params.TICKET_NAME_PATTERN)"
        - name: COMMIT_MESSAGE
          value: "$(params.COMMIT_MESSAGE)"
        - name: COMMIT_ID
          value: "$(params.COMMIT_ID)"
        - name: JIRA_ISSUE_METADATA_PAYLOAD
          value: "$(params.JIRA_ISSUE_METADATA_PAYLOAD)"
        - name: CODEBASE_NAME
          value: "$(params.CODEBASE_NAME)"
        - name: VCS_TAG
          value: "$(params.VCS_TAG)"
        - name: VERSION
          value: "$(params.VERSION)"
      script: |
        #!/usr/bin/python

        import os
        import sys
        import re
        import json
        from random import randint

        ticket_message_pattern = os.getenv("TICKET_NAME_PATTERN")
        commit_message_with_change_id = os.getenv("COMMIT_MESSAGE")
        commit_id = os.getenv("COMMIT_ID")
        jira_issue_metadata_payload = os.getenv("JIRA_ISSUE_METADATA_PAYLOAD")
        codebase = os.getenv("CODEBASE_NAME")
        vcs_tag = os.getenv("VCS_TAG")
        version = os.getenv("VERSION")
        git_url = os.getenv("GIT_URL")

        print(f"[TEKTON][DEBUG] GIT_URL: {git_url}")
        print(f"[TEKTON][DEBUG] TICKET_NAME_PATTERN: {ticket_message_pattern}")
        print(f"[TEKTON][DEBUG] COMMIT_MESSAGE: \n{commit_message_with_change_id}")
        print(f"[TEKTON][DEBUG] COMMIT_ID: {commit_id}")
        print(f"[TEKTON][DEBUG] JIRA_ISSUE_METADATA_PAYLOAD: {jira_issue_metadata_payload}")
        print(f"[TEKTON][DEBUG] CODEBASE_NAME: {codebase}")
        print(f"[TEKTON][DEBUG] VCS_TAG: {vcs_tag}")
        print(f"[TEKTON][DEBUG] VERSION: {version}")
        print("")

        def convert_ssh_to_https_with_commit(ssh_url, commit_id):
            # Regular expression to extract information from SSH URLs
            match = re.match(r"git@(.*?):(.*?)/(.*?)\.git", ssh_url)
            if match:
                domain, user, repo = match.groups()
                # Use /commits/ for BitBucket, /commit/ for other domains
                commit_path = "commits" if "bitbucket.org" in domain else "commit"
                # Construct the HTTPS address with the commit_id at the end
                https_url = f"https://{domain}/{user}/{repo}/{commit_path}/{commit_id}"
                return https_url
            else:
                # If it doesn't match the SSH pattern, return the original URL
                return ssh_url

        def search_pattern(message, pattern):
            result = re.search(pattern, message)
            if result == None:
                print(f"[TEKTON] Message is invalid. The required pattern is {pattern}")
                sys.exit(1)
            return result.group()

        def set_params_jira_issue_metadata(metadata_name, commits, tickets, codebase, payload):
            print("[TEKTON] Getting JiraIssueMetadata CR template")
            template = {
              "apiVersion": "v2.edp.epam.com/v1",
              "kind": "JiraIssueMetadata",
              "metadata": {
                "name": "replace"
              },
              "spec": {
                "commits": "replace",
                "tickets": "replace",
                "codebaseName": "replace",
                "payload": "replace"
              }
            }
            print("[TEKTON] JiraIssueMetadata template has been fetched:\n{}".format(json.dumps(template, indent = 4)))

            template["metadata"]["name"] = metadata_name
            template["spec"]["commits"] = commits
            template["spec"]["tickets"] = tickets
            template["spec"]["codebaseName"] = codebase
            template["spec"]["payload"] = payload
            print("[TEKTON] JiraIssueMetadata template has been parameterized:\n{}".format(json.dumps(template, indent = 4)))

            return json.dumps(template)

        print(f"[TEKTON] Ticket name pattern has been fetched: {ticket_message_pattern}")
        print(f"[TEKTON] Commit message to validate has been fetched:\n{commit_message_with_change_id}")

        print("[TEKTON] Getting Ticket number and Commit message")
        ticket_number = search_pattern(commit_message_with_change_id, ticket_message_pattern)
        print(f"[TEKTON] Ticket number is {ticket_number}")

        git_commit_url = convert_ssh_to_https_with_commit(git_url, commit_id)
        print(f"[TEKTON] Git Commit URL {git_commit_url}")

        # Use the first line of commit message as a commit message for JiraIssueMetadata CR
        commit_message = commit_message_with_change_id.split("\n")[0]
        print(f"[TEKTON] Commit message was parsed: {commit_message}")

        print("[TEKTON] Preparing Jira Issue Link")
        linkInfo = {
            "ticket": ticket_number,
            "title": f"{commit_message} [{codebase}][{vcs_tag}]",
            "url": git_commit_url
        }
        print("[TEKTON] Issue Link:\n{}".format(json.dumps(linkInfo, indent = 4)))

        values = {
            "EDP_COMPONENT": codebase,
            "EDP_VERSION": version,
            "EDP_SEM_VERSION": re.sub("(-RC|-SNAPSHOT)\.\d+", "", version),
            "EDP_GITTAG": vcs_tag
        }
        print("[TEKTON] KRCI predefined variables:\n{}".format(json.dumps(values, indent = 4)))

        payload = json.loads(jira_issue_metadata_payload)
        print("[TEKTON] JiraIssueMetadataPayload of {0} Codebase CR has been fetched:\n{1}".format(codebase, json.dumps(values, indent = 4)))

        if payload == None:
            payload = { "issuesLinks": [linkInfo] }
        else:
            for x in payload:
                for k in values:
                    payload[x] = payload[x].replace(k, values[k])
            payload["issuesLinks"] = [linkInfo]

        random_seed = ''.join(str(randint(0, 9)) for _ in range(8))
        metadata_name = f"{codebase}-{random_seed}"

        template_json = set_params_jira_issue_metadata(metadata_name, [commit_id], [ticket_number], codebase, json.dumps(payload, indent = 4))

        print("[TEKTON][DEBUG] Applying JiraIssueMetadata CR")
        os.system(f"kubectl apply -f - << EOF\n{template_json}\nEOF")

        print("[TEKTON][DEBUG] JiraIssueMetadata CR has been created")
---
# Source: edp-tekton/templates/tasks/python.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: python
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task can be used to run python goals on a project.
    It utilizes default PIP and Twine environment variables.
    Twine logs in to nexus using environment variables to upload packages.
    PIP does not support username and password environment variables yet.
    Thus, we use the ~/.netrc file for PIP to download packages.
    The ~/.config/pip/pip.conf file can also be used along with ~/.netrc.
  workspaces:
    - name: source
  params:
    - name: PATH_CONTEXT
      type: string
      default: "source"
      description: The path where package.json of the project is defined.
    - name: TWINE_REPOSITORY_URL
      type: string
      default: ""
      description: Nexus Repository URL Twine uploads to.
    - name: TWINE_NON_INTERACTIVE
      type: string
      default: "1"
      description: Do not interactively prompt for credentials if they are missing.
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: "docker.io/python:3.8-slim"
      description: The python image you want to use.
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: PIP_CACHE_DIR
      type: string
      description: Cache directory of the pip
      default: "$(workspaces.source.path)/cache/.cache/pip"
  steps:
    - name: python
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PATH_CONTEXT)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: PIP_CACHE_DIR
          value: $(params.PIP_CACHE_DIR)
        - name: TWINE_REPOSITORY_URL
          value: $(params.TWINE_REPOSITORY_URL)
        - name: TWINE_NON_INTERACTIVE
          value: $(params.TWINE_NON_INTERACTIVE)
        - name: TWINE_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: TWINE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
        - name: PIP_INDEX_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: PIP_INDEX_PATH
              optional: true
        - name: PIP_INDEX_URL_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: PIP_INDEX_URL_PATH
        - name: REPOSITORY_SNAPSHOTS_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: REPOSITORY_SNAPSHOTS_PATH
        - name: REPOSITORY_RELEASES_PATH
          valueFrom:
            configMapKeyRef:
              name: custom-python-settings
              key: REPOSITORY_RELEASES_PATH
      script: |
        #!/usr/bin/env sh
        set -ex
        export PATH=$PATH:$HOME/.local/bin

        # Artifact Storage Repository host PIP connects to via HTTP. e.g. 'nexus'
        export PIP_TRUSTED_HOST=$(echo "${NEXUS_HOST_URL}" | cut -d '/' -f 3 | cut -d ':' -f 1)

        # Concatenate the base URL with the specific paths from the ConfigMap
        export PIP_INDEX="${NEXUS_HOST_URL}${PIP_INDEX_PATH}"
        export PIP_INDEX_URL="${NEXUS_HOST_URL}${PIP_INDEX_URL_PATH}"
        export REPOSITORY_URL_SNAPSHOTS="${NEXUS_HOST_URL}${REPOSITORY_SNAPSHOTS_PATH}"
        export REPOSITORY_URL_RELEASES="${NEXUS_HOST_URL}${REPOSITORY_RELEASES_PATH}"

        echo "[TEKTON][INFO] NEXUS_HOST_URL contains ${NEXUS_HOST_URL}"
        echo "[TEKTON][INFO] PIP_INDEX contains ${PIP_INDEX}"
        echo "[TEKTON][INFO] PIP_INDEX_URL contains ${PIP_INDEX_URL}"
        echo "[TEKTON][INFO] PIP_TRUSTED_HOST contains ${PIP_TRUSTED_HOST}"
        echo "[TEKTON][INFO] REPOSITORY_URL_SNAPSHOTS contains ${REPOSITORY_URL_SNAPSHOTS}"
        echo "[TEKTON][INFO] REPOSITORY_URL_RELEASES contains ${REPOSITORY_URL_RELEASES}"

        netcr_file="$HOME/.netrc"
        if [ ! -f "${netcr_file}" ]; then
          cat <<-EOF > "${netcr_file}"
        machine ${PIP_TRUSTED_HOST}
        login ${TWINE_USERNAME}
        password ${TWINE_PASSWORD}
        EOF
        chmod 0600 "${netcr_file}"
        fi

        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/save-cache.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: save-cache
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/displayName: "save-cache"
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This Task is used to save the cache to the distribution server. It packs and uploads the root of workspace to the distribution server
  workspaces:
    - name: cache
  params:
    - name: CACHE_NAME
      description: "Cache name (filename) to be downloaded from the cache server."
      type: string
    - name: BASE_IMAGE
      description: "Base image"
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
      type: string
  steps:
    - name: save-cache
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.cache.path)

      script: |
        #!/usr/bin/env bash
        set -ex

        curl -o/dev/null -s -f -X POST -F path=test -F file=@/etc/motd  ${CACHE_SERVER_URL}/upload || {
            echo "No cache server found"
            exit 0
        }

        lm="$(curl -fsI ${CACHE_SERVER_URL}/${CACHE_NAME}.tar.zst|sed -n '/Last-Modified/ { s/Last-Modified: //;s/\r//; p}')"
        if [ -n "${lm}" ];then
          expired=$(python -c "import datetime, sys;print(datetime.datetime.now() > datetime.datetime.strptime(sys.argv[1], '%a, %d %b %Y %X %Z') + datetime.timedelta(days=1))" "${lm}")
          if [ "${expired}" = "False" ]; then
              echo "Cache is younger than a day"
              exit
          fi
        fi

        touch ${CACHE_NAME}.tar.zst

        tar c -I"zstd -T1 -1" --exclude=${CACHE_NAME}.tar.zst -f ${CACHE_NAME}.tar.zst .

        curl -# -L -f -F path=${CACHE_NAME}.tar.zst -X POST -F "file=@${CACHE_NAME}.tar.zst" ${CACHE_SERVER_URL}/upload
      env:
        - name: CACHE_SERVER_URL
          valueFrom:
            configMapKeyRef:
              name: tekton-cache
              key: url
              optional: true
        - name: CACHE_NAME
          value: "$(params.CACHE_NAME)"

      computeResources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/security.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: security
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Scan Tools
    tekton.dev/tags: scan-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task scans the source code for security vulnerabilities using Semgrep and reports the results to DefectDojo and Dependency-Track for further analysis and tracking.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE_SEMGREP
      type: string
      description: Semgrep image
      default: docker.io/returntocorp/semgrep:1.109.0
    - name: BASE_IMAGE_GITLEAKS
      type: string
      description: Gitleaks image
      default: docker.io/zricethezav/gitleaks:v8.24.0
    - name: BASE_IMAGE
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
    - name: ci-defectdojo
      type: string
      description: name of the secret holding the DefectDojo CI integration data
      default: ci-defectdojo
    - name: SEMGREP_SCAN_REPORT
      type: string
      default: "semgrep-report.json"
    - name: GITLEAKS_SCAN_REPORT
      type: string
      default: "gitleaks-report.json"
    - name: DD_PRODUCT_NAME
      type: string
      default: ""
    - name: DD_ENGAGEMENT_NAME
      type: string
      default: ""
    - name: PROJECT_NAME
      description: That is the name of the project that will be updated/created on the dependency track side
      default: ''
      type: string
    - name: PROJECT_BRANCH
      description: That is the branch of the project that will be updated/created on the dependency track side
      default: ''
      type: string
    - name: ci-dependency-track
      type: string
      description: Name of the secret holding the ci-dependency-track api token
      default: ci-dependency-track
  results:
    - name: SCAN_REPORT_URL
      description: URL to the scan report in DefectDojo after uploading Trivy and Grype results.
  steps:
    - name: semgrep-scan
      image: $(params.BASE_IMAGE_SEMGREP)
      computeResources: {}
      workingDir: $(workspaces.source.path)
      script: |
        set -e

        # The .docker/config.json file contained sensitive information, so it was added to the semgrep ignorelist.
        echo ".docker/config.json" >> .semgrepignore

        # Create gitleaks.toml file to exclude the .docker directory from scanning
        cat <<EOF > gitleaks.toml
        [extend]
        useDefault = true

        [allowlist]
        paths = [
          '''.docker/'''
        ]
        EOF

        semgrep --jobs 1 --config=auto . --json --output $(params.SEMGREP_SCAN_REPORT) --disable-version-check

      env:
        - name: HOME
          value: "$(workspaces.source.path)"
        - name: SEMGREP_VERSION_CACHE_PATH
          value: "$(workspaces.source.path)/.cache"
    - name: gitleaks-scan
      image: $(params.BASE_IMAGE_GITLEAKS)
      workingDir: $(workspaces.source.path)
      args:
        - "detect"
        - "--source"
        - "."
        - "--report-format=json"
        - "--report-path=$(params.GITLEAKS_SCAN_REPORT)"
        - "--no-git"
        - "--verbose"
        - "--exit-code=0"
        - "--config=gitleaks.toml"
      securityContext:
        runAsUser: 0
    - env:
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: token
              optional: true
        - name: DEPTRACK_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-dependency-track)
              key: url
              optional: true
        - name: PROJECT_NAME
          value: $(params.PROJECT_NAME)
        - name: PROJECT_BRANCH
          value: $(params.PROJECT_BRANCH)
      image: >-
        ghcr.io/cyclonedx/cdxgen:v11.1.10@sha256:f600e2a51c8bf1f50cca8c8dd89e838daca62e2b94b7c6caf14595451f247e7c
      name: cdxgen
      computeResources: {}
      script: >
        #!/usr/bin/env sh

        set -e

        set +x

        /opt/cdxgen/bin/cdxgen.js --api-key=$API_TOKEN --server-url=$DEPTRACK_URL --project-name=$PROJECT_NAME --project-version=$PROJECT_BRANCH --print
      workingDir: $(workspaces.source.path)
    - name: upload-report
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: DD_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: $(params.ci-defectdojo)
              optional: true
        - name: DD_HOST_URL
          valueFrom:
            secretKeyRef:
              key: url
              name: $(params.ci-defectdojo)
              optional: true
      script: |
        #!/usr/bin/env sh
        set -e

        if [ -z "$DD_HOST_URL" ]
        then
          exit 0
        fi

        PRODUCT_ID=$(curl -s -X GET "${DD_HOST_URL}/api/v2/products/?name_exact=$(params.DD_PRODUCT_NAME)" \
          -H "accept: application/json" \
          -H "Authorization: Token ${DD_TOKEN}" \
          | jq -r '.results[0].id')

        for REPORT_NAME in $(params.SEMGREP_SCAN_REPORT) $(params.GITLEAKS_SCAN_REPORT)
        do
            SCAN_TYPE=""
            if [ "$REPORT_NAME" = "$(params.SEMGREP_SCAN_REPORT)" ]; then
                SCAN_TYPE="Semgrep JSON Report"
            elif [ "$REPORT_NAME" = "$(params.GITLEAKS_SCAN_REPORT)" ]; then
                SCAN_TYPE="Gitleaks Scan"
            fi

            curl -X POST "${DD_HOST_URL}/api/v2/reimport-scan/" \
                -H "accept: application/json" \
                -H "Authorization: Token ${DD_TOKEN}" \
                -H "Content-Type: multipart/form-data" \
                -F "scan_date=$(date +%Y-%m-%d)" \
                -F "minimum_severity=Info" \
                -F "active=true" \
                -F "verified=false" \
                -F "scan_type=${SCAN_TYPE}" \
                -F "file=@${REPORT_NAME};type=application/json" \
                -F "product_type_name=Tenant" \
                -F "product_name=$(params.DD_PRODUCT_NAME)" \
                -F "engagement_name=$(params.DD_ENGAGEMENT_NAME)" \
                -F "auto_create_context=true" \
                -F "close_old_findings=true" \
                -F "push_to_jira=false" \
                -F "environment=Development" \
                -F "test_title=security"
        done

        ENGAGEMENT_ID=$(curl -s -X GET "${DD_HOST_URL}/api/v2/engagements/?product=${PRODUCT_ID}&name=$(params.DD_ENGAGEMENT_NAME)" \
          -H "accept: application/json" \
          -H "Authorization: Token ${DD_TOKEN}" \
          | jq -r '.results[0].id')

        SCAN_REPORT_URL="${DD_HOST_URL}/engagement/${ENGAGEMENT_ID}"

        printf "%s" "${SCAN_REPORT_URL}" > "$(results.SCAN_REPORT_URL.path)"
---
# Source: edp-tekton/templates/tasks/send-to-microsoft-teams.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: send-to-microsoft-teams
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  description: >-
    These tasks post a message to a Microsoft Teams Channel.
    This task uses the Incoming Webhook functionality of Microsoft Teams
  params:
  - name: webhook-url-secret
    type: string
    description: Name of the secret with incoming webhook URL
  - name: webhook-url-secret-key
    type: string
    description: Key in the secret
  - name: message
    type: string
    description: The message to notify about
  - name: base_image
    type: string
    description: The image to use as a base for the task
    default: "docker.io/alpine/curl:8.12.0"
  steps:
  - name: post
    image: $(params.base_image)
    script: |
      #!/usr/bin/env sh
      MESSAGE=$(echo "${MESSAGE}" | sed -e 's/\"/\\\\"/g')
      JSON="{\"text\": \"${MESSAGE}\" }"
      curl -X POST -H 'Content-Type: application/json' -d "${JSON}" "${WEBHOOK_URL}"
    env:
    - name: WEBHOOK_URL
      valueFrom:
        secretKeyRef:
          name: $(params.webhook-url-secret)
          key: $(params.webhook-url-secret-key)
    - name: MESSAGE
      value: $(params.message)
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-dotnet.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-dotnet
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: BASE_IMAGE
      description: DotNet base image.
      type: string
      default: "docker.io/epamedp/tekton-dotnet:6.0.3"
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: step_prepare_project_image
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  steps:
    - image: $(params.step_prepare_project_image)
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        # Check if SonarQube is available
        SONAR_STATUS=$(curl -s -I -w "%{http_code}" -o /dev/null ${SONAR_HOST_URL}) || SONAR_STATUS="503"

        if [[ "$SONAR_STATUS" != "200" ]]; then
          echo -e "SonarQube is not available\nPlease check the connection to SonarQube"
          exit 1
        fi

        # Check if project exists
        SONAR_RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}")

        # Check token is valid
        if [[ -z "$SONAR_RESPONSE" ]]; then
          echo "Token isn't valid or not defined"
          exit 1
        fi

        # Create project if it doesn't exist of skip if it does
        if echo "$SONAR_RESPONSE" | jq -e '.errors[0].msg' &>/dev/null; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          if echo "$SONAR_RESPONSE" | jq -e '.component.key' &>/dev/null; then
            echo "Project \"$SONAR_PROJECT_KEY\" already exists"
          else
            echo "Unknown Response format"
          fi
        fi
    - name: sonar-scanner
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
        - name: SONAR_QUALITYGATE_WAIT
          value: "$(params.SONAR_QUALITYGATE_WAIT)"
        - name: TARGET_BRANCH
          value: "$(params.target-branch)"
        - name: SOURCE_BRANCH
          value: "$(params.source-branch)"
        - name: KEY_ID
          value: "$(params.key-id)"
        - name: BRANCH
          value: "$(params.branch)"
      script: |
        #!/usr/bin/env sh
        set -e
        $(params.EXTRA_COMMANDS)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-general.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-general
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: step_prepare_project_image
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  steps:
    - image: $(params.step_prepare_project_image)
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        # Check if SonarQube is available
        SONAR_STATUS=$(curl -s -I -w "%{http_code}" -o /dev/null ${SONAR_HOST_URL}) || SONAR_STATUS="503"

        if [[ "$SONAR_STATUS" != "200" ]]; then
          echo -e "SonarQube is not available\nPlease check the connection to SonarQube"
          exit 1
        fi

        # Check if project exists
        SONAR_RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}")

        # Check token is valid
        if [[ -z "$SONAR_RESPONSE" ]]; then
          echo "Token isn't valid or not defined"
          exit 1
        fi

        # Create project if it doesn't exist of skip if it does
        if echo "$SONAR_RESPONSE" | jq -e '.errors[0].msg' &>/dev/null; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          if echo "$SONAR_RESPONSE" | jq -e '.component.key' &>/dev/null; then
            echo "Project \"$SONAR_PROJECT_KEY\" already exists"
          else
            echo "Unknown Response format"
          fi
        fi
    - image: registry.access.redhat.com/ubi8/ubi-minimal:8.8
      name: prepare-sonar-project-properties
      computeResources: {}
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
        - name: SONAR_QUALITYGATE_WAIT
          value: "$(params.SONAR_QUALITYGATE_WAIT)"
        - name: TARGET_BRANCH
          value: "$(params.target-branch)"
        - name: SOURCE_BRANCH
          value: "$(params.source-branch)"
        - name: KEY_ID
          value: "$(params.key-id)"
        - name: BRANCH
          value: "$(params.branch)"
      script: |
        #!/usr/bin/env bash

        replaceValues() {
          filename=$1
          thekey=$2
          newvalue=$3

          if ! grep -R "^[#]*\s*${thekey}=.*" $filename >/dev/null; then
            echo "APPENDING because '${thekey}' not found"
            echo "" >>$filename
            echo "$thekey=$newvalue" >>$filename
          else
            echo "SETTING because '${thekey}' found already"
            sed -ir "s|^[#]*\s*${thekey}=.*|$thekey=$newvalue|" $filename
          fi
        }

        if [[ -f $(workspaces.source.path)/sonar-project.properties ]]; then
          if [[ -n "${SONAR_HOST_URL}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.host.url ${SONAR_HOST_URL}
          fi
          if [[ -n "${SONAR_PROJECT_KEY}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.projectKey ${SONAR_PROJECT_KEY}
          fi
          if [[ -n "${SONAR_PROJECT_NAME}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.projectName ${SONAR_PROJECT_NAME}
          fi
          if [[ -n "${SONAR_QUALITYGATE_WAIT}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.qualitygate.wait ${SONAR_QUALITYGATE_WAIT}
          fi
          if [[ -n "${BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.branch.name ${BRANCH}
          fi
          if [[ -n "${KEY_ID}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.key ${KEY_ID}
          fi
          if [[ -n "${SOURCE_BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.branch ${SOURCE_BRANCH}
          fi
          if [[ -n "${TARGET_BRANCH}" ]]; then
            replaceValues $(workspaces.source.path)/sonar-project.properties sonar.pullrequest.base ${TARGET_BRANCH}
          fi

        else
          touch sonar-project.properties
          test -z "${SONAR_HOST_URL}" || echo "sonar.host.url=${SONAR_HOST_URL}" >> sonar-project.properties
          test -z "${SONAR_PROJECT_KEY}" || echo "sonar.projectKey=${SONAR_PROJECT_KEY}" >> sonar-project.properties
          test -z "${SONAR_PROJECT_NAME}" || echo "sonar.projectName=${SONAR_PROJECT_NAME}" >> sonar-project.properties
          test -z "${SONAR_QUALITYGATE_WAIT}" || echo "sonar.qualitygate.wait=${SONAR_QUALITYGATE_WAIT}" >> sonar-project.properties
          test -z "${BRANCH}" || echo "sonar.branch.name=${BRANCH}" >> sonar-project.properties
          test -z "${KEY_ID}" || echo "sonar.pullrequest.key=${KEY_ID}" >> sonar-project.properties
          test -z "${SOURCE_BRANCH}" || echo "sonar.pullrequest.branch=${SOURCE_BRANCH}" >> sonar-project.properties
          test -z "${TARGET_BRANCH}" || echo "sonar.pullrequest.base=${TARGET_BRANCH}" >> sonar-project.properties
        fi

        echo "---------------------------"
        cat $(workspaces.source.path)/sonar-project.properties

    - image: docker.io/sonarsource/sonar-scanner-cli:5.0.1
      name: sonar-scanner
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
      command:
        - sonar-scanner
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-gradle.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-gradle
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  volumes:
    - name: settings-gradle
      configMap:
        name: custom-gradle-settings
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: ci-nexus
      type: string
      description: name of the secret for the Nexus integration
      default: ci-nexus
    - name: BASE_IMAGE
      description: Gradle base image.
      type: string
      default: docker.io/gradle:7.6.5-jdk11
    - name: PROJECT_DIR
      description: The directory containing build.gradle
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: step_prepare_project_image
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  steps:
    - image: $(params.step_prepare_project_image)
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        # Check if SonarQube is available
        SONAR_STATUS=$(curl -s -I -w "%{http_code}" -o /dev/null ${SONAR_HOST_URL}) || SONAR_STATUS="503"

        if [[ "$SONAR_STATUS" != "200" ]]; then
          echo -e "SonarQube is not available\nPlease check the connection to SonarQube"
          exit 1
        fi

        # Check if project exists
        SONAR_RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}")

        # Check token is valid
        if [[ -z "$SONAR_RESPONSE" ]]; then
          echo "Token isn't valid or not defined"
          exit 1
        fi

        # Create project if it doesn't exist of skip if it does
        if echo "$SONAR_RESPONSE" | jq -e '.errors[0].msg' &>/dev/null; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          if echo "$SONAR_RESPONSE" | jq -e '.component.key' &>/dev/null; then
            echo "Project \"$SONAR_PROJECT_KEY\" already exists"
          else
            echo "Unknown Response format"
          fi
        fi
    - name: gradle-tasks
      image: $(params.BASE_IMAGE)
      volumeMounts:
        - name: settings-gradle
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        #!/bin/bash
        set -e

        gradle \
          -I \
          /var/configmap/init.gradle \
          -PnexusLogin=${CI_USERNAME} \
          -PnexusPassword=${CI_PASSWORD} \
          $(params.EXTRA_COMMANDS)
      env:
        - name: XDG_CONFIG_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: GRADLE_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_USER_HOME
          value: $(workspaces.source.path)/$(params.PROJECT_DIR)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
        - name: NEXUS_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: url
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/sonar/sonarqube-maven.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sonarqube-maven
  labels:
    app.kubernetes.io/version: "0.2"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: security
    tekton.dev/displayName: "sonarqube scanner"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    The sonarqube-scanner Task will update parameters in the
    sonar-project.properties file or create a new sonar-project.properties
    file and put parameters of a sonar project into it.

    Task will run sonar-scanner for scanning after preparing the sonar-project.properties file.

  workspaces:
    - name: source
  volumes:
    - name: settings-maven
      configMap:
        name: custom-maven-settings
  params:
    - name: SONAR_PROJECT_KEY
      description: Project's unique key
      default: ""
    - name: SONAR_PROJECT_NAME
      description: Project's unique name
      default: ""
    - name: SONAR_QUALITYGATE_WAIT
      description: Forces the analysis step to poll the SonarQube instance and wait for the Quality Gate status.
      default: "true"
    - name: ci-nexus
      type: string
      description: name of the secret holding the Nexus CI integration data
      default: ci-nexus
    - name: ci-sonarqube
      type: string
      description: name of the secret holding the Sonarqube CI integration data
      default: "ci-sonarqube"
    - name: branch
      type: string
      description: Branch of scanning (for build pipeline)
      default: ""
    - name: target-branch
      type: string
      description: Target branch of Merge Request
      default: ""
    - name: source-branch
      type: string
      description: Source branch of Merge Request
      default: ""
    - name: key-id
      type: string
      description: Change number from Merge Request
      default: ""
    - name: CONTEXT_DIR
      type: string
      description: >-
        The context directory within the repository for sources on
        which we want to execute maven goals.
      default: "source"
    - name: MAVEN_IMAGE
      type: string
      description: Maven base image
      default: docker.io/maven:3.9.0-eclipse-temurin-11
    - name: EXTRA_COMMANDS
      description: maven goals to run
      type: array
      default:
        - "package"
    - name: step_prepare_project_image
      type: string
      default: "docker.io/epamedp/tekton-autotest:0.1.8"
  steps:
    - image: $(params.step_prepare_project_image)
      name: prepare-project
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_PROJECT_KEY
          value: "$(params.SONAR_PROJECT_KEY)"
        - name: SONAR_PROJECT_NAME
          value: "$(params.SONAR_PROJECT_NAME)"
      script: |
        set -e

        # Check if SonarQube is available
        SONAR_STATUS=$(curl -s -I -w "%{http_code}" -o /dev/null ${SONAR_HOST_URL}) || SONAR_STATUS="503"

        if [[ "$SONAR_STATUS" != "200" ]]; then
          echo -e "SonarQube is not available\nPlease check the connection to SonarQube"
          exit 1
        fi

        # Check if project exists
        SONAR_RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/components/show?component=${SONAR_PROJECT_KEY}")

        # Check token is valid
        if [[ -z "$SONAR_RESPONSE" ]]; then
          echo "Token isn't valid or not defined"
          exit 1
        fi

        # Create project if it doesn't exist of skip if it does
        if echo "$SONAR_RESPONSE" | jq -e '.errors[0].msg' &>/dev/null; then
          default_branch=$(kubectl get codebase $SONAR_PROJECT_NAME -o jsonpath='{.spec.defaultBranch}')
          echo "Create project ${SONAR_PROJECT_KEY}"
          curl -X POST -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/projects/create?name=${SONAR_PROJECT_KEY}&project=${SONAR_PROJECT_KEY}&mainBranch=${default_branch}"
        else
          if echo "$SONAR_RESPONSE" | jq -e '.component.key' &>/dev/null; then
            echo "Project \"$SONAR_PROJECT_KEY\" already exists"
          else
            echo "Unknown Response format"
          fi
        fi
    - name: mvn-goals
      image: $(params.MAVEN_IMAGE)
      volumeMounts:
        - name: settings-maven
          mountPath: /var/configmap
      workingDir: $(workspaces.source.path)/$(params.CONTEXT_DIR)
      command: ["/usr/bin/mvn"]
      args:
        - -s
        - /var/configmap/settings.xml
        - "$(params.EXTRA_COMMANDS)"
      env:
        - name: HOME
          value: $(workspaces.source.path)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: token
        - name: SONAR_HOST_URL
          valueFrom:
            secretKeyRef:
              name: $(params.ci-sonarqube)
              key: url
        - name: CI_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: username
        - name: CI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.ci-nexus)
              key: password
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/terraform-check.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: terraform-check
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task performs checks on Terraform files in a specified project directory, allowing for additional custom commands to be executed as part of the check process.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing terraform files
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: docker.io/epamedp/tekton-pre-commit:0.1.7
      description: The terraform-check image.
  steps:
    - name: terraform
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      securityContext:
        runAsUser: 0
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/terraform.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: terraform
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Build Tools
    tekton.dev/tags: build-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task executes Terraform commands in a specified project directory, allowing for custom operations on Terraform files using a specified version of Terraform.
  workspaces:
    - name: source
  params:
    - name: PROJECT_DIR
      description: The directory containing terraform files
      type: string
      default: "."
    - name: EXTRA_COMMANDS
      type: string
    - name: BASE_IMAGE
      type: string
      default: docker.io/epamedp/tekton-tfenv:0.1.4
      description: The tfenv image.
    - name: TFENV_TERRAFORM_VERSION
      type: string
      default: "latest"
      description: Terraform version
  steps:
    - name: terraform
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)/$(params.PROJECT_DIR)
      script: |
        set -ex
        $(params.EXTRA_COMMANDS)
      env:
        - name: TFENV_CONFIG_DIR
          value: /tekton/home
        - name: TFENV_TERRAFORM_VERSION
          value: $(params.TFENV_TERRAFORM_VERSION)
      
      computeResources:
        limits:
          cpu: "2"
          memory: 3Gi
        requests:
          cpu: 500m
          memory: 1Gi
---
# Source: edp-tekton/templates/tasks/trivy-scan.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: trivy-scan
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Scan Tools
    tekton.dev/tags: scan-tool
    tekton.dev/platforms: "linux/amd64,linux/s390x,linux/ppc64le"
spec:
  description: >-
    This task scans a container image for vulnerabilities using Trivy.
    It targets high and critical severity issues to ensure secure image deployment.
    The task is customizable with parameters for the Trivy base image and the target image to scan.
  workspaces:
    - name: source
      description: The workspace consisting of maven project.
  params:
    - name: BASE_IMAGE
      type: string
      description: Semgrep image
      default: "docker.io/aquasec/trivy:0.41.0"
    - name: targetImage
      type: string
      default: ""
  steps:
    - name: trivy
      image: $(params.BASE_IMAGE)
      workingDir: $(workspaces.source.path)
      env:
        - name: TARGET_IMAGE
          value: $(params.targetImage)
      script: |
        #!/usr/bin/env sh
        set -e

        trivy image --scanners vuln --severity HIGH,CRITICAL "${TARGET_IMAGE}"
---
# Source: edp-tekton/templates/tasks/update-cbb.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-cbb
spec:
  description: >-
    This task updates the status of a CodebaseBranch (CBB) with a new build number.
    It uses kubectl commands to patch the CBB resource with the provided build number, ensuring the branch's status reflects the latest successful build.
    The task allows customization through parameters for the branch name, build number, and base image.
  params:
    - name: CODEBASEBRANCH_NAME
      type: string
      description: "Codebase branch name with only letters and dashes"
    - name: CURRENT_BUILD_NUMBER
      type: string
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: docker.io/bitnamilegacy/kubectl:1.25.4
  steps:
    - name: update-cbb-status
      image: $(params.BASE_IMAGE)
      env:
        - name: CBB_NAME
          value: "$(params.CODEBASEBRANCH_NAME)"
        - name: CURRENT_BUILD_NUMBER
          value: "$(params.CURRENT_BUILD_NUMBER)"
      script: |
        #!/usr/bin/env bash
        set -ex

        kubectl patch codebasebranches.v2.edp.epam.com ${CBB_NAME} \
        --subresource=status \
        --type=merge \
        -p "{\"status\": {\"lastSuccessfulBuild\": \"${CURRENT_BUILD_NUMBER}\"}}"
---
# Source: edp-tekton/templates/tasks/update-cbis.yaml
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-cbis
spec:
  description: >-
    This task updates a Codebase ImageStream (CBIS) with a new image tag. It checks for the presence of tags in the specified CBIS and adds the new tag if it doesn't already exist.
    The task utilizes kubectl commands and is customizable with parameters for CBIS
  params:
    - name: CODEBASEBRANCH_NAME
      type: string
      description: "CodebaseBranch name with only letters and dashes"
    - name: IMAGE_TAG
      type: string
    - name: BASE_IMAGE
      description: The base image for the task.
      type: string
      default: docker.io/bitnamilegacy/kubectl:1.25.4
  steps:
    - name: update-cbis
      image: $(params.BASE_IMAGE)
      env:
        - name: CODEBASEBRANCH_NAME
          value: "$(params.CODEBASEBRANCH_NAME)"
        - name: IMAGE_TAG
          value: "$(params.IMAGE_TAG)"
      script: |
        #!/usr/bin/env bash
        set -e

        cbisName=$(kubectl get cbis.v2.edp.epam.com -l app.edp.epam.com/codebasebranch="${CODEBASEBRANCH_NAME}" -o jsonpath='{.items[0].metadata.name}')
        if [ -z "${cbisName}" ]; then
            echo "[TEKTON][ERROR] No CBIS found with label app.edp.epam.com/codebasebranch=${CODEBASEBRANCH_NAME}"
            exit 1
        fi

        cbisCrTags=$(kubectl get cbis.v2.edp.epam.com ${cbisName} --output=jsonpath={.spec.tags})
        dateFormat=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        newcbisTag="{\"name\":\"${IMAGE_TAG}\",\"created\":\"${dateFormat}\"}"

        if [ "${cbisCrTags}" = "" ] ; then
            echo "[TEKTON][DEBUG] There're no tags in imageStream ${cbisName} ... the first one will be added."
            kubectl patch cbis.v2.edp.epam.com ${cbisName} --type=merge -p "{\"spec\":{\"tags\":[${newcbisTag}]}}"
        fi

        cbisTagsList=$(kubectl get cbis.v2.edp.epam.com ${cbisName} --output=jsonpath={.spec.tags[*].name})
        if [[ ! ${cbisTagsList} == *"${IMAGE_TAG}"* ]]; then
            echo "[TEKTON][DEBUG] ImageStream ${cbisName} doesn't contain ${IMAGE_TAG} tag ... it will be added."
            kubectl patch cbis.v2.edp.epam.com ${cbisName} --type json -p="[{\"op\": \"add\", \"path\": \"/spec/tags/-\", \"value\": ${newcbisTag} }]"
        fi
---
# Source: edp-tekton/templates/triggers/gitlab/trigger-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gitlab-build
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "gitlab"
      params:
        - name: "secretRef"
          value:
            secretName: ci-gitlab
            secretKey: secretString
        - name: "eventTypes"
          value: ["Merge Request Hook"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.object_attributes.action in ['merge']"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
  bindings:
    - ref: gitlab-binding-build
  template:
    ref: gitlab-build-template
---
# Source: edp-tekton/templates/triggers/gitlab/trigger-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: gitlab-review
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  interceptors:
    - ref:
        name: "gitlab"
      params:
        - name: "secretRef"
          value:
            secretName: ci-gitlab
            secretKey: secretString
        - name: "eventTypes"
          value: ["Merge Request Hook", "Note Hook"]
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "body.object_attributes.action in ['open', 'reopen', 'update'] && !(has(body.changes.assignees) || has(body.changes.reviewers)) || (body.object_kind == 'note' && has(body.merge_request))"
    - ref:
        name: "edp"
        kind: NamespacedInterceptor
  bindings:
    - ref: gitlab-binding-review
  template:
    ref: gitlab-review-template
---
# Source: edp-tekton/templates/triggers/gitlab/triggerbinding-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gitlab-binding-build
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: $(body.object_attributes.merge_commit_sha)
    - name: gitrepositoryurl
      value: $(body.project.git_ssh_url)
    - name: gitrepositoryname
      value: $(body.project.name)
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
    - name: gitfullrepositoryname
      value: $(body.object_attributes.target.path_with_namespace)
    - name: changeNumber
      value: "$(extensions.pullRequest.changeNumber)"
    # commitMessage is used for 'push-to-jira' Task
    - name: commitMessage
      value: "$(body.object_attributes.title)"
    # commitMessagePattern is used for 'commit-validate' Tasks
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    # jiraIssueMetadataPayload is used for 'push-to-jira' Task
    - name: jiraIssueMetadataPayload
      value: "$(extensions.spec.jiraIssueMetadataPayload)"
    # ticketNamePattern is used for 'push-to-jira' Task
    - name: ticketNamePattern
      value: "$(extensions.spec.ticketNamePattern)"
    # jiraServer is used for 'push-to-jira' Task
    - name: jiraServer
      value: "$(extensions.spec.jiraServer)"
    # get the pipeline name from the codebasebranch spec
    - name: pipelineName
      value: $(extensions.pipelines.build)
---
# Source: edp-tekton/templates/triggers/gitlab/triggerbinding-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: gitlab-binding-review
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
      value: "$(extensions.pullRequest.headSha)"
    - name: gitrepositoryurl
      value: $(body.project.git_ssh_url)
    - name: gitrepositoryname
      value: $(body.project.name)
    - name: gitfullrepositoryname
      value: $(body.project.path_with_namespace)
    - name: targetBranch
      value: "$(extensions.targetBranch)"
    - name: changeNumber
      value: "$(extensions.pullRequest.changeNumber)"
    - name: commitMessagePattern
      value: "$(extensions.spec.commitMessagePattern)"
    - name: commitMessage
      value: "$(extensions.pullRequest.lastCommitMessage)"
    - name: codebase
      value: "$(extensions.codebase)"
    - name: codebasebranch
      value: "$(extensions.codebasebranch)"
    # get the pipeline name from the codebasebranch spec
    - name: pipelineName
      value: $(extensions.pipelines.review)
---
# Source: edp-tekton/templates/triggers/cd/clean.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: clean
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: clean
spec:
  params:
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: clean-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: clean
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: clean
        params:
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
---
# Source: edp-tekton/templates/triggers/cd/deploy-ansible-awx.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-ansible-awx
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy-ansible-awx
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
---
# Source: edp-tekton/templates/triggers/cd/deploy-ansible.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-ansible
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy-ansible
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
        workspaces:
          - name: git-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: "1Gi"
          - name: ssh-workspace
            secret:
              secretName: ssh-key-secret
---
# Source: edp-tekton/templates/triggers/cd/deploy-diff-approve.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-diff-approve
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-diff-approve-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy-diff-approve
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
---
# Source: edp-tekton/templates/triggers/cd/deploy-with-approve.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-with-approve
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-with-approve-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy-with-promote-approval
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
---
# Source: edp-tekton/templates/triggers/cd/deploy-with-autotests.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy-with-autotests
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-auto-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy-with-autotests
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: "1Gi"
            subPath: codebase
---
# Source: edp-tekton/templates/triggers/cd/deploy.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: deploy
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
    app.edp.epam.com/pipelinetype: deploy
spec:
  params:
    - name: CDPIPELINE
      description: |
        KRCI kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDSTAGE
      description: |
        KRCI kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: {"codebase1": {"imageTag": "version1", "customValues": true}, "codebase2": {"imageTag": "version2", "customValues": true}}. For example: {"demo": {"imageTag": "main-20240103-141431", "customValues": true}, "myapp": {"imageTag": "0.1.0-SNAPSHOT.1", "customValues": true}}
    - name: KUBECONFIG_SECRET_NAME
      description: The name of secret with Kubeconfig to connect to the remote cluster
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE)-$(tt.params.CDSTAGE)
          app.edp.epam.com/pipelinetype: deploy
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: deploy
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDSTAGE
            value: $(tt.params.CDSTAGE)
          - name: CDPIPELINE
            value: $(tt.params.CDPIPELINE)
          - name: KUBECONFIG_SECRET_NAME
            value: $(tt.params.KUBECONFIG_SECRET_NAME)
        timeouts:
          pipeline: 1h00m0s
---
# Source: edp-tekton/templates/triggers/gitlab/tt-autotests.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: gitlab-run-autotests
spec:
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
        generateName: run-autotests-
        labels:
          app.edp.epam.com/pipelinetype: tests
      spec:
        params:
          - name: git-source-url
            value: "git@gitlab.com:<org-or-account-name>/autotests.git"
          - name: git-source-revision
            value: "main"
          - name: makefile-target
            value: "dev"
          - name: base-image
            value: "maven:3.9.9-eclipse-temurin-21"
        pipelineRef:
          name: gitlab-run-autotests
        taskRunTemplate:
          serviceAccountName: tekton
        workspaces:
          - name: shared-workspace
            subPath: codebase
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
---
# Source: edp-tekton/templates/triggers/gitlab/tt-build.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gitlab-build-template
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: gitfullrepositoryname
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: ticketNamePattern
      description: Ticket name pattern
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
    - name: changeNumber
      description: Change number from Merge Request
    - name: jiraIssueMetadataPayload
      description: Jira issue payload
    - name: jiraServer
      description: Jira server name
    - name: pipelineName
      description: Pipeline to trigger. Populated by krci interceptor from codebasebranch spec
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: build-$(tt.params.codebasebranch)-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: build
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: $(tt.params.pipelineName)
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: gitfullrepositoryname
            value: $(tt.params.gitfullrepositoryname)
          - name: TICKET_NAME_PATTERN
            value: $(tt.params.ticketNamePattern)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
          - name: JIRA_ISSUE_METADATA_PAYLOAD
            value: $(tt.params.jiraIssueMetadataPayload)
          - name: JIRA_SERVER
            value: $(tt.params.jiraServer)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
---
# Source: edp-tekton/templates/triggers/gitlab/tt-review.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gitlab-review-template
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: gitrepositoryname
    - name: gitfullrepositoryname
      description: Full Repo name. Used in "gitlab-set-status" step as REPO_PATH_ONLY
    - name: targetBranch
      description: Target branch of Merge Request
    - name: changeNumber
      description: Change number from Merge Request
    - name: codebase
      description: Codebase name used in pipeline
    - name: codebasebranch
      description: Codebasebranch name used in pipeline
    - name: commitMessagePattern
      description: Commit message pattern to run commit-validate task
    - name: commitMessage
      description: Commit message
    - name: pipelineName
      description: Pipeline to trigger. Populated by krci interceptor from codebasebranch spec
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: review-$(tt.params.codebasebranch)-
        labels:
          # used by UI to sort pipelines for codebasebranches
          app.edp.epam.com/codebasebranch: $(tt.params.codebasebranch)
          app.edp.epam.com/codebase: $(tt.params.codebase)
          app.edp.epam.com/pipelinetype: review
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: $(tt.params.pipelineName)
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
          - name: CODEBASEBRANCH_NAME
            value: $(tt.params.codebasebranch)
          - name: targetBranch
            value: $(tt.params.targetBranch)
          - name: changeNumber
            value: $(tt.params.changeNumber)
          - name: gitfullrepositoryname
            value: $(tt.params.gitfullrepositoryname)
          - name: COMMIT_MESSAGE_PATTERN
            value: $(tt.params.commitMessagePattern)
          - name: COMMIT_MESSAGE
            value: $(tt.params.commitMessage)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
---
# Source: edp-tekton/templates/triggers/gitlab/tt-security.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: gitlab-security-template
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
spec:
  params:
    - name: gitrevision
    - name: codebase
    - name: gitrepositoryurl
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: gitlab-security-scan-
        labels:
          app.edp.epam.com/pipelinetype: security
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
          
        pipelineRef:
          name: gitlab-security-scan
        params:
          - name: git-source-url
            value: $(tt.params.gitrepositoryurl)
          - name: git-source-revision
            value: $(tt.params.gitrevision)
          - name: CODEBASE_NAME
            value: $(tt.params.codebase)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
            subPath: codebase
          - name: ssh-creds
            secret:
              secretName: ci-gitlab
---
# Source: edp-tekton/templates/triggers/security/tt-image-scan-remote.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  labels:
    helm.sh/chart: edp-tekton-0.19.0-SNAPSHOT
    app.kubernetes.io/version: "0.19.0-SNAPSHOT"
    app.kubernetes.io/managed-by: Helm
  name: image-scan-remote
spec:
  params:
    - name: IMAGE_NAMES
      description: Array of container images to scan.
    - name: COMPONENT_NAME
      description: Name of the component to which the images belong. Pipeline will use this name to create/update the appropriate Engagement with scan reports in DefectDojo.
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
        generateName: image-scan-remote-
        labels:
          app.edp.epam.com/pipelinetype: security
      spec:
        params:
          - name: IMAGE_NAMES
            value:
              - docker.io/busybox:1.37.0
          - name: COMPONENT_NAME
            value: busybox
        pipelineRef:
          name: image-scan-remote
        taskRunTemplate:
          serviceAccountName: tekton
        workspaces:
          - name: shared-workspace
            subPath: codebase
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 5Gi
